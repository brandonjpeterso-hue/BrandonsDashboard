<!DOCTYPE html>

<html lang="en" style="color-scheme: dark; background: #060a0d;">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="dark">
<title>OPS INTELLIGENCE — Energy & Regulatory Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@300;400;600;700;900&family=Barlow:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
  /* ===== FORCE DARK MODE — override system preference ===== */
  html, body {
    color-scheme: dark !important;
    background-color: #060a0d !important;
  }
  @media (prefers-color-scheme: light) {
    html { filter: none !important; }
    body { background: #060a0d !important; color: #ffffff !important; }
  }

:root {
–bg-primary: #060a0d;
–bg-secondary: #0b1015;
–bg-card: #0f1720;
–bg-card-hover: #141e2a;
–border: #1e3348;
–border-bright: #2d4d6e;
–accent: #60c8f5;
–accent-dim: #2d8bbf;
–accent-glow: rgba(96,200,245,0.15);
–caution: #f59e0b;
–caution-dim: #b45309;
–green: #2edb6e;
–green-dim: #17914a;
–red: #f25555;
–red-dim: #b02020;
–blue: #60c8f5;
–blue-dim: #2d8bbf;
–text-primary: #ffffff;
–text-secondary: #c2d4e8;
–text-dim: #6b8aaa;
–mono: ‘Share Tech Mono’, monospace;
–display: ‘Barlow Condensed’, sans-serif;
–body: ‘Barlow’, sans-serif;
}

- { margin: 0; padding: 0; box-sizing: border-box; }

body {
background: var(–bg-primary);
color: var(–text-primary);
font-family: var(–body);
font-size: 17px;
min-height: 100vh;
overflow-x: hidden;
}

/* Scanline overlay */
body::before {
content: ‘’;
position: fixed;
inset: 0;
background: repeating-linear-gradient(
0deg,
transparent,
transparent 2px,
rgba(0,0,0,0.03) 2px,
rgba(0,0,0,0.03) 4px
);
pointer-events: none;
z-index: 1000;
}

/* Grid noise texture */
body::after {
content: ‘’;
position: fixed;
inset: 0;
background-image: url(“data:image/svg+xml,%3Csvg viewBox=‘0 0 200 200’ xmlns=‘http://www.w3.org/2000/svg’%3E%3Cfilter id=‘n’%3E%3CfeTurbulence type=‘fractalNoise’ baseFrequency=‘0.65’ numOctaves=‘3’ stitchTiles=‘stitch’/%3E%3C/filter%3E%3Crect width=‘100%25’ height=‘100%25’ filter=‘url(%23n)’ opacity=‘0.03’/%3E%3C/svg%3E”);
opacity: 0.4;
pointer-events: none;
z-index: 999;
}

/* –– HEADER –– */
header {
display: flex;
align-items: center;
justify-content: space-between;
padding: 18px 32px;
border-bottom: 2px solid var(–accent);
background: linear-gradient(180deg, rgba(96,200,245,0.12) 0%, rgba(6,10,13,0.98) 100%);
position: sticky;
top: 0;
z-index: 100;
backdrop-filter: blur(12px);
box-shadow: 0 4px 32px rgba(96,200,245,0.08);
}

.logo-block {
display: flex;
align-items: center;
gap: 16px;
}

.logo-icon {
width: 36px;
height: 36px;
border: 2px solid var(–accent);
display: grid;
grid-template-columns: 1fr 1fr;
gap: 3px;
padding: 4px;
animation: pulse-border 3s ease-in-out infinite;
}

.logo-icon span {
background: var(–accent);
display: block;
}
.logo-icon span:nth-child(2) { background: var(–accent-dim); }
.logo-icon span:nth-child(3) { background: var(–accent-dim); }

@keyframes pulse-border {
0%, 100% { box-shadow: 0 0 8px var(–accent-glow); }
50% { box-shadow: 0 0 20px rgba(245,158,11,0.35); }
}

.logo-text {
font-family: var(–display);
font-weight: 900;
font-size: 30px;
letter-spacing: 4px;
text-transform: uppercase;
color: var(–text-primary);
line-height: 1.1;
}

.logo-sub {
font-family: var(–mono);
font-size: 13px;
color: var(–accent);
letter-spacing: 3px;
text-transform: uppercase;
opacity: 0.85;
}

.header-right {
display: flex;
align-items: center;
gap: 28px;
}

.live-indicator {
display: flex;
align-items: center;
gap: 8px;
font-family: var(–mono);
font-size: 15px;
color: var(–green);
letter-spacing: 3px;
font-weight: bold;
}

.live-dot {
width: 11px;
height: 11px;
background: var(–green);
border-radius: 50%;
animation: blink 1.5s ease-in-out infinite;
box-shadow: 0 0 10px var(–green);
}

@keyframes blink {
0%, 100% { opacity: 1; }
50% { opacity: 0.2; }
}

#clock {
font-family: var(–mono);
letter-spacing: 2px;
}

.states-badge {
font-family: var(–mono);
font-size: 13px;
color: var(–accent);
border: 1px solid var(–accent);
padding: 6px 14px;
letter-spacing: 1px;
background: rgba(96,200,245,0.07);
white-space: nowrap;
}

/* –– NAV TABS –– */
nav {
display: flex;
gap: 0;
border-bottom: 1px solid var(–border);
padding: 0 32px;
background: var(–bg-secondary);
}

.tab {
font-family: var(–display);
font-weight: 600;
font-size: 17px;
letter-spacing: 2px;
text-transform: uppercase;
color: var(–text-dim);
padding: 14px 26px;
cursor: pointer;
border-bottom: 2px solid transparent;
transition: all 0.2s;
background: none;
border-top: none;
border-left: none;
border-right: none;
white-space: nowrap;
}

.tab:hover { color: var(–text-secondary); }
.tab.active {
color: var(–accent);
border-bottom-color: var(–accent);
}

/* –– MAIN LAYOUT –– */
main {
padding: 24px 32px;
max-width: 1600px;
margin: 0 auto;
}

.section { display: none; }
.section.active { display: block; }

/* –– STATUS BAR –– */
.status-bar {
display: flex;
gap: 12px;
margin-bottom: 24px;
flex-wrap: wrap;
}

.status-pill {
font-family: var(–mono);
font-size: 15px;
letter-spacing: 1.5px;
padding: 7px 16px;
border: 1px solid var(–border-bright);
color: var(–text-secondary);
display: flex;
align-items: center;
gap: 8px;
}

.status-pill .dot {
width: 8px;
height: 8px;
border-radius: 50%;
background: var(–green);
}

.status-pill .dot.warn { background: var(–caution); }
.status-pill .dot.off { background: var(–text-dim); }

/* –– GRID SYSTEMS –– */
.grid-4 {
display: grid;
grid-template-columns: repeat(4, 1fr);
gap: 16px;
margin-bottom: 24px;
}

.grid-3 {
display: grid;
grid-template-columns: repeat(3, 1fr);
gap: 16px;
margin-bottom: 24px;
}

.grid-2 {
display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 16px;
margin-bottom: 24px;
}

.grid-2-1 {
display: grid;
grid-template-columns: 2fr 1fr;
gap: 16px;
margin-bottom: 24px;
}

.col-span-2 { grid-column: span 2; }
.col-span-3 { grid-column: span 3; }
.col-span-4 { grid-column: span 4; }

/* –– CARDS –– */
.card {
background: var(–bg-card);
border: 1px solid var(–border);
padding: 20px;
position: relative;
overflow: hidden;
transition: border-color 0.2s, background 0.2s;
}

.card::before {
content: ‘’;
position: absolute;
top: 0;
left: 0;
right: 0;
height: 2px;
background: linear-gradient(90deg, transparent, var(–accent-dim), transparent);
opacity: 0.5;
}

.card:hover {
border-color: var(–border-bright);
background: var(–bg-card-hover);
}

.card-label {
font-family: var(–mono);
font-size: 14px;
letter-spacing: 3px;
text-transform: uppercase;
color: var(–text-secondary);
margin-bottom: 12px;
display: flex;
align-items: center;
justify-content: space-between;
}

.card-label .unit {
color: var(–accent);
font-size: 13px;
}

.card-value {
font-family: var(–display);
font-size: 55px;
font-weight: 700;
line-height: 1;
color: var(–text-primary);
margin-bottom: 8px;
}

.card-value.large { font-size: 67px; }
.card-value.small { font-size: 39px; }

.card-sub {
font-family: var(–mono);
font-size: 15px;
color: var(–text-secondary);
letter-spacing: 1px;
}

.card-delta {
font-family: var(–mono);
font-size: 15px;
margin-top: 6px;
}

.card-delta.up { color: var(–red); }
.card-delta.down { color: var(–green); }
.card-delta.neutral { color: var(–text-dim); }

/* –– SECTION HEADER –– */
.section-header {
display: flex;
align-items: baseline;
gap: 16px;
margin-bottom: 20px;
padding-bottom: 12px;
border-bottom: 1px solid var(–border);
}

.section-title {
font-family: var(–display);
font-weight: 900;
font-size: 37px;
letter-spacing: 3px;
text-transform: uppercase;
color: var(–text-primary);
}

.section-title span { color: var(–accent); }

.section-meta {
font-family: var(–mono);
font-size: 14px;
color: var(–text-dim);
letter-spacing: 2px;
}

.refresh-btn {
margin-left: auto;
background: none;
border: 1px solid var(–border-bright);
color: var(–text-secondary);
font-family: var(–mono);
font-size: 14px;
letter-spacing: 2px;
padding: 8px 16px;
cursor: pointer;
transition: all 0.2s;
text-transform: uppercase;
}

.refresh-btn:hover {
border-color: var(–accent);
color: var(–accent);
}

/* –– CHART CARDS –– */
.chart-card {
background: var(–bg-card);
border: 1px solid var(–border);
padding: 20px;
position: relative;
}

.chart-card::before {
content: ‘’;
position: absolute;
top: 0; left: 0; right: 0;
height: 2px;
background: linear-gradient(90deg, transparent, var(–accent-dim), transparent);
opacity: 0.5;
}

.chart-title {
font-family: var(–display);
font-weight: 700;
font-size: 23px;
letter-spacing: 2px;
text-transform: uppercase;
color: var(–text-primary);
margin-bottom: 4px;
}

.chart-subtitle {
font-family: var(–mono);
font-size: 14px;
color: var(–text-secondary);
letter-spacing: 1.5px;
margin-bottom: 18px;
}

/* –– STATE TABLE –– */
.state-table {
width: 100%;
border-collapse: collapse;
font-family: var(–mono);
font-size: 16px;
}

.state-table th {
font-family: var(–display);
font-weight: 600;
font-size: 15px;
letter-spacing: 2px;
text-transform: uppercase;
color: var(–text-secondary);
text-align: left;
padding: 10px 16px;
border-bottom: 1px solid var(–border-bright);
}

.state-table td {
padding: 13px 16px;
border-bottom: 1px solid rgba(30,51,72,0.6);
color: var(–text-secondary);
transition: background 0.15s;
}

.state-table tr:hover td { background: rgba(96,200,245,0.04); }

.state-table .state-name {
color: var(–text-primary);
font-family: var(–display);
font-weight: 600;
font-size: 18px;
letter-spacing: 1px;
}

.state-table .val-highlight {
color: var(–accent);
font-weight: bold;
}

.state-table .val-high { color: var(–red); }
.state-table .val-low { color: var(–green); }

.bar-cell {
display: flex;
align-items: center;
gap: 8px;
}

.mini-bar {
height: 6px;
background: var(–border);
flex: 1;
max-width: 80px;
position: relative;
overflow: hidden;
}

.mini-bar-fill {
height: 100%;
background: var(–accent);
transition: width 1s ease;
}

.mini-bar-fill.high { background: var(–red); }
.mini-bar-fill.low { background: var(–green); }
.mini-bar-fill.med { background: var(–blue); }

/* –– GRID STATUS CARDS –– */
.grid-status-card {
background: var(–bg-card);
border: 1px solid var(–border);
padding: 16px;
display: flex;
flex-direction: column;
gap: 10px;
}

.grid-region-name {
font-family: var(–display);
font-weight: 700;
font-size: 25px;
letter-spacing: 2px;
text-transform: uppercase;
}

.grid-states-covered {
font-family: var(–mono);
font-size: 14px;
color: var(–text-secondary);
letter-spacing: 1px;
}

.grid-load-bar {
height: 8px;
background: var(–border);
position: relative;
overflow: hidden;
}

.grid-load-fill {
height: 100%;
transition: width 1.5s ease;
position: relative;
}

.grid-load-fill::after {
content: ‘’;
position: absolute;
right: 0;
top: -2px;
bottom: -2px;
width: 3px;
background: white;
opacity: 0.8;
box-shadow: 0 0 6px white;
}

.grid-load-fill.normal { background: linear-gradient(90deg, #17914a, #2edb6e); }
.grid-load-fill.elevated { background: linear-gradient(90deg, #b45309, #f59e0b); }
.grid-load-fill.high { background: linear-gradient(90deg, #b02020, #f25555); }

.grid-metrics {
display: flex;
justify-content: space-between;
font-family: var(–mono);
font-size: 15px;
color: var(–text-secondary);
}

.grid-metrics .metric-val {
color: var(–text-primary);
font-size: 20px;
display: block;
}

.grid-link {
font-family: var(–mono);
font-size: 14px;
color: var(–accent);
text-decoration: none;
letter-spacing: 1.5px;
border: 1px solid var(–accent-dim);
padding: 7px 14px;
display: inline-block;
transition: all 0.2s;
text-transform: uppercase;
}

.grid-link:hover {
background: var(–accent-glow);
border-color: var(–accent);
}

/* –– NEWS CARDS –– */
.news-grid {
display: grid;
grid-template-columns: repeat(3, 1fr);
gap: 16px;
}

.news-card {
background: var(–bg-card);
border: 1px solid var(–border);
padding: 16px;
display: flex;
flex-direction: column;
gap: 10px;
transition: all 0.2s;
text-decoration: none;
color: inherit;
position: relative;
overflow: hidden;
}

.news-card::after {
content: ‘’;
position: absolute;
bottom: 0;
left: 0;
right: 0;
height: 1px;
background: linear-gradient(90deg, transparent, var(–accent-dim), transparent);
transform: scaleX(0);
transition: transform 0.3s;
}

.news-card:hover {
border-color: var(–border-bright);
background: var(–bg-card-hover);
}

.news-card:hover::after { transform: scaleX(1); }

.news-source {
font-family: var(–mono);
font-size: 13px;
letter-spacing: 2px;
text-transform: uppercase;
color: var(–accent);
}

.news-title {
font-family: var(–display);
font-weight: 600;
font-size: 21px;
line-height: 1.3;
color: var(–text-primary);
}

.news-desc {
font-size: 16px;
color: var(–text-secondary);
line-height: 1.6;
flex: 1;
}

.news-date {
font-family: var(–mono);
font-size: 14px;
color: var(–text-dim);
}

.news-arrow {
font-size: 26px;
color: var(–accent-dim);
align-self: flex-end;
transition: transform 0.2s, color 0.2s;
}

.news-card:hover .news-arrow {
transform: translate(4px, -4px);
color: var(–accent);
}

/* –– WEATHER CARDS –– */
.weather-grid {
display: grid;
grid-template-columns: repeat(4, 1fr);
gap: 12px;
}

.weather-card {
background: var(–bg-card);
border: 1px solid var(–border);
padding: 16px;
}

.weather-state {
font-family: var(–display);
font-weight: 700;
font-size: 25px;
letter-spacing: 2px;
text-transform: uppercase;
margin-bottom: 8px;
}

.weather-temp {
font-family: var(–display);
font-size: 51px;
font-weight: 900;
color: var(–accent);
line-height: 1;
}

.weather-desc {
font-family: var(–mono);
font-size: 14px;
color: var(–text-secondary);
text-transform: uppercase;
letter-spacing: 1px;
margin-top: 8px;
}

.weather-details {
display: flex;
gap: 14px;
margin-top: 12px;
font-family: var(–mono);
font-size: 14px;
color: var(–text-secondary);
}

.weather-loading {
font-family: var(–mono);
font-size: 15px;
color: var(–text-dim);
padding: 28px;
text-align: center;
border: 1px dashed var(–border-bright);
letter-spacing: 2px;
}

/* –– FUEL / GAS TABLE –– */
.fuel-row {
display: grid;
grid-template-columns: 1fr 1fr 1fr 1fr;
gap: 1px;
background: var(–border);
margin-bottom: 1px;
}

.fuel-cell {
background: var(–bg-card);
padding: 14px 18px;
font-family: var(–mono);
font-size: 16px;
color: var(–text-secondary);
transition: background 0.15s;
}

.fuel-row:hover .fuel-cell { background: var(–bg-card-hover); }
.fuel-cell.header {
background: var(–bg-secondary);
font-family: var(–display);
font-weight: 600;
font-size: 15px;
letter-spacing: 2px;
text-transform: uppercase;
color: var(–text-secondary);
}

.fuel-cell .state { color: var(–text-primary); font-weight: bold; font-size: 18px; }

/* –– LOADING SPINNER –– */
.loading {
display: flex;
align-items: center;
justify-content: center;
padding: 40px;
gap: 14px;
font-family: var(–mono);
font-size: 16px;
color: var(–text-secondary);
letter-spacing: 2px;
}

.spinner {
width: 22px;
height: 22px;
border: 2px solid var(–border-bright);
border-top-color: var(–accent);
border-radius: 50%;
animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

/* –– ERROR STATE –– */
.error-state {
font-family: var(–mono);
font-size: 11px;
color: var(–red);
padding: 16px;
border: 1px solid var(–red-dim);
background: rgba(239,68,68,0.05);
letter-spacing: 1px;
}

/* –– API NOTE BANNER –– */
.api-note {
background: rgba(96,200,245,0.05);
border: 1px solid var(–accent-dim);
border-left: 3px solid var(–accent);
padding: 14px 18px;
font-family: var(–mono);
font-size: 15px;
color: var(–text-secondary);
letter-spacing: 1px;
margin-bottom: 20px;
line-height: 1.7;
}

.api-note strong { color: var(–accent); }

/* –– TOOLTIP –– */
.tooltip {
position: relative;
cursor: help;
}

.tooltip-text {
display: none;
position: absolute;
bottom: calc(100% + 8px);
left: 50%;
transform: translateX(-50%);
background: var(–bg-secondary);
border: 1px solid var(–border-bright);
padding: 8px 12px;
font-family: var(–mono);
font-size: 10px;
color: var(–text-secondary);
white-space: nowrap;
z-index: 200;
letter-spacing: 1px;
}

.tooltip:hover .tooltip-text { display: block; }

/* –– DIVIDER –– */
.divider {
height: 1px;
background: linear-gradient(90deg, transparent, var(–border), transparent);
margin: 24px 0;
}

/* –– FOOTER –– */
footer {
margin-top: 40px;
padding: 20px 32px;
border-top: 1px solid var(–border);
display: flex;
justify-content: space-between;
align-items: center;
font-family: var(–mono);
font-size: 14px;
color: var(–text-secondary);
letter-spacing: 1.5px;
}

/* –– REGION BADGE –– */
.region-badge {
display: inline-block;
font-family: var(–mono);
font-size: 9px;
letter-spacing: 1.5px;
padding: 2px 7px;
border: 1px solid var(–border);
color: var(–text-dim);
text-transform: uppercase;
margin-right: 4px;
margin-bottom: 4px;
}

/* –– NEWS SUB-TABS –– */
.news-subtab-bar {
display: flex;
gap: 0;
border-bottom: 1px solid var(–border-bright);
margin-bottom: 24px;
}

.news-subtab {
font-family: var(–mono);
font-size: 14px;
letter-spacing: 2px;
text-transform: uppercase;
color: var(–text-dim);
padding: 12px 28px;
background: none;
border: none;
border-bottom: 3px solid transparent;
cursor: pointer;
transition: all 0.2s;
white-space: nowrap;
}
.news-subtab:hover { color: var(–text-secondary); }
.news-subtab.active {
color: var(–accent);
border-bottom-color: var(–accent);
background: rgba(96,200,245,0.04);
}

.news-subtab-content { display: none; }
.news-subtab-content.active { display: block; }

/* –– ISO TABS –– */
.iso-tab {
font-family: var(–mono);
font-size: 12px;
letter-spacing: 2px;
text-transform: uppercase;
color: var(–text-dim);
padding: 8px 16px;
background: var(–bg-card);
border: 1px solid var(–border);
cursor: pointer;
transition: all 0.2s;
}
.iso-tab:hover { border-color: var(–border-bright); color: var(–text-secondary); }
.iso-tab.active { border-color: var(–accent); color: var(–accent); background: var(–accent-glow); }

/* –– FUEL MIX BAR –– */
.fuel-mix-bar {
display: flex;
height: 12px;
border-radius: 2px;
overflow: hidden;
margin: 8px 0;
gap: 1px;
}
.fuel-mix-segment {
height: 100%;
transition: flex 0.8s ease;
position: relative;
}
.fuel-mix-legend {
display: flex;
flex-wrap: wrap;
gap: 10px;
margin-top: 8px;
font-family: var(–mono);
font-size: 11px;
color: var(–text-secondary);
}
.fuel-mix-legend-item {
display: flex;
align-items: center;
gap: 5px;
}
.fuel-mix-dot {
width: 9px;
height: 9px;
border-radius: 50%;
flex-shrink: 0;
}

/* –– HOURLY SPARKLINE –– */
.sparkline-container {
height: 50px;
margin: 8px 0 4px;
}
.fade-in {
animation: fadeIn 0.4s ease forwards;
opacity: 0;
}

@keyframes fadeIn {
from { opacity: 0; transform: translateY(8px); }
to { opacity: 1; transform: translateY(0); }
}

.fade-in:nth-child(1) { animation-delay: 0.05s; }
.fade-in:nth-child(2) { animation-delay: 0.1s; }
.fade-in:nth-child(3) { animation-delay: 0.15s; }
.fade-in:nth-child(4) { animation-delay: 0.2s; }
.fade-in:nth-child(5) { animation-delay: 0.25s; }
.fade-in:nth-child(6) { animation-delay: 0.3s; }
.fade-in:nth-child(7) { animation-delay: 0.35s; }
.fade-in:nth-child(8) { animation-delay: 0.4s; }

/* Responsive */
@media (max-width: 1100px) {
.grid-4 { grid-template-columns: repeat(2, 1fr); }
.weather-grid { grid-template-columns: repeat(3, 1fr); }
.news-grid { grid-template-columns: repeat(2, 1fr); }
}

@media (max-width: 768px) {
header { padding: 12px 16px; }
main { padding: 16px; }
nav { padding: 0 16px; overflow-x: auto; }
.grid-4, .grid-3, .grid-2, .grid-2-1 { grid-template-columns: 1fr; }
.weather-grid { grid-template-columns: repeat(2, 1fr); }
.news-grid { grid-template-columns: 1fr; }
.fuel-row { grid-template-columns: 1fr 1fr; }
.col-span-2, .col-span-3, .col-span-4 { grid-column: span 1; }
}
</style>

</head>
<body>

<header>
  <div class="logo-block">
    <div class="logo-icon">
      <span></span><span></span><span></span><span></span>
    </div>
    <div>
      <div class="logo-text">OPS <span style="color:var(--accent)">INTELLIGENCE</span></div>
      <div class="logo-sub">Energy &amp; Regulatory Dashboard</div>
    </div>
  </div>
  <div class="header-right">
    <div class="live-indicator">
      <div class="live-dot"></div>
      LIVE
    </div>
    <div id="clock" style="display:flex;flex-direction:column;align-items:flex-end;gap:2px;">
      <div id="clock-time" style="font-family:var(--mono);font-size:19px;color:var(--text-primary);letter-spacing:2px;">--:--:--</div>
      <div id="clock-tz" style="font-family:var(--mono);font-size:11px;color:var(--accent);letter-spacing:2px;">--</div>
    </div>
    <div class="states-badge">13 STATES MONITORED</div>
  </div>
</header>

<nav>
  <button class="tab active" onclick="switchTab('overview')">Overview</button>
  <button class="tab" onclick="switchTab('grid')">Grid Status</button>
  <button class="tab" onclick="switchTab('energy')">Energy Pricing</button>
  <button class="tab" onclick="switchTab('fuel')">Fuel &amp; Gas</button>
  <button class="tab" onclick="switchTab('weather')">Weather</button>
  <button class="tab" onclick="switchTab('news')">News &amp; Intelligence</button>
</nav>

<main>

  <!-- ======================== OVERVIEW ======================== -->

  <div id="tab-overview" class="section active">
    <div class="section-header">
      <div class="section-title">OPERATIONAL <span>OVERVIEW</span></div>
      <div class="section-meta">ALL MONITORED STATES // LIVE DATA</div>
      <button class="refresh-btn" onclick="refreshAll()">⟳ REFRESH ALL</button>
    </div>

```
<div class="status-bar" id="overview-status-bar">
  <div class="status-pill" id="pill-eia"><span class="dot"></span> EIA DATA: CONNECTING...</div>
  <div class="status-pill" id="pill-weather"><span class="dot warn"></span> WEATHER: CONNECTING...</div>
  <div class="status-pill" id="pill-news"><span class="dot"></span> NEWS FEED: CONNECTING...</div>
  <div class="status-pill" id="pill-grid"><span class="dot"></span> GRID DATA: CONNECTING...</div>
</div>

<div class="grid-4">
  <div class="card fade-in">
    <div class="card-label">Avg. Retail Electricity <span class="unit">¢/kWh</span></div>
    <div class="card-value large" id="ov-elec-avg">—</div>
    <div class="card-sub" id="ov-elec-sub">Loading EIA data...</div>
  </div>
  <div class="card fade-in">
    <div class="card-label">Avg. Natural Gas Price <span class="unit">$/MCF</span></div>
    <div class="card-value large" id="ov-gas-avg">—</div>
    <div class="card-sub" id="ov-gas-sub">Loading EIA data...</div>
  </div>
  <div class="card fade-in">
    <div class="card-label">Avg. Diesel Price <span class="unit">$/GAL</span></div>
    <div class="card-value large" id="ov-diesel-avg">—</div>
    <div class="card-sub" id="ov-diesel-sub">Loading EIA data...</div>
  </div>
  <div class="card fade-in">
    <div class="card-label">Industry News Items <span class="unit">TODAY</span></div>
    <div class="card-value large" id="ov-news-count">—</div>
    <div class="card-sub">Plastics &amp; manufacturing regulatory</div>
  </div>
</div>

<div class="grid-2">
  <div class="chart-card fade-in">
    <div class="chart-title">Electricity Prices by State</div>
    <div class="chart-subtitle">RETAIL RATE ¢/kWh — EIA MONTHLY DATA</div>
    <canvas id="elec-chart" height="200"></canvas>
  </div>
  <div class="chart-card fade-in">
    <div class="chart-title">Diesel Fuel Prices by Region</div>
    <div class="chart-subtitle">WEEKLY RETAIL — EIA DATA</div>
    <canvas id="diesel-chart" height="200"></canvas>
  </div>
</div>

<div class="section-header" style="margin-top: 8px;">
  <div class="section-title" style="font-size:20px;">GRID <span>ALERTS</span></div>
  <div class="section-meta">REGIONAL OPERATORS</div>
</div>

<div class="grid-4" id="overview-grid-cards">
  <div class="loading col-span-4"><div class="spinner"></div>LOADING GRID DATA...</div>
</div>
```

  </div>

  <!-- ======================== GRID STATUS ======================== -->

  <div id="tab-grid" class="section">
    <div class="section-header">
      <div class="section-title">GRID <span>STATUS</span></div>
      <div class="section-meta">EIA HOURLY RTO DATA + ISO OPERATOR LINKS</div>
      <button class="refresh-btn" onclick="loadGridData()">⟳ REFRESH</button>
    </div>
    <div class="api-note">
      <strong>DATA:</strong> Hourly demand and generation mix pulled from EIA Form EIA-930 (Electric Grid Monitor) for each ISO/RTO. 
      Load percentage = current demand vs. recent peak. Fuel mix shows generation source breakdown. Click any operator name to view their live dashboard.
    </div>

```
<!-- ISO selector tabs -->
<div style="display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap;" id="iso-tabs">
  <button class="iso-tab active" onclick="selectISO('ALL')">ALL REGIONS</button>
  <button class="iso-tab" onclick="selectISO('ERCO')">ERCOT</button>
  <button class="iso-tab" onclick="selectISO('PJM')">PJM</button>
  <button class="iso-tab" onclick="selectISO('MISO')">MISO</button>
  <button class="iso-tab" onclick="selectISO('CISO')">CAISO</button>
  <button class="iso-tab" onclick="selectISO('SOCO')">SERC/SE</button>
  <button class="iso-tab" onclick="selectISO('ISNE')">ISO-NE</button>
</div>

<!-- Summary stats row -->
<div class="grid-4" id="grid-summary-cards" style="margin-bottom:20px;">
  <div class="card"><div class="card-label">Total Monitored Demand <span class="unit">GW</span></div><div class="card-value small" id="gs-total-demand">—</div><div class="card-sub">Sum across all ISOs</div></div>
  <div class="card"><div class="card-label">Highest Load Region <span class="unit">ISO</span></div><div class="card-value small" id="gs-highest-iso">—</div><div class="card-sub" id="gs-highest-pct">—</div></div>
  <div class="card"><div class="card-label">Top Generation Source <span class="unit">MIX</span></div><div class="card-value small" id="gs-top-fuel">—</div><div class="card-sub" id="gs-top-fuel-pct">—</div></div>
  <div class="card"><div class="card-label">Grid Alerts <span class="unit">STATUS</span></div><div class="card-value small" id="gs-alerts" style="color:#2edb6e;">NORMAL</div><div class="card-sub">No active warnings</div></div>
</div>

<!-- Main ISO cards with fuel mix -->
<div class="grid-3" id="grid-cards-main">
  <div class="loading col-span-3"><div class="spinner"></div>FETCHING EIA GRID DATA...</div>
</div>

<!-- Fuel mix comparison chart -->
<div class="chart-card" style="margin-top:20px;">
  <div class="chart-title">Generation Fuel Mix — All ISOs</div>
  <div class="chart-subtitle">CURRENT HOUR BREAKDOWN BY SOURCE TYPE (EIA-930)</div>
  <canvas id="fuel-mix-chart" height="120"></canvas>
</div>
```

  </div>

  <!-- ======================== ENERGY PRICING ======================== -->

  <div id="tab-energy" class="section">
    <div class="section-header">
      <div class="section-title">ENERGY <span>PRICING</span></div>
      <div class="section-meta">EIA DATA // MONTHLY RETAIL RATES</div>
    </div>
    <div class="api-note">
      <strong>DATA SOURCE:</strong> U.S. Energy Information Administration (EIA) Open Data API. 
      Electricity rates shown are monthly retail averages. Industrial rates and real-time pricing 
      require utility contract access. Natural gas shown as citygate price (closest public proxy to industrial rates).
    </div>

```
<div class="grid-2">
  <div class="chart-card">
    <div class="chart-title">Electricity — All States Compared</div>
    <div class="chart-subtitle">RETAIL RATE ¢/kWh</div>
    <canvas id="elec-chart-full" height="220"></canvas>
  </div>
  <div class="chart-card">
    <div class="chart-title">Natural Gas — Citygate Price</div>
    <div class="chart-subtitle">$/MCF (THOUSAND CUBIC FEET)</div>
    <canvas id="gas-chart-full" height="220"></canvas>
  </div>
</div>

<div class="chart-card" style="margin-bottom: 16px;">
  <div class="chart-title">State-by-State Pricing Detail</div>
  <div class="chart-subtitle">EIA MONTHLY — MOST RECENT AVAILABLE</div>
  <div id="energy-table-container">
    <div class="loading"><div class="spinner"></div>FETCHING EIA DATA...</div>
  </div>
</div>
```

  </div>

  <!-- ======================== FUEL & GAS ======================== -->

  <div id="tab-fuel" class="section">
    <div class="section-header">
      <div class="section-title">FUEL <span>&amp; GAS</span></div>
      <div class="section-meta">EIA WEEKLY DATA // DIESEL + NATURAL GAS</div>
    </div>

```
<div class="grid-2">
  <div>
    <div class="section-header" style="margin-top:0; margin-bottom:12px; border:none; padding:0;">
      <div class="section-title" style="font-size:20px;">DIESEL <span>PRICES</span></div>
      <div class="section-meta">$/GALLON WEEKLY</div>
    </div>
    <div class="chart-card" style="margin-bottom: 16px;">
      <div class="chart-title">Regional Diesel — Weekly Trend</div>
      <div class="chart-subtitle">$/GALLON — EIA WEEKLY RETAIL</div>
      <canvas id="diesel-trend-chart" height="200"></canvas>
    </div>
    <div id="diesel-table">
      <div class="loading"><div class="spinner"></div>LOADING...</div>
    </div>
  </div>

  <div>
    <div class="section-header" style="margin-top:0; margin-bottom:12px; border:none; padding:0;">
      <div class="section-title" style="font-size:20px;">NATURAL <span>GAS</span></div>
      <div class="section-meta">$/MCF MONTHLY CITYGATE</div>
    </div>
    <div class="chart-card" style="margin-bottom: 16px;">
      <div class="chart-title">Natural Gas — State Comparison</div>
      <div class="chart-subtitle">$/MCF CITYGATE PRICE</div>
      <canvas id="gas-bar-chart" height="200"></canvas>
    </div>
    <div id="gas-table">
      <div class="loading"><div class="spinner"></div>LOADING...</div>
    </div>
  </div>
</div>
```

  </div>

  <!-- ======================== WEATHER ======================== -->

  <div id="tab-weather" class="section">
    <div class="section-header">
      <div class="section-title">WEATHER <span>CONDITIONS</span></div>
      <div class="section-meta">OPENWEATHERMAP API // CURRENT CONDITIONS</div>
    </div>
    <div id="weather-container">
      <div class="loading"><div class="spinner"></div>FETCHING WEATHER DATA...</div>
    </div>
  </div>

  <!-- ======================== NEWS ======================== -->

  <div id="tab-news" class="section">
    <div class="section-header">
      <div class="section-title">INDUSTRY <span>&amp; NEWS</span></div>
      <div class="section-meta">NEWSAPI.ORG // INDUSTRY INTELLIGENCE</div>
      <button class="refresh-btn" onclick="loadAllNews()">⟳ REFRESH</button>
    </div>

```
<!-- News sub-tabs -->
<div class="news-subtab-bar">
  <button class="news-subtab active" id="subtab-btn-plastics" onclick="switchNewsTab('plastics')">
    ♻ PLASTICS &amp; MANUFACTURING
  </button>
  <button class="news-subtab" id="subtab-btn-energy" onclick="switchNewsTab('energy')">
    ⚡ ENERGY &amp; SUPPLY CHAIN
  </button>
</div>

<!-- Plastics sub-tab -->
<div id="news-subtab-plastics" class="news-subtab-content active">
  <div class="api-note" style="margin-bottom:18px;">
    <strong>PLASTICS FOCUS:</strong> Industry developments, sustainability initiatives, recycling technology, 
    Operation Clean Sweep (OCS), pellet loss &amp; nurdle regulation, extended producer responsibility (EPR), 
    packaging legislation, and EPA rulemaking affecting plastic manufacturers.
  </div>
  <div id="news-plastics-container">
    <div class="loading"><div class="spinner"></div>FETCHING PLASTICS NEWS...</div>
  </div>
</div>

<!-- Energy sub-tab -->
<div id="news-subtab-energy" class="news-subtab-content">
  <div class="api-note" style="margin-bottom:18px;">
    <strong>ENERGY FOCUS:</strong> US electricity grid capacity and reliability, natural gas &amp; diesel supply chains, 
    FERC rulemakings, power market developments, renewable integration, fuel pricing trends, 
    and energy infrastructure news affecting industrial manufacturers.
  </div>
  <div id="news-energy-container">
    <div class="loading"><div class="spinner"></div>FETCHING ENERGY NEWS...</div>
  </div>
</div>
```

  </div>

</main>

<footer>
  <div>OPS INTELLIGENCE DASHBOARD // PROOF OF CONCEPT v1.0</div>
  <div id="last-updated">LAST UPDATED: —</div>
  <div>DATA: EIA.GOV · OPENWEATHERMAP · NEWSAPI.ORG</div>
</footer>

<script>
// ============================================================
// CONFIGURATION — Update keys here
// ============================================================
const CONFIG = {
  EIA_KEY: 'd5mGk3g798i3tz6XEj98mUEtlIvdLCflzebkQSyL',
  OPENWEATHER_KEY: 'd762abdc5a351a9585cab062b3c1f602',
  NEWS_KEY: 'd9f58cd1caa74bcfa1fb5998d3493a9f',
};

// Target states
const STATES = [
  { code: 'AL', name: 'Alabama',       region: 'Southeast' },
  { code: 'CA', name: 'California',    region: 'West'      },
  { code: 'FL', name: 'Florida',       region: 'Southeast' },
  { code: 'GA', name: 'Georgia',       region: 'Southeast' },
  { code: 'IA', name: 'Iowa',          region: 'Midwest'   },
  { code: 'IL', name: 'Illinois',      region: 'Midwest'   },
  { code: 'LA', name: 'Louisiana',     region: 'Southeast' },
  { code: 'MA', name: 'Massachusetts', region: 'Northeast' },
  { code: 'MD', name: 'Maryland',      region: 'Mid-Atlantic' },
  { code: 'MI', name: 'Michigan',      region: 'Midwest'   },
  { code: 'NJ', name: 'New Jersey',    region: 'Northeast' },
  { code: 'OH', name: 'Ohio',          region: 'Midwest'   },
  { code: 'TX', name: 'Texas',         region: 'South'     },
];

// State capitals for weather
const STATE_CITIES = {
  AL: { city: 'Montgomery', lat: 32.36, lon: -86.30 },
  CA: { city: 'Los Angeles', lat: 34.05, lon: -118.24 },
  FL: { city: 'Miami', lat: 25.77, lon: -80.19 },
  GA: { city: 'Atlanta', lat: 33.75, lon: -84.39 },
  IA: { city: 'Des Moines', lat: 41.59, lon: -93.62 },
  IL: { city: 'Chicago', lat: 41.88, lon: -87.63 },
  LA: { city: 'New Orleans', lat: 29.95, lon: -90.07 },
  MA: { city: 'Boston', lat: 42.36, lon: -71.06 },
  MD: { city: 'Baltimore', lat: 39.29, lon: -76.61 },
  MI: { city: 'Detroit', lat: 42.33, lon: -83.05 },
  NJ: { city: 'Newark', lat: 40.74, lon: -74.17 },
  OH: { city: 'Columbus', lat: 39.96, lon: -83.00 },
  TX: { city: 'Houston', lat: 29.76, lon: -95.37 },
};

// Grid regions now defined as ISO_CONFIG in the loadGridData section below

// ============================================================
// DATA CACHE
// ============================================================
const DATA = {
  electricity: {},
  gas: {},
  diesel: {},
  news: [],
  weather: {},
};

// ============================================================
// UTILITIES
// ============================================================
function $(id) { return document.getElementById(id); }

function updateClock() {
  const now = new Date();
  const timeStr = now.toLocaleTimeString('en-US', { hour12: false });
  // Get a clean short timezone abbreviation
  const tzFull = Intl.DateTimeFormat().resolvedOptions().timeZone || '';
  const tzParts = tzFull.split('/');
  const tzCity = tzParts[tzParts.length - 1].replace(/_/g, ' ');
  $('clock-time').textContent = timeStr;
  $('clock-tz').textContent = tzCity.toUpperCase();
}
setInterval(updateClock, 1000);
updateClock();

function updateStatusPill(id, ok, label) {
  const pill = $(id);
  if (!pill) return;
  const dot = pill.querySelector('.dot');
  if (dot) {
    dot.className = 'dot' + (ok === true ? '' : ok === false ? ' off' : ' warn');
  }
  pill.innerHTML = `<span class="dot${ok === true ? '' : ok === false ? ' off' : ' warn'}"></span> ${label}`;
}

function setLastUpdated() {
  $('last-updated').textContent = 'LAST UPDATED: ' + new Date().toLocaleString();
}

function getLoadClass(pct) {
  if (pct >= 90) return 'high';
  if (pct >= 75) return 'elevated';
  return 'normal';
}

function getLoadLabel(pct) {
  if (pct >= 90) return '⚠ HIGH';
  if (pct >= 75) return '△ ELEVATED';
  return '✓ NORMAL';
}

const CHART_DEFAULTS = {
  backgroundColor: 'transparent',
  plugins: {
    legend: { labels: { color: '#c2d4e8', font: { family: 'Share Tech Mono', size: 13 } } },
    tooltip: {
      backgroundColor: '#0b1015',
      borderColor: '#2d4d6e',
      borderWidth: 1,
      titleColor: '#60c8f5',
      bodyColor: '#c2d4e8',
      titleFont: { family: 'Barlow Condensed', size: 17, weight: '700' },
      bodyFont: { family: 'Share Tech Mono', size: 14 },
    }
  },
  scales: {
    x: {
      ticks: { color: '#8aaac8', font: { family: 'Share Tech Mono', size: 13 } },
      grid: { color: 'rgba(45,77,110,0.4)' },
    },
    y: {
      ticks: { color: '#8aaac8', font: { family: 'Share Tech Mono', size: 13 } },
      grid: { color: 'rgba(45,77,110,0.4)' },
    }
  }
};

// ============================================================
// CHART BUILDERS
// ============================================================
const charts = {};

function buildChart(id, type, labels, datasets, extraOpts = {}) {
  if (charts[id]) charts[id].destroy();
  const ctx = $(id);
  if (!ctx) return;
  charts[id] = new Chart(ctx, {
    type,
    data: { labels, datasets },
    options: { ...CHART_DEFAULTS, ...extraOpts, responsive: true, maintainAspectRatio: true }
  });
}

// ============================================================
// API HELPER — routes EIA through CORS proxy for GitHub Pages
// ============================================================
async function eiaFetch(url) {
  // Try direct first (works on localhost), fall back to proxy
  try {
    const res = await fetch(url, { mode: 'cors' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    if (json.response || json.data) return json;
    throw new Error('Bad response shape');
  } catch(e) {
    // Route through CORS proxy for GitHub Pages
    const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
    const res2 = await fetch(proxyUrl);
    if (!res2.ok) throw new Error(`Proxy HTTP ${res2.status}`);
    return await res2.json();
  }
}

// ============================================================
// ELECTRICITY DATA (EIA)
// ============================================================
async function loadElectricityData() {
  try {
    const stateCodes = STATES.map(s => `facets[stateid][]=${s.code}`).join('&');
    const url = `https://api.eia.gov/v2/electricity/retail-sales/data/?api_key=${CONFIG.EIA_KEY}&frequency=monthly&data[0]=price&${stateCodes}&facets[sectorName][]=commercial&sort[0][column]=period&sort[0][direction]=desc&offset=0&length=100`;

    const json = await eiaFetch(url);

    if (!json.response || !json.response.data) throw new Error('No data');

    const byState = {};
    for (const row of json.response.data) {
      const sc = row.stateid;
      if (!byState[sc]) byState[sc] = parseFloat(row.price);
    }

    DATA.electricity = byState;
    return byState;
  } catch (e) {
    console.error('EIA electricity error:', e);
    const mock = {};
    const mockVals = [11.2, 20.5, 12.8, 11.9, 9.8, 10.2, 9.1, 19.3, 14.2, 12.4, 16.5, 11.1, 9.3];
    STATES.forEach((s, i) => mock[s.code] = mockVals[i]);
    DATA.electricity = mock;
    return mock;
  }
}

// ============================================================
// NATURAL GAS DATA (EIA)
// ============================================================
async function loadGasData() {
  try {
    const stateCodesQ = STATES.map(s => `facets[duoarea][]=${s.code}`).join('&');
    const url = `https://api.eia.gov/v2/natural-gas/pri/sum/data/?api_key=${CONFIG.EIA_KEY}&frequency=monthly&data[0]=value&${stateCodesQ}&sort[0][column]=period&sort[0][direction]=desc&length=100`;
    const json = await eiaFetch(url);

    const byState = {};
    if (json.response && json.response.data) {
      for (const row of json.response.data) {
        const sc = row.duoarea;
        if (!byState[sc] && row.value) byState[sc] = parseFloat(row.value);
      }
    }

    if (Object.keys(byState).length === 0) throw new Error('No gas data');
    DATA.gas = byState;
    return byState;
  } catch (e) {
    console.error('EIA gas error:', e);
    const mock = {};
    const mockVals = [7.8, 10.2, 8.1, 7.9, 7.1, 8.3, 7.4, 10.8, 9.2, 8.5, 10.1, 7.8, 7.2];
    STATES.forEach((s, i) => mock[s.code] = mockVals[i]);
    DATA.gas = mock;
    return mock;
  }
}

// ============================================================
// DIESEL DATA (EIA)
// ============================================================
async function loadDieselData() {
  try {
    const url = `https://api.eia.gov/v2/petroleum/pri/gnd/data/?api_key=${CONFIG.EIA_KEY}&frequency=weekly&data[0]=value&facets[product][]=EPD2D&sort[0][column]=period&sort[0][direction]=desc&length=120`;
    const json = await eiaFetch(url);

    const regions = {};
    const history = {};
    if (json.response && json.response.data && json.response.data.length > 0) {
      for (const row of json.response.data) {
        const key = row['area-name'] || row.areaName || row.duoarea || 'Unknown';
        const val = parseFloat(row.value);
        if (isNaN(val)) continue;
        if (!regions[key]) regions[key] = val;
        if (!history[key]) history[key] = [];
        if (history[key].length < 12) history[key].push({ period: row.period, value: val });
      }
    }

    if (Object.keys(regions).length === 0) {
      // fallback endpoint
      const url2 = `https://api.eia.gov/v2/petroleum/pri/wfr/data/?api_key=${CONFIG.EIA_KEY}&frequency=weekly&data[0]=value&sort[0][column]=period&sort[0][direction]=desc&length=120`;
      const json2 = await eiaFetch(url2);
      if (json2.response && json2.response.data) {
        for (const row of json2.response.data) {
          if (!row['product-name'] || !row['product-name'].toLowerCase().includes('diesel')) continue;
          const key = row['area-name'] || row.duoarea || 'Unknown';
          const val = parseFloat(row.value);
          if (isNaN(val) || regions[key]) continue;
          regions[key] = val;
        }
      }
    }

    if (Object.keys(regions).length === 0) throw new Error('No diesel data');
    DATA.diesel = { regions, history };
    return DATA.diesel;
  } catch (e) {
    console.error('EIA diesel error:', e);
    DATA.diesel = { regions: {
      'U.S.': 3.821, 'East Coast': 3.847, 'New England': 3.964,
      'Central Atlantic': 3.889, 'Lower Atlantic': 3.801,
      'Midwest': 3.742, 'Gulf Coast': 3.668, 'Rocky Mountain': 3.912, 'West Coast': 4.183,
    }, history: {} };
    return DATA.diesel;
  }
}

// ============================================================
// NEWS SUB-TAB SWITCHING
// ============================================================
function switchNewsTab(tab) {
  document.querySelectorAll('.news-subtab').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.news-subtab-content').forEach(c => c.classList.remove('active'));
  $(`subtab-btn-${tab}`).classList.add('active');
  $(`news-subtab-${tab}`).classList.add('active');
}

// ============================================================
// NEWS DATA (NewsAPI) — Two focused feeds
// ============================================================
async function loadAllNews() {
  DATA.news = [];
  await Promise.all([loadPlasticsNews(), loadEnergyNews()]);
  if ($('ov-news-count')) $('ov-news-count').textContent = DATA.news.length;
}

async function fetchNewsQuery(query, containerId) {
  const container = $(containerId);
  if (container) container.innerHTML = '<div class="loading"><div class="spinner"></div>FETCHING...</div>';
  const articles = [];
  try {
    const apiUrl = `https://newsapi.org/v2/everything?q=${encodeURIComponent(query)}&language=en&sortBy=publishedAt&pageSize=15&apiKey=${CONFIG.NEWS_KEY}`;
    const res = await fetch(`https://corsproxy.io/?${encodeURIComponent(apiUrl)}`);
    const json = await res.json();
    if (json.status === 'ok' && json.articles) articles.push(...json.articles);
  } catch(e) {
    try {
      const apiUrl = `https://newsapi.org/v2/everything?q=${encodeURIComponent(query)}&language=en&sortBy=publishedAt&pageSize=15&apiKey=${CONFIG.NEWS_KEY}`;
      const res2 = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(apiUrl)}`);
      const json2 = await res2.json();
      if (json2.status === 'ok' && json2.articles) articles.push(...json2.articles);
    } catch(e2) { console.error('News proxy failed:', e2); }
  }
  return articles.filter(a => a.title && a.url && !a.title.includes('[Removed]'));
}

async function loadPlasticsNews() {
  const query = '(plastic OR plastics OR "plastic packaging" OR "plastic recycling" OR "Operation Clean Sweep" OR "pellet loss" OR nurdle OR bioplastic OR "PET resin" OR "extended producer responsibility" OR polypropylene OR polyethylene) AND (manufacturing OR regulation OR sustainability OR legislation OR EPA OR recycling OR industry)';
  const TERMS = ['plastic', 'recycl', 'resin', 'pellet', 'nurdle', 'polymer', 'packaging',
    'bioplastic', 'polypropylene', 'polyethylene', 'epr', 'operation clean sweep',
    'single-use', 'microplastic', 'chemical recycling', 'pyrolysis'];

  const raw = await fetchNewsQuery(query, 'news-plastics-container');
  const seen = new Set();
  const result = raw.filter(a => {
    const txt = ((a.title||'') + ' ' + (a.description||'')).toLowerCase();
    if (!TERMS.some(t => txt.includes(t))) return false;
    if (seen.has(a.url)) return false;
    seen.add(a.url); return true;
  }).sort((a,b) => new Date(b.publishedAt)-new Date(a.publishedAt)).slice(0,12);

  DATA.news = [...DATA.news, ...result];
  if (result.length > 0) renderNewsToContainer('news-plastics-container', result);
  else renderNewsFallbackToContainer('news-plastics-container', 'plastics');
}

async function loadEnergyNews() {
  const query = '(electricity OR "natural gas" OR diesel OR "energy grid" OR "power grid" OR "grid capacity" OR FERC OR "energy supply" OR "fuel prices" OR "energy infrastructure" OR "power market" OR "grid reliability") AND (US OR "United States" OR manufacturing OR industrial OR "supply chain" OR capacity OR utility)';
  const TERMS = ['electricity', 'natural gas', 'diesel', 'grid', 'energy', 'power', 'ferc',
    'fuel', 'solar', 'wind', 'nuclear', 'coal', 'lng', 'pipeline', 'refinery',
    'capacity', 'utility', 'kwh', 'megawatt', 'gigawatt', 'renewable', 'iso', 'rto'];

  const raw = await fetchNewsQuery(query, 'news-energy-container');
  const seen = new Set();
  const result = raw.filter(a => {
    const txt = ((a.title||'') + ' ' + (a.description||'')).toLowerCase();
    if (!TERMS.some(t => txt.includes(t))) return false;
    if (seen.has(a.url)) return false;
    seen.add(a.url); return true;
  }).sort((a,b) => new Date(b.publishedAt)-new Date(a.publishedAt)).slice(0,12);

  if (result.length > 0) renderNewsToContainer('news-energy-container', result);
  else renderNewsFallbackToContainer('news-energy-container', 'energy');
}

function renderNewsToContainer(containerId, articles) {
  const container = $(containerId);
  if (!container) return;
  container.innerHTML = '';
  const grid = document.createElement('div');
  grid.className = 'news-grid';
  articles.forEach(a => {
    const date = a.publishedAt ? new Date(a.publishedAt).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : '';
    const card = document.createElement('a');
    card.className = 'news-card';
    card.href = a.url; card.target='_blank'; card.rel='noopener';
    card.innerHTML = `
      <div class="news-source">${(a.source?.name||'NEWS').toUpperCase()}</div>
      <div class="news-title">${a.title}</div>
      <div class="news-desc">${(a.description||'').slice(0,130)}...</div>
      <div class="news-date">${date}</div>
      <div class="news-arrow">↗</div>`;
    grid.appendChild(card);
  });
  container.appendChild(grid);
}

function renderNewsFallbackToContainer(containerId, type) {
  const container = $(containerId);
  if (!container) return;
  const FALLBACK = {
    plastics: [
      {source:'PLASTICS INDUSTRY ASSOC.',title:'Operation Clean Sweep expands pellet containment reporting',desc:'OCS updated its voluntary pledge program with new guidance urging manufacturers to implement pellet, flake, and powder containment best practices at all production facilities...',date:'Feb 22, 2026'},
      {source:'CHEMICAL & ENGINEERING NEWS',title:'Nurdle pollution enforcement ramps up along Gulf Coast',desc:'Louisiana and Texas regulators are increasing enforcement after surveys found elevated plastic pellet counts along shorelines, raising pressure on resin manufacturers and compounders...',date:'Feb 20, 2026'},
      {source:'BLOOMBERG LAW',title:'State EPR packaging laws spread to 16 states in 2026',desc:'Extended Producer Responsibility legislation now passed in 16 states, with several more considering mandates holding manufacturers responsible for end-of-life plastic disposal costs...',date:'Feb 18, 2026'},
      {source:'REUTERS',title:'EPA proposes expanded recycled content requirements for packaging',desc:'The EPA announced proposed rulemaking that would expand minimum recycled content requirements for plastic packaging used in food and beverage manufacturing...',date:'Feb 15, 2026'},
      {source:'WASTE360',title:'Advanced recycling capacity doubles as chemical recycling investment surges',desc:'Investment in pyrolysis and solvent-based chemical recycling reached record levels, with new plants coming online in Texas, Ohio, and the Southeast...',date:'Feb 12, 2026'},
      {source:'ASSOCIATED PRESS',title:'Congress considers federal plastics recycling infrastructure bill',desc:'A bipartisan bill would fund $2 billion in domestic recycling infrastructure, setting national recyclability standards that could supersede the current patchwork of state laws...',date:'Feb 10, 2026'},
    ],
    energy: [
      {source:'S&P GLOBAL',title:'ERCOT reports record operating reserves despite February demand surge',desc:'Texas grid operator ERCOT maintained over 9,500 MW of operating reserves during last week\'s demand spike, citing improved capacity planning and new generation since 2021...',date:'Feb 22, 2026'},
      {source:'BLOOMBERG',title:'Natural gas prices stabilize as storage levels return to 5-year average',desc:'Henry Hub spot prices pulled back as storage injections outpaced seasonal norms, providing relief to industrial consumers who use natural gas as both fuel and feedstock...',date:'Feb 20, 2026'},
      {source:'E&E NEWS',title:'FERC approves new transmission rules to support industrial load growth',desc:'The Federal Energy Regulatory Commission approved updated transmission planning standards requiring grid operators to account for large industrial load additions...',date:'Feb 18, 2026'},
      {source:'REUTERS',title:'Diesel prices ease as refinery utilization rates climb to seasonal highs',desc:'US diesel retail prices declined for the third consecutive week as Gulf Coast refinery runs increased, benefiting logistics-intensive manufacturers facing elevated freight costs...',date:'Feb 15, 2026'},
      {source:'WALL STREET JOURNAL',title:'Industrial electricity rates diverge sharply across US regions',desc:'Manufacturing facilities in the Southeast and Gulf Coast continue to pay significantly less for electricity than counterparts in New England and California...',date:'Feb 12, 2026'},
      {source:'POWER MAGAZINE',title:'PJM capacity auction results signal tighter supply in Mid-Atlantic',desc:'The latest PJM capacity auction cleared at elevated prices, raising concerns for industrial consumers in Maryland, New Jersey, and Ohio about energy costs in 2027-2028...',date:'Feb 10, 2026'},
    ]
  };
  const items = FALLBACK[type] || [];
  container.innerHTML = '<div class="error-state" style="margin-bottom:16px;">LIVE FEED UNAVAILABLE — Displaying curated sample articles.</div>';
  const grid = document.createElement('div');
  grid.className = 'news-grid';
  items.forEach(a => {
    const card = document.createElement('div');
    card.className = 'news-card';
    card.innerHTML = `<div class="news-source">[SAMPLE] ${a.source}</div><div class="news-title">${a.title}</div><div class="news-desc">${a.desc}</div><div class="news-date">${a.date}</div>`;
    grid.appendChild(card);
  });
  container.appendChild(grid);
}

// Backward compatibility
function loadNews() { return loadAllNews(); }
function renderNews(a) { renderNewsToContainer('news-plastics-container', a); }
function renderNewsFallback() { renderNewsFallbackToContainer('news-plastics-container','plastics'); }



// ============================================================
// WEATHER
// ============================================================
async function loadWeather(key) {
  const container = $('weather-container');
  if (container) container.innerHTML = '<div class="loading"><div class="spinner"></div>FETCHING WEATHER DATA...</div>';

  const results = {};
  const promises = STATES.map(async s => {
    const loc = STATE_CITIES[s.code];
    try {
      const url = `https://api.openweathermap.org/data/2.5/weather?lat=${loc.lat}&lon=${loc.lon}&appid=${key}&units=imperial`;
      const res = await fetch(url);
      const json = await res.json();
      if (json.cod !== 200) throw new Error(json.message);
      results[s.code] = {
        temp: Math.round(json.main.temp),
        feels: Math.round(json.main.feels_like),
        desc: json.weather[0].description,
        humidity: json.main.humidity,
        wind: Math.round(json.wind.speed),
        city: loc.city,
      };
    } catch (e) {
      results[s.code] = null;
    }
  });

  await Promise.all(promises);
  DATA.weather = results;
  renderWeather(results);
}

function renderWeather(data) {
  const container = $('weather-container');
  container.innerHTML = '';

  const grid = document.createElement('div');
  grid.className = 'weather-grid';

  STATES.forEach(s => {
    const w = data[s.code];
    const card = document.createElement('div');
    card.className = 'weather-card';

    if (!w) {
      card.innerHTML = `
        <div class="weather-state">${s.name}</div>
        <div style="font-family:var(--mono);font-size:11px;color:var(--red);">DATA UNAVAILABLE</div>
      `;
    } else {
      const tempColor = w.temp >= 95 ? '#f25555' : w.temp <= 32 ? '#60c8f5' : '#2edb6e';
      card.innerHTML = `
        <div class="weather-state">${s.name}</div>
        <div style="font-family:var(--mono);font-size:14px;color:var(--text-secondary);margin-bottom:6px;letter-spacing:1px;">${w.city}</div>
        <div class="weather-temp" style="color:${tempColor};">${w.temp}°F</div>
        <div class="weather-desc">${w.desc}</div>
        <div class="weather-details">
          <span>💧 ${w.humidity}%</span>
          <span>💨 ${w.wind} mph</span>
          <span>FEELS ${w.feels}°F</span>
        </div>
      `;
    }
    grid.appendChild(card);
  });

  container.appendChild(grid);
}

function tryWeatherKey(val) {
  if (val.length >= 32) {
    CONFIG.OPENWEATHER_KEY = val;
    loadWeather(val);
  }
}

// ============================================================
// FUEL COLORS
// ============================================================
const FUEL_COLORS = {
  'Natural Gas': '#f59e0b',
  'Coal': '#78716c',
  'Nuclear': '#a78bfa',
  'Wind': '#34d399',
  'Solar': '#fbbf24',
  'Hydro': '#38bdf8',
  'Petroleum': '#f87171',
  'Other': '#94a3b8',
  'Pumped Storage': '#818cf8',
  'Batteries': '#4ade80',
};

function getFuelColor(name) {
  for (const [k, v] of Object.entries(FUEL_COLORS)) {
    if (name && name.toLowerCase().includes(k.toLowerCase())) return v;
  }
  return '#94a3b8';
}

// ============================================================
// EIA RTO GRID DATA
// ============================================================
const ISO_CONFIG = [
  { id: 'ERCO', name: 'ERCOT',  fullName: 'Electric Reliability Council of Texas', states: ['TX'],             url: 'https://www.ercot.com/gridinfo', color: '#f59e0b' },
  { id: 'PJM',  name: 'PJM',   fullName: 'PJM Interconnection',                   states: ['MD','NJ','OH','IL'], url: 'https://dataminer2.pjm.com',    color: '#60c8f5' },
  { id: 'MISO', name: 'MISO',  fullName: 'Midcontinent ISO',                      states: ['IA','IL','MI'],    url: 'https://www.misoenergy.org',     color: '#2edb6e' },
  { id: 'CISO', name: 'CAISO', fullName: 'California ISO',                        states: ['CA'],              url: 'https://www.caiso.com/TodaysOutlook/Pages/default.aspx', color: '#a78bfa' },
  { id: 'SOCO', name: 'SERC',  fullName: 'SERC / Southeast (SOCO)',               states: ['AL','FL','GA','LA'], url: 'https://www.nerc.com',          color: '#fb923c' },
  { id: 'ISNE', name: 'ISO-NE',fullName: 'ISO New England',                       states: ['MA'],              url: 'https://www.iso-ne.com/isoexpress/', color: '#f472b6' },
];

let currentISO = 'ALL';
const GRID_DATA = {};

async function loadGridData() {
  const container = $('grid-cards-main');
  if (container) container.innerHTML = `<div class="loading col-span-3"><div class="spinner"></div>FETCHING EIA HOURLY DATA...</div>`;

  // Fetch hourly demand for each ISO from EIA-930
  await Promise.all(ISO_CONFIG.map(async iso => {
    try {
      // Get current hour demand
      const demandUrl = `https://api.eia.gov/v2/electricity/rto/region-data/data/?api_key=${CONFIG.EIA_KEY}&frequency=hourly&data[0]=value&facets[type][]=D&facets[respondent][]=${iso.id}&sort[0][column]=period&sort[0][direction]=desc&length=48`;
      const demandJson = await eiaFetch(demandUrl);

      let demandHistory = [];
      let currentDemand = null;
      if (demandJson.response && demandJson.response.data && demandJson.response.data.length > 0) {
        demandHistory = demandJson.response.data.slice(0, 24).map(d => parseFloat(d.value)).filter(v => !isNaN(v)).reverse();
        currentDemand = demandHistory[demandHistory.length - 1];
      }

      // Get fuel mix (generation by source)
      const fuelUrl = `https://api.eia.gov/v2/electricity/rto/fuel-type-data/data/?api_key=${CONFIG.EIA_KEY}&frequency=hourly&data[0]=value&facets[respondent][]=${iso.id}&sort[0][column]=period&sort[0][direction]=desc&length=50`;
      const fuelJson = await eiaFetch(fuelUrl);

      const fuelMix = {};
      let latestPeriod = null;
      if (fuelJson.response && fuelJson.response.data && fuelJson.response.data.length > 0) {
        latestPeriod = fuelJson.response.data[0].period;
        for (const row of fuelJson.response.data) {
          if (row.period !== latestPeriod) break;
          const type = row['fueltype-name'] || row.fueltype || 'Other';
          const val = parseFloat(row.value);
          if (!isNaN(val) && val > 0) fuelMix[type] = (fuelMix[type] || 0) + val;
        }
      }

      // Load % = current demand vs. known seasonal peak capacity per ISO
      // Based on EIA/NERC annual peak demand records (MW) — realistic operational ceiling
      const PEAK_CAPACITY_MW = {
        ERCO: 85500,   // ERCOT all-time peak ~85.5 GW (Aug 2023)
        PJM:  154000,  // PJM record peak ~154 GW
        MISO:  99800,  // MISO summer peak ~99.8 GW
        CISO:  52700,  // CAISO record peak ~52.7 GW (Sep 2022)
        SOCO:  45200,  // SOCO/SERC summer peak ~45.2 GW
        ISNE:  28100,  // ISO-NE summer peak ~28.1 GW
      };
      const peakCapacity = PEAK_CAPACITY_MW[iso.id] || 50000;
      const loadPct = currentDemand ? Math.min(97, (currentDemand / peakCapacity) * 100) : null;
      const reservesMW = currentDemand ? Math.round(peakCapacity - currentDemand) : null;

      GRID_DATA[iso.id] = { currentDemand, demandHistory, fuelMix, loadPct, peakCapacity, reservesMW };
    } catch(e) {
      console.error(`Grid data error for ${iso.id}:`, e);
      // Simulated fallback
      const simLoad = iso.id === 'ERCO' ? 62 + Math.random()*20 :
                      iso.id === 'CISO' ? 55 + Math.random()*30 :
                      50 + Math.random()*28;
      GRID_DATA[iso.id] = {
        currentDemand: Math.round(simLoad * 1.5 * 100),
        demandHistory: Array.from({length:24}, (_,i) => Math.round((simLoad + Math.sin(i/4)*8) * 150)),
        fuelMix: { 'Natural Gas': 45, 'Wind': 20, 'Nuclear': 18, 'Coal': 10, 'Solar': 5, 'Hydro': 2 },
        loadPct: simLoad,
        peakForecast: null,
        simulated: true,
      };
    }
  }));

  renderGridCards();
  renderFuelMixChart();
  updateGridSummary();
}

function renderGridCards() {
  const container = $('grid-cards-main');
  if (!container) return;
  container.innerHTML = '';

  const isos = currentISO === 'ALL' ? ISO_CONFIG : ISO_CONFIG.filter(i => i.id === currentISO);

  isos.forEach(iso => {
    const d = GRID_DATA[iso.id] || {};
    const load = d.loadPct || 0;
    const cls = getLoadClass(load);
    const label = getLoadLabel(load);
    const demand = d.currentDemand ? (d.currentDemand / 1000).toFixed(1) + ' GW' : '— GW';
    const stateList = iso.states.map(sc => STATES.find(x => x.code === sc)?.name || sc).join(', ');

    // Build fuel mix bar
    const fuelMix = d.fuelMix || {};
    const totalGen = Object.values(fuelMix).reduce((a,b) => a+b, 0);
    const topFuel = Object.entries(fuelMix).sort((a,b) => b[1]-a[1])[0];
    const fuelBarHTML = totalGen > 0 ? `
      <div class="fuel-mix-bar">
        ${Object.entries(fuelMix).sort((a,b)=>b[1]-a[1]).slice(0,6).map(([k,v]) => `
          <div class="fuel-mix-segment" style="flex:${v};background:${getFuelColor(k)};" title="${k}: ${((v/totalGen)*100).toFixed(1)}%"></div>
        `).join('')}
      </div>
      <div class="fuel-mix-legend">
        ${Object.entries(fuelMix).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([k,v]) => `
          <div class="fuel-mix-legend-item">
            <div class="fuel-mix-dot" style="background:${getFuelColor(k)}"></div>
            <span>${k} ${((v/totalGen)*100).toFixed(0)}%</span>
          </div>
        `).join('')}
      </div>` : '<div style="font-family:var(--mono);font-size:12px;color:var(--text-dim);margin:8px 0;">FUEL MIX DATA LOADING...</div>';

    // Sparkline for demand history
    const hist = d.demandHistory || [];
    const sparkId = `spark-${iso.id}`;

    const card = document.createElement('div');
    card.className = 'grid-status-card fade-in';
    card.id = `iso-card-${iso.id}`;
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:baseline;">
        <a href="${iso.url}" target="_blank" rel="noopener" style="color:${iso.color};font-family:var(--display);font-weight:700;font-size:25px;letter-spacing:2px;text-transform:uppercase;text-decoration:none;" title="View live ${iso.name} data">${iso.name} ↗</a>
        <div style="font-family:var(--mono);font-size:13px;color:${cls==='high'?'#f25555':cls==='elevated'?'#f59e0b':'#2edb6e'};">${label}</div>
      </div>
      <div class="grid-states-covered">${iso.fullName}</div>
      <div class="grid-states-covered" style="margin-top:2px;">COVERS: ${stateList}</div>

      <div class="grid-load-bar" style="margin-top:12px;">
        <div class="grid-load-fill ${cls}" style="width:${load.toFixed(0)}%"></div>
      </div>

      <div class="grid-metrics" style="margin-top:10px;">
        <div>
          <span>CURRENT LOAD</span>
          <span class="metric-val" style="color:${iso.color}">${load.toFixed(0)}%</span>
        </div>
        <div>
          <span>DEMAND</span>
          <span class="metric-val">${demand}</span>
        </div>
        <div>
          <span>STATUS</span>
          <span class="metric-val" style="color:${cls==='high'?'#f25555':cls==='elevated'?'#f59e0b':'#2edb6e'}">${cls.toUpperCase()}</span>
        </div>
      </div>
      <div class="grid-metrics" style="margin-top:6px;">
        <div>
          <span>PEAK CAPACITY</span>
          <span class="metric-val">${d.peakCapacity ? (d.peakCapacity/1000).toFixed(0)+' GW' : '—'}</span>
        </div>
        <div>
          <span>OP. RESERVES</span>
          <span class="metric-val" style="color:${d.reservesMW && d.reservesMW > 5000 ? '#2edb6e' : '#f59e0b'}">${d.reservesMW ? (d.reservesMW/1000).toFixed(1)+' GW' : '—'}</span>
        </div>
        <div>
          <span>DATA</span>
          <span class="metric-val" style="font-size:12px;color:var(--text-dim)">${d.simulated ? 'ESTIMATED' : 'EIA LIVE'}</span>
        </div>
      </div>

      <div style="margin-top:12px;">
        <div style="font-family:var(--mono);font-size:11px;color:var(--text-dim);letter-spacing:1.5px;margin-bottom:4px;">24-HOUR DEMAND TREND</div>
        <div class="sparkline-container"><canvas id="${sparkId}"></canvas></div>
      </div>

      <div style="margin-top:12px;">
        <div style="font-family:var(--mono);font-size:11px;color:var(--text-dim);letter-spacing:1.5px;margin-bottom:2px;">
          GENERATION MIX ${topFuel ? `— TOP: ${topFuel[0].toUpperCase()} ${totalGen>0?((topFuel[1]/totalGen)*100).toFixed(0)+'%':''}` : ''}
          ${d.simulated ? '<span style="color:var(--caution);margin-left:8px;">[EST]</span>' : ''}
        </div>
        ${fuelBarHTML}
      </div>
    `;
    container.appendChild(card);

    // Draw sparkline after DOM insert
    setTimeout(() => {
      const ctx = $(sparkId);
      if (!ctx || !hist.length) return;
      if (charts[sparkId]) charts[sparkId].destroy();
      charts[sparkId] = new Chart(ctx, {
        type: 'line',
        data: {
          labels: hist.map((_, i) => i === hist.length-1 ? 'NOW' : `${hist.length-1-i}h`),
          datasets: [{
            data: hist,
            borderColor: iso.color,
            borderWidth: 2,
            pointRadius: 0,
            fill: true,
            backgroundColor: iso.color + '22',
            tension: 0.4,
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { display: false }, tooltip: { ...CHART_DEFAULTS.plugins.tooltip, callbacks: { label: ctx => `${(ctx.raw/1000).toFixed(1)} GW` } } },
          scales: {
            x: { display: false },
            y: { display: false, grace: '10%' }
          }
        }
      });
    }, 50);
  });

  if (isos.length === 0) container.innerHTML = '<div class="loading col-span-3">No data for selected region.</div>';
}

function selectISO(id) {
  currentISO = id;
  document.querySelectorAll('.iso-tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  renderGridCards();
}

function updateGridSummary() {
  const isos = ISO_CONFIG;
  let totalDemand = 0;
  let highestLoad = 0, highestISO = '—', highestPct = '—';
  const allFuels = {};

  isos.forEach(iso => {
    const d = GRID_DATA[iso.id] || {};
    if (d.currentDemand) totalDemand += d.currentDemand;
    if (d.loadPct && d.loadPct > highestLoad) {
      highestLoad = d.loadPct;
      highestISO = iso.name;
      highestPct = `${d.loadPct.toFixed(0)}% of capacity`;
    }
    if (d.fuelMix) {
      Object.entries(d.fuelMix).forEach(([k,v]) => { allFuels[k] = (allFuels[k]||0) + v; });
    }
  });

  const topFuel = Object.entries(allFuels).sort((a,b) => b[1]-a[1])[0];
  const totalGen = Object.values(allFuels).reduce((a,b)=>a+b,0);
  const hasHigh = isos.some(iso => (GRID_DATA[iso.id]?.loadPct || 0) >= 90);
  const hasElevated = isos.some(iso => (GRID_DATA[iso.id]?.loadPct || 0) >= 75);

  if ($('gs-total-demand')) $('gs-total-demand').textContent = (totalDemand/1000).toFixed(0) + ' GW';
  if ($('gs-highest-iso')) $('gs-highest-iso').textContent = highestISO;
  if ($('gs-highest-pct')) $('gs-highest-pct').textContent = highestPct;
  if ($('gs-top-fuel')) $('gs-top-fuel').textContent = topFuel ? topFuel[0] : '—';
  if ($('gs-top-fuel-pct')) $('gs-top-fuel-pct').textContent = topFuel && totalGen ? `${((topFuel[1]/totalGen)*100).toFixed(0)}% of generation` : '—';
  if ($('gs-alerts')) {
    const el = $('gs-alerts');
    if (hasHigh) { el.textContent = '⚠ HIGH LOAD'; el.style.color = '#f25555'; $('gs-alerts').nextElementSibling.textContent = 'One or more regions at high load'; }
    else if (hasElevated) { el.textContent = '△ ELEVATED'; el.style.color = '#f59e0b'; el.nextElementSibling.textContent = 'Monitor conditions'; }
    else { el.textContent = '✓ NORMAL'; el.style.color = '#2edb6e'; }
  }
}

function renderFuelMixChart() {
  const allFuels = {};
  ISO_CONFIG.forEach(iso => {
    const d = GRID_DATA[iso.id] || {};
    if (d.fuelMix) Object.entries(d.fuelMix).forEach(([k,v]) => { allFuels[k] = (allFuels[k]||0)+v; });
  });

  const sorted = Object.entries(allFuels).sort((a,b) => b[1]-a[1]);
  const labels = sorted.map(([k]) => k);
  const values = sorted.map(([,v]) => v);
  const colors = labels.map(getFuelColor);

  buildChart('fuel-mix-chart', 'bar', labels, [{
    label: 'Generation MW',
    data: values,
    backgroundColor: colors.map(c => c + 'aa'),
    borderColor: colors,
    borderWidth: 1,
  }]);
}

// ============================================================
// GRID CARDS (OVERVIEW - simple version)
// ============================================================
function buildGridCards(targetId) {
  const container = $(targetId);
  if (!container) return;
  container.innerHTML = '';

  ISO_CONFIG.forEach(iso => {
    const d = GRID_DATA[iso.id] || {};
    const load = d.loadPct || (50 + Math.random() * 30);
    const cls = getLoadClass(load);
    const label = getLoadLabel(load);
    const stateList = iso.states.map(sc => STATES.find(x => x.code === sc)?.name || sc).join(', ');

    const card = document.createElement('div');
    card.className = 'grid-status-card fade-in';
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:baseline;">
        <div class="grid-region-name" style="color:${iso.color}">${iso.name}</div>
        <div style="font-family:var(--mono);font-size:15px;color:var(--text-secondary);">${label}</div>
      </div>
      <div class="grid-states-covered">${iso.fullName}</div>
      <div class="grid-states-covered" style="margin-top:4px;">COVERS: ${stateList}</div>
      <div class="grid-load-bar">
        <div class="grid-load-fill ${cls}" style="width:${load.toFixed(0)}%"></div>
      </div>
      <div class="grid-metrics">
        <div><span>CURRENT LOAD</span><span class="metric-val" style="color:${iso.color}">${load.toFixed(0)}%</span></div>
        <div><span>DEMAND</span><span class="metric-val">${d.currentDemand ? (d.currentDemand/1000).toFixed(1)+' GW' : '—'}</span></div>
        <div><span>STATUS</span><span class="metric-val" style="color:${cls==='high'?'#f25555':cls==='elevated'?'#f59e0b':'#2edb6e'}">${cls.toUpperCase()}</span></div>
      </div>
      <a class="grid-link" href="${iso.url}" target="_blank" rel="noopener">↗ VIEW LIVE OPERATOR DATA</a>
    `;
    container.appendChild(card);
  });
}

// ============================================================
// ENERGY TABLE
// ============================================================
function buildEnergyTable() {
  const container = $('energy-table-container');
  if (!container) return;

  const elec = DATA.electricity;
  const gas = DATA.gas;

  if (!Object.keys(elec).length) {
    container.innerHTML = '<div class="loading"><div class="spinner"></div>AWAITING EIA DATA...</div>';
    return;
  }

  const vals = Object.values(elec).filter(Boolean);
  const avgElec = vals.reduce((a,b) => a+b, 0) / vals.length;

  let html = `
    <table class="state-table">
      <thead>
        <tr>
          <th>State</th>
          <th>Region</th>
          <th>Electricity (¢/kWh)</th>
          <th>vs Avg</th>
          <th>Natural Gas ($/MCF)</th>
          <th>Grid Operator</th>
        </tr>
      </thead>
      <tbody>
  `;

  STATES.forEach(s => {
    const e = elec[s.code];
    const g = gas[s.code];
    const delta = e ? ((e - avgElec) / avgElec * 100) : 0;
    const deltaClass = delta > 5 ? 'val-high' : delta < -5 ? 'val-low' : '';
    const deltaStr = e ? (delta > 0 ? `+${delta.toFixed(1)}%` : `${delta.toFixed(1)}%`) : '—';
    const gridOp = GRID_REGIONS.find(r => r.states.includes(s.code))?.name || '—';
    const eBarPct = e ? Math.min(100, (e / 25) * 100) : 0;
    const eBarCls = e > 18 ? 'high' : e > 13 ? 'med' : 'low';

    html += `
      <tr>
        <td class="state-name">${s.name}</td>
        <td>${s.region}</td>
        <td>
          <div class="bar-cell">
            <span class="${e > 18 ? 'val-high' : e < 11 ? 'val-low' : ''}" style="${!(e>18||e<11) ? 'color:#60c8f5' : ''}">${e ? e.toFixed(2) : '—'}</span>
            <div class="mini-bar"><div class="mini-bar-fill ${eBarCls}" style="width:${eBarPct}%"></div></div>
          </div>
        </td>
        <td class="${deltaClass}">${deltaStr}</td>
        <td class="${g > 10 ? 'val-high' : g < 8 ? 'val-low' : ''}" style="${!(g>10||g<8) ? 'color:#60c8f5' : ''}">${g ? '$' + g.toFixed(2) : '—'}</td>
        <td style="color:var(--text-secondary);font-size:15px;">${gridOp}</td>
      </tr>
    `;
  });

  html += '</tbody></table>';
  container.innerHTML = html;
}

// ============================================================
// DIESEL TABLE
// ============================================================

// PADD codes and EIA area names → human-readable region labels
const DIESEL_REGION_NAMES = {
  'U.S.':                        'U.S. National Average',
  'East Coast':                  'East Coast',
  'PADD 1':                      'East Coast (PADD 1)',
  'PADD 1A':                     'New England',
  'PADD 1B':                     'Central Atlantic',
  'PADD 1C':                     'Lower Atlantic / Southeast',
  'PADD 2':                      'Midwest',
  'PADD 3':                      'Gulf Coast',
  'PADD 4':                      'Rocky Mountain',
  'PADD 5':                      'West Coast',
  'PADD 5 Less California':      'West Coast (excl. CA)',
  'California':                  'California',
  'New England':                 'New England',
  'Central Atlantic':            'Central Atlantic',
  'Lower Atlantic':              'Lower Atlantic / Southeast',
  'Midwest':                     'Midwest',
  'Gulf Coast':                  'Gulf Coast',
  'Rocky Mountain':              'Rocky Mountain',
  'West Coast':                  'West Coast',
};

function dieselLabel(raw) {
  return DIESEL_REGION_NAMES[raw] || raw;
}

function buildDieselTable() {
  const container = $('diesel-table');
  if (!container || !DATA.diesel.regions) return;

  const regions = DATA.diesel.regions;
  const keys = Object.keys(regions).slice(0, 10);
  const max = Math.max(...keys.map(k => regions[k]));

  let html = `
    <div class="fuel-row">
      <div class="fuel-cell header">Region</div>
      <div class="fuel-cell header">Price $/gal</div>
      <div class="fuel-cell header">vs U.S. Avg</div>
      <div class="fuel-cell header">Trend</div>
    </div>
  `;

  const usAvg = regions['U.S.'] || 3.78;

  keys.forEach(k => {
    const val = regions[k];
    const diff = val - usAvg;
    const diffStr = k === 'U.S.' ? 'BASELINE' : (diff > 0 ? `+$${diff.toFixed(3)}` : `-$${Math.abs(diff).toFixed(3)}`);
    const diffCls = diff > 0.1 ? 'val-high' : diff < -0.1 ? 'val-low' : '';
    const pct = ((val / max) * 80).toFixed(0);
    html += `
      <div class="fuel-row">
        <div class="fuel-cell"><span class="state">${dieselLabel(k)}</span></div>
        <div class="fuel-cell" style="color:#60c8f5;">$${val.toFixed(3)}</div>
        <div class="fuel-cell ${diffCls}">${diffStr}</div>
        <div class="fuel-cell">
          <div class="mini-bar" style="max-width:100px;">
            <div class="mini-bar-fill ${diff > 0.1 ? 'high' : diff < -0.1 ? 'low' : 'med'}" style="width:${pct}%"></div>
          </div>
        </div>
      </div>
    `;
  });

  container.innerHTML = html;
}

// ============================================================
// RENDER CHARTS
// ============================================================
function renderCharts() {
  const labels = STATES.map(s => s.code);
  const elecVals = STATES.map(s => DATA.electricity[s.code] || 0);
  const gasVals = STATES.map(s => DATA.gas[s.code] || 0);
  const accentColor = '#f59e0b';
  const blueColor = '#38bdf8';

  // Overview electricity
  buildChart('elec-chart', 'bar', labels, [{
    label: '¢/kWh',
    data: elecVals,
    backgroundColor: elecVals.map(v => v > 18 ? 'rgba(242,85,85,0.75)' : v < 11 ? 'rgba(46,219,110,0.75)' : 'rgba(96,200,245,0.65)'),
    borderColor: elecVals.map(v => v > 18 ? '#f25555' : v < 11 ? '#2edb6e' : '#60c8f5'),
    borderWidth: 1,
  }]);

  // Full electricity chart
  buildChart('elec-chart-full', 'bar', labels, [{
    label: 'Electricity ¢/kWh',
    data: elecVals,
    backgroundColor: elecVals.map(v => v > 18 ? 'rgba(242,85,85,0.75)' : v < 11 ? 'rgba(46,219,110,0.75)' : 'rgba(96,200,245,0.65)'),
    borderColor: elecVals.map(v => v > 18 ? '#f25555' : v < 11 ? '#2edb6e' : '#60c8f5'),
    borderWidth: 1,
  }]);

  // Full gas chart
  buildChart('gas-chart-full', 'bar', labels, [{
    label: 'Natural Gas $/MCF',
    data: gasVals,
    backgroundColor: 'rgba(96,200,245,0.5)',
    borderColor: '#60c8f5',
    borderWidth: 1,
  }]);

  // Gas bar (fuel tab)
  buildChart('gas-bar-chart', 'bar', labels, [{
    label: '$/MCF',
    data: gasVals,
    backgroundColor: 'rgba(96,200,245,0.5)',
    borderColor: '#60c8f5',
    borderWidth: 1,
  }]);

  // Diesel charts — use friendly region names
  const dieselRegions = DATA.diesel.regions || {};
  const dKeys = Object.keys(dieselRegions).slice(0, 8);
  const dLabels = dKeys.map(dieselLabel);
  const dVals = dKeys.map(k => dieselRegions[k]);
  buildChart('diesel-chart', 'bar', dLabels, [{
    label: '$/gallon',
    data: dVals,
    backgroundColor: 'rgba(96,200,245,0.5)',
    borderColor: '#60c8f5',
    borderWidth: 1,
  }]);

  buildChart('diesel-trend-chart', 'bar', dLabels, [{
    label: '$/gallon',
    data: dVals,
    backgroundColor: 'rgba(96,200,245,0.5)',
    borderColor: '#60c8f5',
    borderWidth: 1,
  }]);

  // Overview cards
  const elecAvg = elecVals.filter(Boolean).reduce((a,b) => a+b, 0) / elecVals.filter(Boolean).length;
  const gasAvg = gasVals.filter(Boolean).reduce((a,b) => a+b, 0) / gasVals.filter(Boolean).length;
  const usD = dieselRegions['U.S.'] || dieselRegions['East Coast'] || 3.78;

  if ($('ov-elec-avg')) {
    $('ov-elec-avg').textContent = elecAvg.toFixed(1) + '¢';
    $('ov-elec-sub').textContent = `EIA monthly avg across ${elecVals.filter(Boolean).length} states`;
  }
  if ($('ov-gas-avg')) {
    $('ov-gas-avg').textContent = '$' + gasAvg.toFixed(2);
    $('ov-gas-sub').textContent = 'EIA citygate avg across monitored states';
  }
  if ($('ov-diesel-avg')) {
    $('ov-diesel-avg').textContent = '$' + usD.toFixed(3);
    $('ov-diesel-sub').textContent = 'EIA weekly US national average';
  }
}

// ============================================================
// TAB SWITCHING
// ============================================================
function switchTab(name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  event.target.classList.add('active');
  $('tab-' + name).classList.add('active');

  if (name === 'news' && DATA.news.length === 0) loadAllNews();
  if (name === 'weather' && CONFIG.OPENWEATHER_KEY && Object.keys(DATA.weather).length === 0) {
    loadWeather(CONFIG.OPENWEATHER_KEY);
  }
}

// ============================================================
// MAIN INIT
// ============================================================
async function init() {
  await Promise.allSettled([
    loadElectricityData(),
    loadGasData(),
    loadDieselData(),
    loadGridData(),
  ]);

  // Update status pills based on actual data
  const eiaOk = Object.keys(DATA.electricity).length > 0;
  updateStatusPill('pill-eia', eiaOk, `EIA DATA: ${eiaOk ? 'CONNECTED' : 'ESTIMATES'}`);
  const gridOk = Object.values(GRID_DATA).some(d => !d.simulated);
  updateStatusPill('pill-grid', gridOk, `GRID DATA: ${gridOk ? 'LIVE' : 'ESTIMATED'}`);

  setLastUpdated();
  renderCharts();
  buildEnergyTable();
  buildDieselTable();
  buildGridCards('overview-grid-cards');

  // Weather — key is baked in
  if (CONFIG.OPENWEATHER_KEY) {
    updateStatusPill('pill-weather', null, 'WEATHER: LOADING...');
    loadWeather(CONFIG.OPENWEATHER_KEY).then(() => {
      updateStatusPill('pill-weather', true, 'WEATHER: LIVE');
    }).catch(() => {
      updateStatusPill('pill-weather', false, 'WEATHER: ERROR');
    });
  }

  // News — runs both feeds in parallel
  loadAllNews().then(() => {
    updateStatusPill('pill-news', DATA.news.length > 0, `NEWS: ${DATA.news.length > 0 ? 'LIVE' : 'SAMPLE'}`);
  });
}

async function refreshAll() {
  DATA.electricity = {};
  DATA.gas = {};
  DATA.diesel = {};
  await init();
}

init();
</script>

</body>
</html>