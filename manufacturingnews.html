<!DOCTYPE html>

<html lang="en" style="background:#060a0d;color:#ffffff;">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="color-scheme" content="dark">
<meta name="theme-color" content="#060a0d">
<title>OPS INTELLIGENCE — Energy & Regulatory Dashboard</title>
<!-- Fonts with robust fallback chain — loads async so layout never blocks -->
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link media="print" onload="this.media='all'" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@300;400;600;700;900&family=Barlow:wght@300;400;500&display=swap">
<noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@300;400;600;700;900&family=Barlow:wght@300;400;500&display=swap"></noscript>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
  /* ===== HARDCODED DARK BASE — iOS Safari compatible ===== */
  /* All critical colors are hardcoded, not just variable references */
  html {
    background: #060a0d !important;
    color-scheme: dark;
    -webkit-text-size-adjust: 100%;
  }
  body {
    background: #060a0d !important;
    color: #ffffff !important;
    margin: 0;
    padding: 0;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
  }
  /* Prevent any white flash */
  html, body, main, nav, header, footer {
    background-color: #060a0d;
  }

:root {
–bg-primary: #060a0d;
–bg-secondary: #0b1015;
–bg-card: #0f1720;
–bg-card-hover: #141e2a;
–border: #1e3348;
–border-bright: #2d4d6e;
–accent: #60c8f5;
–accent-dim: #2d8bbf;
–accent-glow: rgba(96,200,245,0.15);
–caution: #f59e0b;
–caution-dim: #b45309;
–green: #2edb6e;
–green-dim: #17914a;
–red: #f25555;
–red-dim: #b02020;
–blue: #60c8f5;
–blue-dim: #2d8bbf;
–text-primary: #ffffff;
–text-secondary: #c2d4e8;
–text-dim: #6b8aaa;
/* Font stack: web font → system condensed → system default */
–mono: ‘Share Tech Mono’, ‘Courier New’, Courier, monospace;
–display: ‘Barlow Condensed’, ‘Arial Narrow’, Arial, sans-serif;
–body: ‘Barlow’, -apple-system, BlinkMacSystemFont, ‘Segoe UI’, Arial, sans-serif;
}

- { margin: 0; padding: 0; box-sizing: border-box; }

body {
background: #060a0d;
color: #ffffff;
font-family: ‘Barlow’, -apple-system, BlinkMacSystemFont, ‘Segoe UI’, Arial, sans-serif;
font-size: 17px;
overflow-x: hidden;
}

/* Scanline overlay */
body::before {
content: ‘’;
position: fixed;
inset: 0;
background: repeating-linear-gradient(
0deg,
transparent,
transparent 2px,
rgba(0,0,0,0.03) 2px,
rgba(0,0,0,0.03) 4px
);
pointer-events: none;
z-index: 1000;
}

/* Grid noise texture */
body::after {
content: ‘’;
position: fixed;
inset: 0;
background-image: url(“data:image/svg+xml,%3Csvg viewBox=‘0 0 200 200’ xmlns=‘http://www.w3.org/2000/svg’%3E%3Cfilter id=‘n’%3E%3CfeTurbulence type=‘fractalNoise’ baseFrequency=‘0.65’ numOctaves=‘3’ stitchTiles=‘stitch’/%3E%3C/filter%3E%3Crect width=‘100%25’ height=‘100%25’ filter=‘url(%23n)’ opacity=‘0.03’/%3E%3C/svg%3E”);
opacity: 0.4;
pointer-events: none;
z-index: 999;
}

/* –– HEADER –– */
header {
display: flex;
align-items: center;
justify-content: space-between;
padding: 18px 32px;
border-bottom: 2px solid var(–accent);
background: linear-gradient(180deg, rgba(96,200,245,0.12) 0%, rgba(6,10,13,0.98) 100%);
position: sticky;
top: 0;
z-index: 100;
backdrop-filter: blur(12px);
box-shadow: 0 4px 32px rgba(96,200,245,0.08);
}

.logo-block {
display: flex;
align-items: center;
gap: 16px;
}

.logo-icon {
width: 36px;
height: 36px;
border: 2px solid var(–accent);
display: grid;
grid-template-columns: 1fr 1fr;
gap: 3px;
padding: 4px;
animation: pulse-border 3s ease-in-out infinite;
}

.logo-icon span {
background: var(–accent);
display: block;
}
.logo-icon span:nth-child(2) { background: var(–accent-dim); }
.logo-icon span:nth-child(3) { background: var(–accent-dim); }

@keyframes pulse-border {
0%, 100% { box-shadow: 0 0 8px rgba(96,200,245,0.4); }
50% { box-shadow: 0 0 22px rgba(96,200,245,0.7); }
}

.logo-text {
font-family: var(–display);
font-weight: 900;
font-size: 30px;
letter-spacing: 4px;
text-transform: uppercase;
color: var(–text-primary);
line-height: 1.1;
}

.logo-sub {
font-family: var(–mono);
font-size: 13px;
color: var(–accent);
letter-spacing: 3px;
text-transform: uppercase;
opacity: 0.85;
}

.header-right {
display: flex;
align-items: center;
gap: 28px;
}

.live-indicator {
display: flex;
align-items: center;
gap: 8px;
font-family: var(–mono);
font-size: 15px;
color: var(–green);
letter-spacing: 3px;
font-weight: bold;
}

.live-dot {
width: 11px;
height: 11px;
background: var(–green);
border-radius: 50%;
animation: blink 1.5s ease-in-out infinite;
box-shadow: 0 0 10px var(–green);
}

@keyframes blink {
0%, 100% { opacity: 1; }
50% { opacity: 0.2; }
}

#clock {
font-family: var(–mono);
letter-spacing: 2px;
}

.states-badge {
font-family: var(–mono);
font-size: 13px;
color: var(–accent);
border: 1px solid var(–accent);
padding: 6px 14px;
letter-spacing: 1px;
background: rgba(96,200,245,0.07);
white-space: nowrap;
}

/* –– NAV TABS –– */
nav {
display: flex;
gap: 0;
border-bottom: 1px solid #1e3348;
padding: 0 32px;
background: #0b1015;
overflow-x: auto;
-webkit-overflow-scrolling: touch;
scrollbar-width: none;
}
nav::-webkit-scrollbar { display: none; }

.tab {
font-family: ‘Barlow Condensed’, ‘Arial Narrow’, Arial, sans-serif;
font-weight: 600;
font-size: 17px;
letter-spacing: 2px;
text-transform: uppercase;
color: #6b8aaa;
padding: 14px 26px;
cursor: pointer;
border-bottom: 2px solid transparent;
transition: all 0.2s;
background: none;
border-top: none;
border-left: none;
border-right: none;
white-space: nowrap;
-webkit-tap-highlight-color: transparent;
}

.tab:hover { color: #c2d4e8; }
.tab.active {
color: #60c8f5;
border-bottom-color: #60c8f5;
}

/* –– MAIN LAYOUT –– */
main {
padding: 24px 32px;
max-width: 1600px;
margin: 0 auto;
background: #060a0d;
min-height: calc(100vh - 120px);
}

.section { display: none; background: #060a0d; }
.section.active { display: block; background: #060a0d; }

/* –– STATUS BAR –– */
.status-bar {
display: flex;
gap: 12px;
margin-bottom: 24px;
flex-wrap: wrap;
}

.status-pill {
font-family: ‘Share Tech Mono’, ‘Courier New’, monospace;
font-size: 14px;
letter-spacing: 1.5px;
padding: 7px 16px;
border: 1px solid #2d4d6e;
background: #0f1720;
color: #c2d4e8;
display: flex;
align-items: center;
gap: 8px;
}

.status-pill .dot {
width: 8px;
height: 8px;
border-radius: 50%;
background: #2edb6e;
flex-shrink: 0;
}

.status-pill .dot.warn { background: #f59e0b; }
.status-pill .dot.off { background: #6b8aaa; }

/* –– GRID SYSTEMS –– */
.grid-4 {
display: grid;
grid-template-columns: repeat(4, 1fr);
gap: 16px;
margin-bottom: 24px;
}

.grid-3 {
display: grid;
grid-template-columns: repeat(3, 1fr);
gap: 16px;
margin-bottom: 24px;
}

.grid-2 {
display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 16px;
margin-bottom: 24px;
}

.grid-2-1 {
display: grid;
grid-template-columns: 2fr 1fr;
gap: 16px;
margin-bottom: 24px;
}

.col-span-2 { grid-column: span 2; }
.col-span-3 { grid-column: span 3; }
.col-span-4 { grid-column: span 4; }

/* –– CARDS –– */
.card {
background: #0f1720;
border: 1px solid #1e3348;
padding: 20px;
position: relative;
overflow: hidden;
transition: border-color 0.2s, background 0.2s;
}

.card::before {
content: ‘’;
position: absolute;
top: 0; left: 0; right: 0;
height: 2px;
background: linear-gradient(90deg, transparent, #2d8bbf, transparent);
opacity: 0.5;
}

.card:hover {
border-color: #2d4d6e;
background: #141e2a;
}

.card-label {
font-family: ‘Share Tech Mono’, ‘Courier New’, monospace;
font-size: 14px;
letter-spacing: 3px;
text-transform: uppercase;
color: #c2d4e8;
margin-bottom: 12px;
display: flex;
align-items: center;
justify-content: space-between;
}

.card-label .unit { color: #60c8f5; font-size: 13px; }

.card-value {
font-family: var(–display);
font-size: 55px;
font-weight: 700;
line-height: 1;
color: var(–text-primary);
margin-bottom: 8px;
}

.card-value.large { font-size: 67px; }
.card-value.small { font-size: 39px; }

.card-sub {
font-family: var(–mono);
font-size: 15px;
color: var(–text-secondary);
letter-spacing: 1px;
}

.card-delta {
font-family: var(–mono);
font-size: 15px;
margin-top: 6px;
}

.card-delta.up { color: var(–red); }
.card-delta.down { color: var(–green); }
.card-delta.neutral { color: var(–text-dim); }

/* –– SECTION HEADER –– */
.section-header {
display: flex;
align-items: baseline;
gap: 16px;
margin-bottom: 20px;
padding-bottom: 12px;
border-bottom: 1px solid var(–border);
}

.section-title {
font-family: var(–display);
font-weight: 900;
font-size: 37px;
letter-spacing: 3px;
text-transform: uppercase;
color: var(–text-primary);
}

.section-title span { color: var(–accent); }

.section-meta {
font-family: var(–mono);
font-size: 14px;
color: var(–text-dim);
letter-spacing: 2px;
}

.refresh-btn {
margin-left: auto;
background: none;
border: 1px solid var(–border-bright);
color: var(–text-secondary);
font-family: var(–mono);
font-size: 14px;
letter-spacing: 2px;
padding: 8px 16px;
cursor: pointer;
transition: all 0.2s;
text-transform: uppercase;
}

.refresh-btn:hover {
border-color: var(–accent);
color: var(–accent);
}

/* –– CHART CARDS –– */
.chart-card {
background: var(–bg-card);
border: 1px solid var(–border);
padding: 20px;
position: relative;
}

.chart-card::before {
content: ‘’;
position: absolute;
top: 0; left: 0; right: 0;
height: 2px;
background: linear-gradient(90deg, transparent, var(–accent-dim), transparent);
opacity: 0.5;
}

.chart-title {
font-family: var(–display);
font-weight: 700;
font-size: 23px;
letter-spacing: 2px;
text-transform: uppercase;
color: var(–text-primary);
margin-bottom: 4px;
}

.chart-subtitle {
font-family: var(–mono);
font-size: 14px;
color: var(–text-secondary);
letter-spacing: 1.5px;
margin-bottom: 18px;
}

/* –– STATE TABLE –– */
.state-table {
width: 100%;
border-collapse: collapse;
font-family: var(–mono);
font-size: 16px;
}

.state-table th {
font-family: var(–display);
font-weight: 600;
font-size: 15px;
letter-spacing: 2px;
text-transform: uppercase;
color: var(–text-secondary);
text-align: left;
padding: 10px 16px;
border-bottom: 1px solid var(–border-bright);
}

.state-table td {
padding: 13px 16px;
border-bottom: 1px solid rgba(30,51,72,0.6);
color: var(–text-secondary);
transition: background 0.15s;
}

.state-table tr:hover td { background: rgba(96,200,245,0.04); }

.state-table .state-name {
color: var(–text-primary);
font-family: var(–display);
font-weight: 600;
font-size: 18px;
letter-spacing: 1px;
}

.state-table .val-highlight {
color: var(–accent);
font-weight: bold;
}

.state-table .val-high { color: var(–red); }
.state-table .val-low { color: var(–green); }

.bar-cell {
display: flex;
align-items: center;
gap: 8px;
}

.mini-bar {
height: 6px;
background: var(–border);
flex: 1;
max-width: 80px;
position: relative;
overflow: hidden;
}

.mini-bar-fill {
height: 100%;
background: var(–accent);
transition: width 1s ease;
}

.mini-bar-fill.high { background: var(–red); }
.mini-bar-fill.low { background: var(–green); }
.mini-bar-fill.med { background: var(–blue); }

/* –– GRID STATUS CARDS –– */
.grid-status-card {
background: var(–bg-card);
border: 1px solid var(–border);
padding: 16px;
display: flex;
flex-direction: column;
gap: 10px;
}

.grid-region-name {
font-family: var(–display);
font-weight: 700;
font-size: 25px;
letter-spacing: 2px;
text-transform: uppercase;
}

.grid-states-covered {
font-family: var(–mono);
font-size: 14px;
color: var(–text-secondary);
letter-spacing: 1px;
}

.grid-load-bar {
height: 8px;
background: var(–border);
position: relative;
overflow: hidden;
}

.grid-load-fill {
height: 100%;
transition: width 1.5s ease;
position: relative;
}

.grid-load-fill::after {
content: ‘’;
position: absolute;
right: 0;
top: -2px;
bottom: -2px;
width: 3px;
background: white;
opacity: 0.8;
box-shadow: 0 0 6px white;
}

.grid-load-fill.normal { background: linear-gradient(90deg, #17914a, #2edb6e); }
.grid-load-fill.elevated { background: linear-gradient(90deg, #b45309, #f59e0b); }
.grid-load-fill.high { background: linear-gradient(90deg, #b02020, #f25555); }

.grid-metrics {
display: flex;
justify-content: space-between;
font-family: var(–mono);
font-size: 15px;
color: var(–text-secondary);
}

.grid-metrics .metric-val {
color: var(–text-primary);
font-size: 20px;
display: block;
}

.grid-link {
font-family: var(–mono);
font-size: 14px;
color: var(–accent);
text-decoration: none;
letter-spacing: 1.5px;
border: 1px solid var(–accent-dim);
padding: 7px 14px;
display: inline-block;
transition: all 0.2s;
text-transform: uppercase;
}

.grid-link:hover {
background: var(–accent-glow);
border-color: var(–accent);
}

/* –– NEWS CARDS –– */
.news-grid {
display: grid;
grid-template-columns: repeat(3, 1fr);
gap: 16px;
}

.news-card {
background: var(–bg-card);
border: 1px solid var(–border);
padding: 16px;
display: flex;
flex-direction: column;
gap: 10px;
transition: all 0.2s;
text-decoration: none;
color: inherit;
position: relative;
overflow: hidden;
}

.news-card::after {
content: ‘’;
position: absolute;
bottom: 0;
left: 0;
right: 0;
height: 1px;
background: linear-gradient(90deg, transparent, var(–accent-dim), transparent);
transform: scaleX(0);
transition: transform 0.3s;
}

.news-card:hover {
border-color: var(–border-bright);
background: var(–bg-card-hover);
}

.news-card:hover::after { transform: scaleX(1); }

.news-source {
font-family: var(–mono);
font-size: 13px;
letter-spacing: 2px;
text-transform: uppercase;
color: var(–accent);
}

.news-title {
font-family: var(–display);
font-weight: 600;
font-size: 21px;
line-height: 1.3;
color: var(–text-primary);
}

.news-desc {
font-size: 16px;
color: var(–text-secondary);
line-height: 1.6;
flex: 1;
}

.news-date {
font-family: var(–mono);
font-size: 14px;
color: var(–text-dim);
}

.news-arrow {
font-size: 26px;
color: var(–accent-dim);
align-self: flex-end;
transition: transform 0.2s, color 0.2s;
}

.news-card:hover .news-arrow {
transform: translate(4px, -4px);
color: var(–accent);
}

/* –– WEATHER CARDS –– */
.weather-grid {
display: grid;
grid-template-columns: repeat(4, 1fr);
gap: 12px;
}

.weather-card {
background: var(–bg-card);
border: 1px solid var(–border);
padding: 16px;
}

.weather-state {
font-family: var(–display);
font-weight: 700;
font-size: 25px;
letter-spacing: 2px;
text-transform: uppercase;
margin-bottom: 8px;
}

.weather-temp {
font-family: var(–display);
font-size: 51px;
font-weight: 900;
color: var(–accent);
line-height: 1;
}

.weather-desc {
font-family: var(–mono);
font-size: 14px;
color: var(–text-secondary);
text-transform: uppercase;
letter-spacing: 1px;
margin-top: 8px;
}

.weather-details {
display: flex;
gap: 14px;
margin-top: 12px;
font-family: var(–mono);
font-size: 14px;
color: var(–text-secondary);
}

.weather-loading {
font-family: var(–mono);
font-size: 15px;
color: var(–text-dim);
padding: 28px;
text-align: center;
border: 1px dashed var(–border-bright);
letter-spacing: 2px;
}

/* –– FUEL / GAS TABLE –– */
.fuel-row {
display: grid;
grid-template-columns: 1fr 1fr 1fr 1fr;
gap: 1px;
background: var(–border);
margin-bottom: 1px;
}

.fuel-cell {
background: var(–bg-card);
padding: 14px 18px;
font-family: var(–mono);
font-size: 16px;
color: var(–text-secondary);
transition: background 0.15s;
}

.fuel-row:hover .fuel-cell { background: var(–bg-card-hover); }
.fuel-cell.header {
background: var(–bg-secondary);
font-family: var(–display);
font-weight: 600;
font-size: 15px;
letter-spacing: 2px;
text-transform: uppercase;
color: var(–text-secondary);
}

.fuel-cell .state { color: var(–text-primary); font-weight: bold; font-size: 18px; }

/* –– LOADING SPINNER –– */
.loading {
display: flex;
align-items: center;
justify-content: center;
padding: 40px;
gap: 14px;
font-family: var(–mono);
font-size: 16px;
color: var(–text-secondary);
letter-spacing: 2px;
}

.spinner {
width: 22px;
height: 22px;
border: 2px solid var(–border-bright);
border-top-color: var(–accent);
border-radius: 50%;
animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

/* –– ERROR STATE –– */
.error-state {
font-family: var(–mono);
font-size: 11px;
color: var(–red);
padding: 16px;
border: 1px solid var(–red-dim);
background: rgba(239,68,68,0.05);
letter-spacing: 1px;
}

/* –– API NOTE BANNER –– */
.api-note {
background: rgba(96,200,245,0.05);
border: 1px solid var(–accent-dim);
border-left: 3px solid var(–accent);
padding: 14px 18px;
font-family: var(–mono);
font-size: 15px;
color: var(–text-secondary);
letter-spacing: 1px;
margin-bottom: 20px;
line-height: 1.7;
}

.api-note strong { color: var(–accent); }

/* –– TOOLTIP –– */
.tooltip {
position: relative;
cursor: help;
}

.tooltip-text {
display: none;
position: absolute;
bottom: calc(100% + 8px);
left: 50%;
transform: translateX(-50%);
background: var(–bg-secondary);
border: 1px solid var(–border-bright);
padding: 8px 12px;
font-family: var(–mono);
font-size: 10px;
color: var(–text-secondary);
white-space: nowrap;
z-index: 200;
letter-spacing: 1px;
}

.tooltip:hover .tooltip-text { display: block; }

/* –– DIVIDER –– */
.divider {
height: 1px;
background: linear-gradient(90deg, transparent, var(–border), transparent);
margin: 24px 0;
}

/* –– FOOTER –– */
footer {
margin-top: 40px;
padding: 20px 32px;
border-top: 1px solid var(–border);
display: flex;
justify-content: space-between;
align-items: center;
font-family: var(–mono);
font-size: 14px;
color: var(–text-secondary);
letter-spacing: 1.5px;
}

/* –– REGION BADGE –– */
.region-badge {
display: inline-block;
font-family: var(–mono);
font-size: 9px;
letter-spacing: 1.5px;
padding: 2px 7px;
border: 1px solid var(–border);
color: var(–text-dim);
text-transform: uppercase;
margin-right: 4px;
margin-bottom: 4px;
}

/* –– NEWS SUB-TABS –– */
.news-subtab-bar {
display: flex;
gap: 0;
border-bottom: 1px solid var(–border-bright);
margin-bottom: 24px;
}

.news-subtab {
font-family: var(–mono);
font-size: 14px;
letter-spacing: 2px;
text-transform: uppercase;
color: var(–text-dim);
padding: 12px 28px;
background: none;
border: none;
border-bottom: 3px solid transparent;
cursor: pointer;
transition: all 0.2s;
white-space: nowrap;
}
.news-subtab:hover { color: var(–text-secondary); }
.news-subtab.active {
color: var(–accent);
border-bottom-color: var(–accent);
background: rgba(96,200,245,0.04);
}

.news-subtab-content { display: none; }
.news-subtab-content.active { display: block; }

/* –– TOOLTIP –– */
.has-tooltip { position: relative; display: inline-flex; align-items: center; gap: 4px; cursor: help; }
.tooltip-icon {
width: 14px; height: 14px; border-radius: 50%;
background: #2d4d6e; color: #60c8f5;
font-family: ‘Share Tech Mono’,‘Courier New’,monospace;
font-size: 9px; display: inline-flex; align-items: center; justify-content: center;
flex-shrink: 0; line-height: 1;
}
.tooltip-box {
display: none;
position: absolute;
bottom: calc(100% + 8px);
left: 0;
width: 270px;
background: #0b1015;
border: 1px solid #2d4d6e;
padding: 10px 12px;
font-family: ‘Share Tech Mono’,‘Courier New’,monospace;
font-size: 11px;
color: #c2d4e8;
letter-spacing: 0.5px;
line-height: 1.6;
z-index: 200;
pointer-events: none;
}
.has-tooltip:hover .tooltip-box,
.has-tooltip:focus-within .tooltip-box { display: block; }

/* –– STATUS THRESHOLDS LEGEND –– */
.status-legend {
display: flex;
gap: 0;
border: 1px solid #1e3348;
margin-bottom: 20px;
overflow: hidden;
}
.legend-item {
flex: 1;
padding: 10px 14px;
border-right: 1px solid #1e3348;
}
.legend-item:last-child { border-right: none; }
.legend-label {
font-family: ‘Barlow Condensed’,‘Arial Narrow’,Arial,sans-serif;
font-weight: 700;
font-size: 15px;
letter-spacing: 2px;
text-transform: uppercase;
margin-bottom: 4px;
}
.legend-rules {
font-family: ‘Share Tech Mono’,‘Courier New’,monospace;
font-size: 11px;
color: #6b8aaa;
letter-spacing: 0.5px;
line-height: 1.5;
}

/* –– OFFICIAL RESERVES ROW –– */
.official-reserves-row {
margin-top: 8px;
padding: 8px 10px;
background: rgba(96,200,245,0.04);
border: 1px solid #1e3348;
border-left: 3px solid #60c8f5;
font-family: ‘Share Tech Mono’,‘Courier New’,monospace;
font-size: 11px;
color: #6b8aaa;
letter-spacing: 0.5px;
line-height: 1.6;
}
.official-reserves-row a {
color: #60c8f5;
text-decoration: none;
letter-spacing: 1px;
}
.official-reserves-row a:hover { text-decoration: underline; }
.official-reserves-val {
font-size: 13px;
color: #c2d4e8;
font-weight: bold;
}

/* –– ISO TABS –– */
.iso-tab {
font-family: var(–mono);
font-size: 12px;
letter-spacing: 2px;
text-transform: uppercase;
color: var(–text-dim);
padding: 8px 16px;
background: var(–bg-card);
border: 1px solid var(–border);
cursor: pointer;
transition: all 0.2s;
}
.iso-tab:hover { border-color: var(–border-bright); color: var(–text-secondary); }
.iso-tab.active { border-color: var(–accent); color: var(–accent); background: var(–accent-glow); }

/* –– FUEL MIX BAR –– */
.fuel-mix-bar {
display: flex;
height: 12px;
border-radius: 2px;
overflow: hidden;
margin: 8px 0;
gap: 1px;
}
.fuel-mix-segment {
height: 100%;
transition: flex 0.8s ease;
position: relative;
}
.fuel-mix-legend {
display: flex;
flex-wrap: wrap;
gap: 10px;
margin-top: 8px;
font-family: var(–mono);
font-size: 11px;
color: var(–text-secondary);
}
.fuel-mix-legend-item {
display: flex;
align-items: center;
gap: 5px;
}
.fuel-mix-dot {
width: 9px;
height: 9px;
border-radius: 50%;
flex-shrink: 0;
}

/* –– HOURLY SPARKLINE –– */
.sparkline-container {
height: 50px;
margin: 8px 0 4px;
}
.fade-in {
animation: fadeIn 0.4s ease forwards;
opacity: 0;
}

@keyframes fadeIn {
from { opacity: 0; transform: translateY(8px); }
to { opacity: 1; transform: translateY(0); }
}

.fade-in:nth-child(1) { animation-delay: 0.05s; }
.fade-in:nth-child(2) { animation-delay: 0.1s; }
.fade-in:nth-child(3) { animation-delay: 0.15s; }
.fade-in:nth-child(4) { animation-delay: 0.2s; }
.fade-in:nth-child(5) { animation-delay: 0.25s; }
.fade-in:nth-child(6) { animation-delay: 0.3s; }
.fade-in:nth-child(7) { animation-delay: 0.35s; }
.fade-in:nth-child(8) { animation-delay: 0.4s; }

/* –– CHART CARDS — explicit backgrounds –– */
.chart-card {
background: #0f1720;
border: 1px solid #1e3348;
padding: 20px;
position: relative;
}
.chart-card::before {
content: ‘’;
position: absolute;
top: 0; left: 0; right: 0;
height: 2px;
background: linear-gradient(90deg, transparent, #2d8bbf, transparent);
opacity: 0.5;
}

/* –– GRID STATUS CARDS — explicit backgrounds –– */
.grid-status-card {
background: #0f1720 !important;
border: 1px solid #1e3348 !important;
}

/* –– API NOTE / ERROR — explicit backgrounds –– */
.api-note {
background: #0a1520 !important;
border: 1px solid #2d4d6e !important;
color: #c2d4e8 !important;
}
.error-state {
background: rgba(178,32,32,0.15) !important;
border: 1px solid #b02020 !important;
color: #f25555 !important;
}

/* –– NEWS CARDS — explicit backgrounds –– */
.news-card {
background: #0f1720 !important;
border: 1px solid #1e3348 !important;
}
.news-card:hover { border-color: #2d4d6e !important; }

/* –– WEATHER CARDS — explicit backgrounds –– */
.weather-card {
background: #0f1720 !important;
border: 1px solid #1e3348 !important;
}

/* –– FOOTER –– */
footer {
background: #0b1015 !important;
border-top: 1px solid #1e3348 !important;
color: #6b8aaa !important;
}

/* –– RESPONSIVE: TABLET –– */
@media (max-width: 1100px) {
.grid-4 { grid-template-columns: repeat(2, 1fr); }
.grid-3 { grid-template-columns: repeat(2, 1fr); }
.weather-grid { grid-template-columns: repeat(3, 1fr); }
.news-grid { grid-template-columns: repeat(2, 1fr); }
}

/* –– RESPONSIVE: MOBILE –– */
@media (max-width: 768px) {
header {
padding: 12px 16px;
gap: 12px;
flex-wrap: nowrap;
}
.logo-text { font-size: 22px; letter-spacing: 2px; }
.logo-sub { font-size: 10px; letter-spacing: 2px; }
.logo-icon { width: 28px; height: 28px; }
.header-right { gap: 12px; }
.states-badge { font-size: 10px; padding: 4px 8px; }
#clock-time { font-size: 14px; }
#clock-tz { font-size: 10px; }

```
nav { padding: 0 8px; }
.tab { font-size: 13px; padding: 12px 14px; letter-spacing: 1px; }

main { padding: 12px 16px; background: #060a0d; }
.section { background: #060a0d; }

.grid-4,
.grid-3,
.grid-2,
.grid-2-1 { grid-template-columns: 1fr; }

.col-span-2,
.col-span-3,
.col-span-4 { grid-column: span 1; }

.card { padding: 16px; }
.card-value { font-size: 40px; }
.card-value.large { font-size: 48px; }

.weather-grid { grid-template-columns: repeat(2, 1fr); }
.news-grid { grid-template-columns: 1fr; }
.fuel-row { grid-template-columns: 1fr 1fr; }

.section-title { font-size: 28px; }
.section-header { flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }

.chart-card { padding: 14px; }
.chart-title { font-size: 18px; }

.status-pill { font-size: 12px; padding: 6px 12px; }

.grid-metrics { flex-direction: column; gap: 8px; }
.iso-tab { font-size: 11px; padding: 6px 12px; }
```

}

/* –– RESPONSIVE: SMALL MOBILE (≤390px iPhone SE etc) –– */
@media (max-width: 430px) {
.logo-text { font-size: 18px; }
.header-right { gap: 8px; }
.states-badge { display: none; }
.tab { font-size: 12px; padding: 10px 10px; }
main { padding: 10px 12px; }
}
/* –– PRECIPITATION TAB –– */
.precip-label {
font-family: ‘Share Tech Mono’,‘Courier New’,monospace;
font-size: 11px;
letter-spacing: 2px;
color: #6b8aaa;
text-transform: uppercase;
}
.precip-select, .precip-input {
font-family: ‘Share Tech Mono’,‘Courier New’,monospace;
font-size: 14px;
letter-spacing: 1px;
background: #060a0d;
color: #c2d4e8;
border: 1px solid #2d4d6e;
padding: 8px 12px;
outline: none;
min-width: 180px;
cursor: pointer;
-webkit-appearance: none;
appearance: none;
}
.precip-select:focus, .precip-input:focus {
border-color: #60c8f5;
color: #ffffff;
}
.precip-select:disabled {
opacity: 0.4;
cursor: not-allowed;
}
/* Override browser date input styling */
.precip-input[type=“date”]::-webkit-calendar-picker-indicator {
filter: invert(0.7) sepia(1) saturate(3) hue-rotate(170deg);
cursor: pointer;
}
.precip-submit {
font-family: ‘Share Tech Mono’,‘Courier New’,monospace;
font-size: 13px;
letter-spacing: 2px;
color: #060a0d;
background: #60c8f5;
border: none;
padding: 9px 24px;
cursor: pointer;
text-transform: uppercase;
transition: background 0.2s;
white-space: nowrap;
}
.precip-submit:hover { background: #93d9f8; }
.precip-submit:active { background: #2d8bbf; }

/* Precipitation results table */
.precip-table {
width: 100%;
border-collapse: collapse;
font-family: ‘Share Tech Mono’,‘Courier New’,monospace;
font-size: 14px;
}
.precip-table th {
font-family: ‘Barlow Condensed’,‘Arial Narrow’,Arial,sans-serif;
font-weight: 600;
font-size: 13px;
letter-spacing: 2px;
text-transform: uppercase;
color: #c2d4e8;
text-align: left;
padding: 10px 14px;
border-bottom: 1px solid #2d4d6e;
background: #0b1015;
white-space: nowrap;
}
.precip-table td {
padding: 9px 14px;
border-bottom: 1px solid rgba(30,51,72,0.6);
color: #c2d4e8;
}
.precip-table tr:hover td { background: rgba(96,200,245,0.04); }
.precip-table .precip-zero { color: #2d4d6e; }
.precip-table .precip-rain { color: #60c8f5; }
.precip-table .precip-snow { color: #a5d8ff; }
.precip-table .precip-total { color: #ffffff; font-weight: bold; }
.precip-table .totals-row td {
background: #0b1015;
border-top: 2px solid #2d4d6e;
border-bottom: none;
color: #60c8f5;
font-weight: bold;
font-size: 15px;
}
.precip-table-wrap {
border: 1px solid #1e3348;
overflow-x: auto;
-webkit-overflow-scrolling: touch;
margin-bottom: 24px;
}
</style>

</head>
<body>

<header>
  <div class="logo-block">
    <div class="logo-icon">
      <span></span><span></span><span></span><span></span>
    </div>
    <div>
      <div class="logo-text">OPS <span style="color:var(--accent)">INTELLIGENCE</span></div>
      <div class="logo-sub">Energy &amp; Regulatory Dashboard</div>
    </div>
  </div>
  <div class="header-right">
    <div class="live-indicator">
      <div class="live-dot"></div>
      LIVE
    </div>
    <div id="clock" style="display:flex;flex-direction:column;align-items:flex-end;gap:2px;">
      <div id="clock-time" style="font-family:var(--mono);font-size:19px;color:var(--text-primary);letter-spacing:2px;">--:--:--</div>
      <div id="clock-tz" style="font-family:var(--mono);font-size:11px;color:var(--accent);letter-spacing:2px;">--</div>
    </div>
    <div class="states-badge">13 STATES MONITORED</div>
  </div>
</header>

<nav>
  <button class="tab active" onclick="switchTab('overview')">Overview</button>
  <button class="tab" onclick="switchTab('grid')">Grid Status</button>
  <button class="tab" onclick="switchTab('energy')">Energy Pricing</button>
  <button class="tab" onclick="switchTab('weather')">Weather</button>
  <button class="tab" onclick="switchTab('precip')">Precipitation</button>
  <button class="tab" onclick="switchTab('news')">News &amp; Intelligence</button>
</nav>

<main>

  <!-- ======================== OVERVIEW ======================== -->

  <div id="tab-overview" class="section active">
    <div class="section-header">
      <div class="section-title">OPERATIONAL <span>OVERVIEW</span></div>
      <div class="section-meta">ALL MONITORED STATES // LIVE DATA</div>
      <button class="refresh-btn" onclick="refreshAll()">⟳ REFRESH ALL</button>
    </div>

```
<div class="status-bar" id="overview-status-bar">
  <div class="status-pill" id="pill-eia"><span class="dot"></span> EIA DATA: CONNECTING...</div>
  <div class="status-pill" id="pill-weather"><span class="dot warn"></span> WEATHER: CONNECTING...</div>
  <div class="status-pill" id="pill-news"><span class="dot"></span> NEWS FEED: CONNECTING...</div>
  <div class="status-pill" id="pill-grid"><span class="dot"></span> GRID DATA: CONNECTING...</div>
</div>

<!-- 1. Grid summary first -->
<div class="section-header" style="margin-top:8px;">
  <div class="section-title" style="font-size:20px;">GRID <span>ALERTS</span></div>
  <div class="section-meta">REGIONAL OPERATORS</div>
</div>
<div class="grid-4" id="overview-grid-cards">
  <div class="loading col-span-4"><div class="spinner"></div>LOADING GRID DATA...</div>
</div>

<!-- 2. Charts -->
<div class="grid-2" style="margin-top:8px;">
  <div class="chart-card fade-in">
    <div class="chart-title">Electricity Prices by State</div>
    <div class="chart-subtitle">RETAIL RATE ¢/kWh — EIA MONTHLY DATA</div>
    <canvas id="elec-chart" height="200"></canvas>
  </div>
  <div class="chart-card fade-in">
    <div class="chart-title">Diesel Fuel Prices by Region</div>
    <div class="chart-subtitle">WEEKLY RETAIL — EIA DATA</div>
    <canvas id="diesel-chart" height="200"></canvas>
  </div>
</div>

<!-- 3. Fact cards last -->
<div class="grid-4" style="margin-top:8px;">
  <div class="card fade-in">
    <div class="card-label">Avg. Retail Electricity <span class="unit">¢/kWh</span></div>
    <div class="card-value large" id="ov-elec-avg">—</div>
    <div class="card-sub" id="ov-elec-sub">Loading EIA data...</div>
  </div>
  <div class="card fade-in">
    <div class="card-label">Avg. Natural Gas Price <span class="unit">$/MCF</span></div>
    <div class="card-value large" id="ov-gas-avg">—</div>
    <div class="card-sub" id="ov-gas-sub">Loading EIA data...</div>
  </div>
  <div class="card fade-in">
    <div class="card-label">Avg. Diesel Price <span class="unit">$/GAL</span></div>
    <div class="card-value large" id="ov-diesel-avg">—</div>
    <div class="card-sub" id="ov-diesel-sub">Loading EIA data...</div>
  </div>
  <div class="card fade-in">
    <div class="card-label">Industry News Items <span class="unit">TODAY</span></div>
    <div class="card-value large" id="ov-news-count">—</div>
    <div class="card-sub">Plastics &amp; manufacturing regulatory</div>
  </div>
</div>
```

  </div>

  <!-- ======================== GRID STATUS ======================== -->

  <div id="tab-grid" class="section">
    <div class="section-header">
      <div class="section-title">GRID <span>STATUS</span></div>
      <div class="section-meta">EIA HOURLY RTO DATA + ISO OPERATOR LINKS</div>
      <button class="refresh-btn" onclick="loadGridData()">⟳ REFRESH</button>
    </div>
    <div class="api-note">
      <strong>DATA:</strong> Hourly demand and generation mix pulled from EIA Form EIA-930 (Electric Grid Monitor) for each ISO/RTO. 
      Load percentage = current demand vs. available capacity (forecast peak × target reserve margin). Fuel mix shows generation source breakdown. Click any operator name to view their live dashboard.
    </div>

```
<!-- Status thresholds legend -->
<div class="status-legend">
  <div class="legend-item" style="background:rgba(46,219,110,0.05);">
    <div class="legend-label" style="color:#2edb6e;">✓ NORMAL</div>
    <div class="legend-rules">Load &lt; 75% of available capacity<br>Reserve margin &gt; 25%</div>
  </div>
  <div class="legend-item" style="background:rgba(245,158,11,0.05);">
    <div class="legend-label" style="color:#f59e0b;">△ ELEVATED</div>
    <div class="legend-rules">Load 75–90% of available capacity<br>Reserve margin 10–25%</div>
  </div>
  <div class="legend-item" style="background:rgba(242,85,85,0.05);">
    <div class="legend-label" style="color:#f25555;">⚠ HIGH</div>
    <div class="legend-rules">Load ≥ 90% of available capacity<br>Reserve margin &lt; 10%</div>
  </div>
  <div class="legend-item" style="background:#0b1015;">
    <div class="legend-label" style="color:#6b8aaa;font-size:11px;letter-spacing:1px;">RESERVE NOTE</div>
    <div class="legend-rules">Our reserves = Available Capacity − Current Demand<br>ISO official reserves include non-spin &amp; DR (typically higher)</div>
  </div>
</div>

<!-- ISO selector tabs -->
<div style="display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap;" id="iso-tabs">
  <button class="iso-tab active" onclick="selectISO('ALL')">ALL REGIONS</button>
  <button class="iso-tab" onclick="selectISO('ERCO')">ERCOT</button>
  <button class="iso-tab" onclick="selectISO('PJM')">PJM</button>
  <button class="iso-tab" onclick="selectISO('MISO')">MISO</button>
  <button class="iso-tab" onclick="selectISO('CISO')">CAISO</button>
  <button class="iso-tab" onclick="selectISO('SOCO')">SERC/SE</button>
  <button class="iso-tab" onclick="selectISO('ISNE')">ISO-NE</button>
</div>

<!-- Summary stats row -->
<div class="grid-4" id="grid-summary-cards" style="margin-bottom:20px;">
  <div class="card"><div class="card-label">Total Monitored Demand <span class="unit">GW</span></div><div class="card-value small" id="gs-total-demand">—</div><div class="card-sub">Sum across all ISOs</div></div>
  <div class="card"><div class="card-label">Highest Load Region <span class="unit">ISO</span></div><div class="card-value small" id="gs-highest-iso">—</div><div class="card-sub" id="gs-highest-pct">—</div></div>
  <div class="card"><div class="card-label">Top Generation Source <span class="unit">MIX</span></div><div class="card-value small" id="gs-top-fuel">—</div><div class="card-sub" id="gs-top-fuel-pct">—</div></div>
  <div class="card"><div class="card-label">Grid Alerts <span class="unit">STATUS</span></div><div class="card-value small" id="gs-alerts" style="color:#2edb6e;">NORMAL</div><div class="card-sub">No active warnings</div></div>
</div>

<!-- Main ISO cards with fuel mix -->
<div class="grid-3" id="grid-cards-main">
  <div class="loading col-span-3"><div class="spinner"></div>FETCHING EIA GRID DATA...</div>
</div>

<!-- Fuel mix comparison chart -->
<div class="chart-card" style="margin-top:20px;">
  <div class="chart-title">Generation Fuel Mix — All ISOs</div>
  <div class="chart-subtitle">CURRENT HOUR BREAKDOWN BY SOURCE TYPE (EIA-930)</div>
  <canvas id="fuel-mix-chart" height="120"></canvas>
</div>
```

  </div>

  <!-- ======================== ENERGY PRICING ======================== -->

  <div id="tab-energy" class="section">
    <div class="section-header">
      <div class="section-title">ENERGY <span>PRICING</span></div>
      <div class="section-meta">EIA DATA // MONTHLY &amp; WEEKLY RETAIL RATES</div>
    </div>
    <div class="api-note">
      <strong>DATA SOURCE:</strong> U.S. Energy Information Administration (EIA) Open Data API.
      Electricity rates are monthly retail averages. Natural gas shown as citygate price (closest public proxy to industrial rates). Diesel shown as weekly retail regional averages.
    </div>

```
<!-- Electricity + Gas charts side by side -->
<div class="grid-2">
  <div class="chart-card">
    <div class="chart-title">Electricity — All States Compared</div>
    <div class="chart-subtitle">RETAIL RATE ¢/kWh</div>
    <canvas id="elec-chart-full" height="220"></canvas>
  </div>
  <div class="chart-card">
    <div class="chart-title">Natural Gas — Citygate Price</div>
    <div class="chart-subtitle">$/MCF (THOUSAND CUBIC FEET)</div>
    <canvas id="gas-chart-full" height="220"></canvas>
  </div>
</div>

<!-- Diesel regional chart + table side by side -->
<div class="section-header" style="margin-top:8px;margin-bottom:12px;border:none;padding:0;">
  <div class="section-title" style="font-size:20px;">DIESEL <span>PRICES</span></div>
  <div class="section-meta">$/GALLON WEEKLY — EIA REGIONAL DATA</div>
</div>
<div class="grid-2" style="align-items:start;">
  <div class="chart-card">
    <div class="chart-title">Regional Diesel — Weekly Prices</div>
    <div class="chart-subtitle">$/GALLON — EIA WEEKLY RETAIL BY REGION</div>
    <canvas id="diesel-trend-chart" height="220"></canvas>
  </div>
  <div id="diesel-table">
    <div class="loading"><div class="spinner"></div>LOADING...</div>
  </div>
</div>

<!-- State-by-state detail table -->
<div class="chart-card" style="margin-bottom:16px;">
  <div class="chart-title">State-by-State Pricing Detail</div>
  <div class="chart-subtitle">EIA MONTHLY — ELECTRICITY, NATURAL GAS, &amp; GRID OPERATOR</div>
  <div id="energy-table-container">
    <div class="loading"><div class="spinner"></div>FETCHING EIA DATA...</div>
  </div>
</div>
```

  </div>

  <!-- ======================== WEATHER ======================== -->

  <div id="tab-weather" class="section">
    <div class="section-header">
      <div class="section-title">WEATHER <span>CONDITIONS</span></div>
      <div class="section-meta">OPENWEATHERMAP API // CURRENT CONDITIONS</div>
    </div>
    <div id="weather-container">
      <div class="loading"><div class="spinner"></div>FETCHING WEATHER DATA...</div>
    </div>
  </div>

  <!-- ======================== PRECIPITATION ======================== -->

  <div id="tab-precip" class="section">
    <div class="section-header">
      <div class="section-title">PRECIPITATION <span>HISTORY</span></div>
      <div class="section-meta">OPEN-METEO HISTORICAL DATA // DAILY RAINFALL &amp; SNOWFALL</div>
    </div>
    <div class="api-note">
      <strong>DATA SOURCE:</strong> NOAA Global Historical Climatology Network Daily (GHCND) — actual weather station gauge observations. The nearest reporting station to the selected city is located automatically. Data typically available through 1–2 days prior to today. Rainfall and snowfall shown in inches.
    </div>

```
<!-- Query form -->
<div class="card" style="margin-bottom:20px;">
  <div style="display:flex;flex-wrap:wrap;gap:20px;align-items:flex-end;">

    <div style="display:flex;flex-direction:column;gap:6px;">
      <label class="precip-label" for="precip-state">STATE</label>
      <select id="precip-state" class="precip-select" onchange="precipPopulateCities()">
        <option value="">— Select State —</option>
      </select>
    </div>

    <div style="display:flex;flex-direction:column;gap:6px;">
      <label class="precip-label" for="precip-city">CITY</label>
      <select id="precip-city" class="precip-select" disabled>
        <option value="">— Select City —</option>
      </select>
    </div>

    <div style="display:flex;flex-direction:column;gap:6px;">
      <label class="precip-label" for="precip-start">START DATE</label>
      <input id="precip-start" class="precip-input" type="date">
    </div>

    <div style="display:flex;flex-direction:column;gap:6px;">
      <label class="precip-label" for="precip-end">END DATE</label>
      <input id="precip-end" class="precip-input" type="date">
    </div>

    <button class="precip-submit" onclick="runPrecipQuery()">▶ FETCH DATA</button>
  </div>
  <div id="precip-error" style="margin-top:12px;font-family:'Share Tech Mono','Courier New',monospace;font-size:12px;color:#f25555;letter-spacing:1px;display:none;"></div>
</div>

<!-- Results table -->
<div id="precip-results"></div>
```

  </div>

  <!-- ======================== NEWS ======================== -->

  <div id="tab-news" class="section">
    <div class="section-header">
      <div class="section-title">INDUSTRY <span>&amp; NEWS</span></div>
      <div class="section-meta">NEWSAPI.ORG // INDUSTRY INTELLIGENCE</div>
      <button class="refresh-btn" onclick="loadAllNews()">⟳ REFRESH</button>
    </div>

```
<!-- News sub-tabs -->
<div class="news-subtab-bar">
  <button class="news-subtab active" id="subtab-btn-plastics" onclick="switchNewsTab('plastics')">
    ♻ PLASTICS &amp; MANUFACTURING
  </button>
  <button class="news-subtab" id="subtab-btn-energy" onclick="switchNewsTab('energy')">
    ⚡ ENERGY &amp; SUPPLY CHAIN
  </button>
</div>

<!-- Plastics sub-tab -->
<div id="news-subtab-plastics" class="news-subtab-content active">
  <div class="api-note" style="margin-bottom:18px;">
    <strong>PLASTICS FOCUS:</strong> Industry developments, sustainability initiatives, recycling technology, 
    Operation Clean Sweep (OCS), pellet loss &amp; nurdle regulation, extended producer responsibility (EPR), 
    packaging legislation, and EPA rulemaking affecting plastic manufacturers.
  </div>
  <div id="news-plastics-container">
    <div class="loading"><div class="spinner"></div>FETCHING PLASTICS NEWS...</div>
  </div>
</div>

<!-- Energy sub-tab -->
<div id="news-subtab-energy" class="news-subtab-content">
  <div class="api-note" style="margin-bottom:18px;">
    <strong>ENERGY FOCUS:</strong> US electricity grid capacity and reliability, natural gas &amp; diesel supply chains, 
    FERC rulemakings, power market developments, renewable integration, fuel pricing trends, 
    and energy infrastructure news affecting industrial manufacturers.
  </div>
  <div id="news-energy-container">
    <div class="loading"><div class="spinner"></div>FETCHING ENERGY NEWS...</div>
  </div>
</div>
```

  </div>

</main>

<footer>
  <div>OPS INTELLIGENCE DASHBOARD // PROOF OF CONCEPT v1.0</div>
  <div id="last-updated">LAST UPDATED: —</div>
  <div>DATA: EIA.GOV · OPENWEATHERMAP · NEWSAPI.ORG</div>
</footer>

<script>
// ============================================================
// CONFIGURATION — Update keys here
// ============================================================
const CONFIG = {
  EIA_KEY: 'd5mGk3g798i3tz6XEj98mUEtlIvdLCflzebkQSyL',
  OPENWEATHER_KEY: 'd762abdc5a351a9585cab062b3c1f602',
  NEWS_KEY: 'd9f58cd1caa74bcfa1fb5998d3493a9f',
};

// Target states
const STATES = [
  { code: 'AL', name: 'Alabama',       region: 'Southeast' },
  { code: 'CA', name: 'California',    region: 'West'      },
  { code: 'FL', name: 'Florida',       region: 'Southeast' },
  { code: 'GA', name: 'Georgia',       region: 'Southeast' },
  { code: 'IA', name: 'Iowa',          region: 'Midwest'   },
  { code: 'IL', name: 'Illinois',      region: 'Midwest'   },
  { code: 'LA', name: 'Louisiana',     region: 'Southeast' },
  { code: 'MA', name: 'Massachusetts', region: 'Northeast' },
  { code: 'MD', name: 'Maryland',      region: 'Mid-Atlantic' },
  { code: 'MI', name: 'Michigan',      region: 'Midwest'   },
  { code: 'NJ', name: 'New Jersey',    region: 'Northeast' },
  { code: 'OH', name: 'Ohio',          region: 'Midwest'   },
  { code: 'TX', name: 'Texas',         region: 'South'     },
];

// State capitals for weather
const STATE_CITIES = {
  AL: { city: 'Montgomery', lat: 32.36, lon: -86.30 },
  CA: { city: 'Los Angeles', lat: 34.05, lon: -118.24 },
  FL: { city: 'Miami', lat: 25.77, lon: -80.19 },
  GA: { city: 'Atlanta', lat: 33.75, lon: -84.39 },
  IA: { city: 'Des Moines', lat: 41.59, lon: -93.62 },
  IL: { city: 'Chicago', lat: 41.88, lon: -87.63 },
  LA: { city: 'New Orleans', lat: 29.95, lon: -90.07 },
  MA: { city: 'Boston', lat: 42.36, lon: -71.06 },
  MD: { city: 'Baltimore', lat: 39.29, lon: -76.61 },
  MI: { city: 'Detroit', lat: 42.33, lon: -83.05 },
  NJ: { city: 'Newark', lat: 40.74, lon: -74.17 },
  OH: { city: 'Columbus', lat: 39.96, lon: -83.00 },
  TX: { city: 'Houston', lat: 29.76, lon: -95.37 },
};

// Maps state codes to their grid operator name (for the energy pricing table)
const GRID_REGIONS = [
  { name: 'ERCOT',   states: ['TX'] },
  { name: 'PJM',     states: ['MD','NJ','OH','IL'] },
  { name: 'MISO',    states: ['IA','IL','MI'] },
  { name: 'CAISO',   states: ['CA'] },
  { name: 'SERC',    states: ['AL','FL','GA','LA'] },
  { name: 'ISO-NE',  states: ['MA'] },
];

// ============================================================
// DATA CACHE
// ============================================================
const DATA = {
  electricity: {},
  gas: {},
  diesel: {},
  news: [],
  weather: {},
};

// ============================================================
// UTILITIES
// ============================================================
function $(id) { return document.getElementById(id); }

function updateClock() {
  const now = new Date();
  const timeStr = now.toLocaleTimeString('en-US', { hour12: false });
  // Get a clean short timezone abbreviation
  const tzFull = Intl.DateTimeFormat().resolvedOptions().timeZone || '';
  const tzParts = tzFull.split('/');
  const tzCity = tzParts[tzParts.length - 1].replace(/_/g, ' ');
  $('clock-time').textContent = timeStr;
  $('clock-tz').textContent = tzCity.toUpperCase();
}
setInterval(updateClock, 1000);
updateClock();

function updateStatusPill(id, ok, label) {
  const pill = $(id);
  if (!pill) return;
  const dot = pill.querySelector('.dot');
  if (dot) {
    dot.className = 'dot' + (ok === true ? '' : ok === false ? ' off' : ' warn');
  }
  pill.innerHTML = `<span class="dot${ok === true ? '' : ok === false ? ' off' : ' warn'}"></span> ${label}`;
}

function setLastUpdated() {
  $('last-updated').textContent = 'LAST UPDATED: ' + new Date().toLocaleString();
}

function getLoadClass(pct) {
  if (pct >= 90) return 'high';
  if (pct >= 75) return 'elevated';
  return 'normal';
}

function getLoadLabel(pct) {
  if (pct >= 90) return '⚠ HIGH';
  if (pct >= 75) return '△ ELEVATED';
  return '✓ NORMAL';
}

const CHART_DEFAULTS = {
  backgroundColor: 'transparent',
  plugins: {
    legend: { labels: { color: '#c2d4e8', font: { family: 'Share Tech Mono', size: 13 } } },
    tooltip: {
      backgroundColor: '#0b1015',
      borderColor: '#2d4d6e',
      borderWidth: 1,
      titleColor: '#60c8f5',
      bodyColor: '#c2d4e8',
      titleFont: { family: 'Barlow Condensed', size: 17, weight: '700' },
      bodyFont: { family: 'Share Tech Mono', size: 14 },
    }
  },
  scales: {
    x: {
      ticks: { color: '#8aaac8', font: { family: 'Share Tech Mono', size: 13 } },
      grid: { color: 'rgba(45,77,110,0.4)' },
    },
    y: {
      ticks: { color: '#8aaac8', font: { family: 'Share Tech Mono', size: 13 } },
      grid: { color: 'rgba(45,77,110,0.4)' },
    }
  }
};

// ============================================================
// CHART BUILDERS
// ============================================================
const charts = {};

function buildChart(id, type, labels, datasets, extraOpts = {}) {
  if (charts[id]) charts[id].destroy();
  const ctx = $(id);
  if (!ctx) return;
  charts[id] = new Chart(ctx, {
    type,
    data: { labels, datasets },
    options: { ...CHART_DEFAULTS, ...extraOpts, responsive: true, maintainAspectRatio: true }
  });
}

// ============================================================
// API HELPER — routes EIA through CORS proxy for GitHub Pages
// ============================================================
async function eiaFetch(url) {
  // Try direct first (works on localhost), fall back to proxy
  try {
    const res = await fetch(url, { mode: 'cors' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    if (json.response || json.data) return json;
    throw new Error('Bad response shape');
  } catch(e) {
    // Route through CORS proxy for GitHub Pages
    const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
    const res2 = await fetch(proxyUrl);
    if (!res2.ok) throw new Error(`Proxy HTTP ${res2.status}`);
    return await res2.json();
  }
}

// ============================================================
// ELECTRICITY DATA (EIA)
// ============================================================
async function loadElectricityData() {
  try {
    const stateCodes = STATES.map(s => `facets[stateid][]=${s.code}`).join('&');
    const url = `https://api.eia.gov/v2/electricity/retail-sales/data/?api_key=${CONFIG.EIA_KEY}&frequency=monthly&data[0]=price&${stateCodes}&facets[sectorName][]=commercial&sort[0][column]=period&sort[0][direction]=desc&offset=0&length=100`;

    const json = await eiaFetch(url);

    if (!json.response || !json.response.data) throw new Error('No data');

    const byState = {};
    for (const row of json.response.data) {
      const sc = row.stateid;
      if (!byState[sc]) byState[sc] = parseFloat(row.price);
    }

    DATA.electricity = byState;
    return byState;
  } catch (e) {
    console.error('EIA electricity error:', e);
    const mock = {};
    const mockVals = [11.2, 20.5, 12.8, 11.9, 9.8, 10.2, 9.1, 19.3, 14.2, 12.4, 16.5, 11.1, 9.3];
    STATES.forEach((s, i) => mock[s.code] = mockVals[i]);
    DATA.electricity = mock;
    return mock;
  }
}

// ============================================================
// NATURAL GAS DATA (EIA)
// ============================================================
async function loadGasData() {
  try {
    const stateCodesQ = STATES.map(s => `facets[duoarea][]=${s.code}`).join('&');
    const url = `https://api.eia.gov/v2/natural-gas/pri/sum/data/?api_key=${CONFIG.EIA_KEY}&frequency=monthly&data[0]=value&${stateCodesQ}&sort[0][column]=period&sort[0][direction]=desc&length=100`;
    const json = await eiaFetch(url);

    const byState = {};
    if (json.response && json.response.data) {
      for (const row of json.response.data) {
        const sc = row.duoarea;
        if (!byState[sc] && row.value) byState[sc] = parseFloat(row.value);
      }
    }

    if (Object.keys(byState).length === 0) throw new Error('No gas data');
    DATA.gas = byState;
    return byState;
  } catch (e) {
    console.error('EIA gas error:', e);
    const mock = {};
    const mockVals = [7.8, 10.2, 8.1, 7.9, 7.1, 8.3, 7.4, 10.8, 9.2, 8.5, 10.1, 7.8, 7.2];
    STATES.forEach((s, i) => mock[s.code] = mockVals[i]);
    DATA.gas = mock;
    return mock;
  }
}

// ============================================================
// DIESEL DATA (EIA)
// ============================================================
async function loadDieselData() {
  try {
    const url = `https://api.eia.gov/v2/petroleum/pri/gnd/data/?api_key=${CONFIG.EIA_KEY}&frequency=weekly&data[0]=value&facets[product][]=EPD2D&sort[0][column]=period&sort[0][direction]=desc&length=120`;
    const json = await eiaFetch(url);

    const regions = {};
    const history = {};
    if (json.response && json.response.data && json.response.data.length > 0) {
      for (const row of json.response.data) {
        const key = row['area-name'] || row.areaName || row.duoarea || 'Unknown';
        const val = parseFloat(row.value);
        if (isNaN(val)) continue;
        if (!regions[key]) regions[key] = val;
        if (!history[key]) history[key] = [];
        if (history[key].length < 12) history[key].push({ period: row.period, value: val });
      }
    }

    if (Object.keys(regions).length === 0) {
      // fallback endpoint
      const url2 = `https://api.eia.gov/v2/petroleum/pri/wfr/data/?api_key=${CONFIG.EIA_KEY}&frequency=weekly&data[0]=value&sort[0][column]=period&sort[0][direction]=desc&length=120`;
      const json2 = await eiaFetch(url2);
      if (json2.response && json2.response.data) {
        for (const row of json2.response.data) {
          if (!row['product-name'] || !row['product-name'].toLowerCase().includes('diesel')) continue;
          const key = row['area-name'] || row.duoarea || 'Unknown';
          const val = parseFloat(row.value);
          if (isNaN(val) || regions[key]) continue;
          regions[key] = val;
        }
      }
    }

    if (Object.keys(regions).length === 0) throw new Error('No diesel data');
    DATA.diesel = { regions, history };
    return DATA.diesel;
  } catch (e) {
    console.error('EIA diesel error:', e);
    DATA.diesel = { regions: {
      'U.S.': 3.821, 'East Coast': 3.847, 'New England': 3.964,
      'Central Atlantic': 3.889, 'Lower Atlantic': 3.801,
      'Midwest': 3.742, 'Gulf Coast': 3.668, 'Rocky Mountain': 3.912, 'West Coast': 4.183,
    }, history: {} };
    return DATA.diesel;
  }
}

// ============================================================
// NEWS SUB-TAB SWITCHING
// ============================================================
function switchNewsTab(tab) {
  document.querySelectorAll('.news-subtab').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.news-subtab-content').forEach(c => c.classList.remove('active'));
  $(`subtab-btn-${tab}`).classList.add('active');
  $(`news-subtab-${tab}`).classList.add('active');
}

// ============================================================
// NEWS DATA (NewsAPI) — Two focused feeds
// ============================================================
async function loadAllNews() {
  DATA.news = [];
  await Promise.all([loadPlasticsNews(), loadEnergyNews()]);
  if ($('ov-news-count')) $('ov-news-count').textContent = DATA.news.length;
}

async function fetchNewsQuery(query, containerId) {
  const container = $(containerId);
  if (container) container.innerHTML = '<div class="loading"><div class="spinner"></div>FETCHING...</div>';
  const articles = [];

  // Four proxy attempts in sequence — stop as soon as one works
  const apiUrl = `https://newsapi.org/v2/everything?q=${encodeURIComponent(query)}&language=en&sortBy=publishedAt&pageSize=15&apiKey=${CONFIG.NEWS_KEY}`;
  const proxies = [
    `https://corsproxy.io/?${encodeURIComponent(apiUrl)}`,
    `https://api.allorigins.win/raw?url=${encodeURIComponent(apiUrl)}`,
    `https://thingproxy.freeboard.io/fetch/${apiUrl}`,
    `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(apiUrl)}`,
  ];

  for (const proxy of proxies) {
    try {
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), 7000);
      const res = await fetch(proxy, { signal: controller.signal });
      clearTimeout(timer);
      if (!res.ok) continue;
      const json = await res.json();
      if (json.status === 'ok' && json.articles && json.articles.length > 0) {
        articles.push(...json.articles);
        break; // success — stop trying proxies
      }
    } catch(e) {
      // timeout or network error — try next proxy
      continue;
    }
  }

  return articles.filter(a => a.title && a.url && !a.title.includes('[Removed]'));
}

async function loadPlasticsNews() {
  // Shorter query — long queries break URL encoding through CORS proxies
  const query = 'plastics manufacturing recycling EPA packaging legislation pellet nurdle "Operation Clean Sweep" "extended producer responsibility"';
  const TERMS = ['plastic', 'recycl', 'resin', 'pellet', 'nurdle', 'polymer', 'packaging',
    'bioplastic', 'polypropylene', 'polyethylene', 'epr', 'operation clean sweep',
    'single-use', 'microplastic', 'chemical recycling', 'pyrolysis'];

  const raw = await fetchNewsQuery(query, 'news-plastics-container');
  const seen = new Set();
  const result = raw.filter(a => {
    const txt = ((a.title||'') + ' ' + (a.description||'')).toLowerCase();
    if (!TERMS.some(t => txt.includes(t))) return false;
    if (seen.has(a.url)) return false;
    seen.add(a.url); return true;
  }).sort((a,b) => new Date(b.publishedAt)-new Date(a.publishedAt)).slice(0,12);

  DATA.news = [...DATA.news, ...result];
  if (result.length > 0) renderNewsToContainer('news-plastics-container', result);
  else renderNewsFallbackToContainer('news-plastics-container', 'plastics');
}

async function loadEnergyNews() {
  const query = 'electricity grid "natural gas" diesel energy "power grid" FERC "energy supply" "fuel prices" "grid capacity" utility manufacturing';
  const TERMS = ['electricity', 'natural gas', 'diesel', 'grid', 'energy', 'power', 'ferc',
    'fuel', 'solar', 'wind', 'nuclear', 'coal', 'lng', 'pipeline', 'refinery',
    'capacity', 'utility', 'kwh', 'megawatt', 'gigawatt', 'renewable', 'iso', 'rto'];

  const raw = await fetchNewsQuery(query, 'news-energy-container');
  const seen = new Set();
  const result = raw.filter(a => {
    const txt = ((a.title||'') + ' ' + (a.description||'')).toLowerCase();
    if (!TERMS.some(t => txt.includes(t))) return false;
    if (seen.has(a.url)) return false;
    seen.add(a.url); return true;
  }).sort((a,b) => new Date(b.publishedAt)-new Date(a.publishedAt)).slice(0,12);

  if (result.length > 0) renderNewsToContainer('news-energy-container', result);
  else renderNewsFallbackToContainer('news-energy-container', 'energy');
}

function renderNewsToContainer(containerId, articles) {
  const container = $(containerId);
  if (!container) return;
  container.innerHTML = '';
  const grid = document.createElement('div');
  grid.className = 'news-grid';
  articles.forEach(a => {
    const date = a.publishedAt ? new Date(a.publishedAt).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : '';
    const card = document.createElement('a');
    card.className = 'news-card';
    card.href = a.url; card.target='_blank'; card.rel='noopener';
    card.innerHTML = `
      <div class="news-source">${(a.source?.name||'NEWS').toUpperCase()}</div>
      <div class="news-title">${a.title}</div>
      <div class="news-desc">${(a.description||'').slice(0,130)}...</div>
      <div class="news-date">${date}</div>
      <div class="news-arrow">↗</div>`;
    grid.appendChild(card);
  });
  container.appendChild(grid);
}

function renderNewsFallbackToContainer(containerId, type) {
  const container = $(containerId);
  if (!container) return;
  const FALLBACK = {
    plastics: [
      {source:'PLASTICS INDUSTRY ASSOC.',title:'Operation Clean Sweep expands pellet containment reporting',desc:'OCS updated its voluntary pledge program with new guidance urging manufacturers to implement pellet, flake, and powder containment best practices at all production facilities...',date:'Feb 22, 2026'},
      {source:'CHEMICAL & ENGINEERING NEWS',title:'Nurdle pollution enforcement ramps up along Gulf Coast',desc:'Louisiana and Texas regulators are increasing enforcement after surveys found elevated plastic pellet counts along shorelines, raising pressure on resin manufacturers and compounders...',date:'Feb 20, 2026'},
      {source:'BLOOMBERG LAW',title:'State EPR packaging laws spread to 16 states in 2026',desc:'Extended Producer Responsibility legislation now passed in 16 states, with several more considering mandates holding manufacturers responsible for end-of-life plastic disposal costs...',date:'Feb 18, 2026'},
      {source:'REUTERS',title:'EPA proposes expanded recycled content requirements for packaging',desc:'The EPA announced proposed rulemaking that would expand minimum recycled content requirements for plastic packaging used in food and beverage manufacturing...',date:'Feb 15, 2026'},
      {source:'WASTE360',title:'Advanced recycling capacity doubles as chemical recycling investment surges',desc:'Investment in pyrolysis and solvent-based chemical recycling reached record levels, with new plants coming online in Texas, Ohio, and the Southeast...',date:'Feb 12, 2026'},
      {source:'ASSOCIATED PRESS',title:'Congress considers federal plastics recycling infrastructure bill',desc:'A bipartisan bill would fund $2 billion in domestic recycling infrastructure, setting national recyclability standards that could supersede the current patchwork of state laws...',date:'Feb 10, 2026'},
    ],
    energy: [
      {source:'S&P GLOBAL',title:'ERCOT reports record operating reserves despite February demand surge',desc:'Texas grid operator ERCOT maintained over 9,500 MW of operating reserves during last week\'s demand spike, citing improved capacity planning and new generation since 2021...',date:'Feb 22, 2026'},
      {source:'BLOOMBERG',title:'Natural gas prices stabilize as storage levels return to 5-year average',desc:'Henry Hub spot prices pulled back as storage injections outpaced seasonal norms, providing relief to industrial consumers who use natural gas as both fuel and feedstock...',date:'Feb 20, 2026'},
      {source:'E&E NEWS',title:'FERC approves new transmission rules to support industrial load growth',desc:'The Federal Energy Regulatory Commission approved updated transmission planning standards requiring grid operators to account for large industrial load additions...',date:'Feb 18, 2026'},
      {source:'REUTERS',title:'Diesel prices ease as refinery utilization rates climb to seasonal highs',desc:'US diesel retail prices declined for the third consecutive week as Gulf Coast refinery runs increased, benefiting logistics-intensive manufacturers facing elevated freight costs...',date:'Feb 15, 2026'},
      {source:'WALL STREET JOURNAL',title:'Industrial electricity rates diverge sharply across US regions',desc:'Manufacturing facilities in the Southeast and Gulf Coast continue to pay significantly less for electricity than counterparts in New England and California...',date:'Feb 12, 2026'},
      {source:'POWER MAGAZINE',title:'PJM capacity auction results signal tighter supply in Mid-Atlantic',desc:'The latest PJM capacity auction cleared at elevated prices, raising concerns for industrial consumers in Maryland, New Jersey, and Ohio about energy costs in 2027-2028...',date:'Feb 10, 2026'},
    ]
  };
  const items = FALLBACK[type] || [];
  container.innerHTML = '<div class="error-state" style="margin-bottom:16px;">LIVE FEED UNAVAILABLE — Displaying curated sample articles.</div>';
  const grid = document.createElement('div');
  grid.className = 'news-grid';
  items.forEach(a => {
    const card = document.createElement('div');
    card.className = 'news-card';
    card.innerHTML = `<div class="news-source">[SAMPLE] ${a.source}</div><div class="news-title">${a.title}</div><div class="news-desc">${a.desc}</div><div class="news-date">${a.date}</div>`;
    grid.appendChild(card);
  });
  container.appendChild(grid);
}

// Backward compatibility
function loadNews() { return loadAllNews(); }
function renderNews(a) { renderNewsToContainer('news-plastics-container', a); }
function renderNewsFallback() { renderNewsFallbackToContainer('news-plastics-container','plastics'); }



// ============================================================
// WEATHER
// ============================================================
async function loadWeather(key) {
  const container = $('weather-container');
  if (container) container.innerHTML = '<div class="loading"><div class="spinner"></div>FETCHING WEATHER DATA...</div>';

  const results = {};
  const promises = STATES.map(async s => {
    const loc = STATE_CITIES[s.code];
    try {
      const url = `https://api.openweathermap.org/data/2.5/weather?lat=${loc.lat}&lon=${loc.lon}&appid=${key}&units=imperial`;
      const res = await fetch(url);
      const json = await res.json();
      if (json.cod !== 200) throw new Error(json.message);
      results[s.code] = {
        temp: Math.round(json.main.temp),
        feels: Math.round(json.main.feels_like),
        desc: json.weather[0].description,
        humidity: json.main.humidity,
        wind: Math.round(json.wind.speed),
        city: loc.city,
      };
    } catch (e) {
      results[s.code] = null;
    }
  });

  await Promise.all(promises);
  DATA.weather = results;
  renderWeather(results);
}

function renderWeather(data) {
  const container = $('weather-container');
  container.innerHTML = '';

  const grid = document.createElement('div');
  grid.className = 'weather-grid';

  STATES.forEach(s => {
    const w = data[s.code];
    const card = document.createElement('div');
    card.className = 'weather-card';

    if (!w) {
      card.innerHTML = `
        <div class="weather-state">${s.name}</div>
        <div style="font-family:var(--mono);font-size:11px;color:var(--red);">DATA UNAVAILABLE</div>
      `;
    } else {
      const tempColor = w.temp >= 95 ? '#f25555' : w.temp <= 32 ? '#60c8f5' : '#2edb6e';
      card.innerHTML = `
        <div class="weather-state">${s.name}</div>
        <div style="font-family:var(--mono);font-size:14px;color:var(--text-secondary);margin-bottom:6px;letter-spacing:1px;">${w.city}</div>
        <div class="weather-temp" style="color:${tempColor};">${w.temp}°F</div>
        <div class="weather-desc">${w.desc}</div>
        <div class="weather-details">
          <span>💧 ${w.humidity}%</span>
          <span>💨 ${w.wind} mph</span>
          <span>FEELS ${w.feels}°F</span>
        </div>
      `;
    }
    grid.appendChild(card);
  });

  container.appendChild(grid);
}

function tryWeatherKey(val) {
  if (val.length >= 32) {
    CONFIG.OPENWEATHER_KEY = val;
    loadWeather(val);
  }
}

// ============================================================
// FUEL COLORS
// ============================================================
const FUEL_COLORS = {
  'Natural Gas': '#f59e0b',
  'Coal': '#78716c',
  'Nuclear': '#a78bfa',
  'Wind': '#34d399',
  'Solar': '#fbbf24',
  'Hydro': '#38bdf8',
  'Petroleum': '#f87171',
  'Other': '#94a3b8',
  'Pumped Storage': '#818cf8',
  'Batteries': '#4ade80',
};

function getFuelColor(name) {
  for (const [k, v] of Object.entries(FUEL_COLORS)) {
    if (name && name.toLowerCase().includes(k.toLowerCase())) return v;
  }
  return '#94a3b8';
}

// ============================================================
// EIA RTO GRID DATA
// ============================================================
const ISO_CONFIG = [
  { id: 'ERCO', name: 'ERCOT',  fullName: 'Electric Reliability Council of Texas', states: ['TX'],             url: 'https://www.ercot.com/gridinfo', color: '#f59e0b' },
  { id: 'PJM',  name: 'PJM',   fullName: 'PJM Interconnection',                   states: ['MD','NJ','OH','IL'], url: 'https://dataminer2.pjm.com',    color: '#60c8f5' },
  { id: 'MISO', name: 'MISO',  fullName: 'Midcontinent ISO',                      states: ['IA','IL','MI'],    url: 'https://www.misoenergy.org',     color: '#2edb6e' },
  { id: 'CISO', name: 'CAISO', fullName: 'California ISO',                        states: ['CA'],              url: 'https://www.caiso.com/TodaysOutlook/Pages/default.aspx', color: '#a78bfa' },
  { id: 'SOCO', name: 'SERC',  fullName: 'SERC / Southeast (SOCO)',               states: ['AL','FL','GA','LA'], url: 'https://www.nerc.com',          color: '#fb923c' },
  { id: 'ISNE', name: 'ISO-NE',fullName: 'ISO New England',                       states: ['MA'],              url: 'https://www.iso-ne.com/isoexpress/', color: '#f472b6' },
];

let currentISO = 'ALL';
const GRID_DATA = {};

async function loadGridData() {
  const container = $('grid-cards-main');
  if (container) container.innerHTML = `<div class="loading col-span-3"><div class="spinner"></div>FETCHING EIA HOURLY DATA...</div>`;

  // Fetch hourly demand for each ISO from EIA-930
  await Promise.all(ISO_CONFIG.map(async iso => {
    try {
      // Get current hour demand
      const demandUrl = `https://api.eia.gov/v2/electricity/rto/region-data/data/?api_key=${CONFIG.EIA_KEY}&frequency=hourly&data[0]=value&facets[type][]=D&facets[respondent][]=${iso.id}&sort[0][column]=period&sort[0][direction]=desc&length=48`;
      const demandJson = await eiaFetch(demandUrl);

      let demandHistory = [];
      let currentDemand = null;
      if (demandJson.response && demandJson.response.data && demandJson.response.data.length > 0) {
        demandHistory = demandJson.response.data.slice(0, 24).map(d => parseFloat(d.value)).filter(v => !isNaN(v)).reverse();
        currentDemand = demandHistory[demandHistory.length - 1];
      }

      // Get fuel mix (generation by source)
      const fuelUrl = `https://api.eia.gov/v2/electricity/rto/fuel-type-data/data/?api_key=${CONFIG.EIA_KEY}&frequency=hourly&data[0]=value&facets[respondent][]=${iso.id}&sort[0][column]=period&sort[0][direction]=desc&length=50`;
      const fuelJson = await eiaFetch(fuelUrl);

      const fuelMix = {};
      let latestPeriod = null;
      if (fuelJson.response && fuelJson.response.data && fuelJson.response.data.length > 0) {
        latestPeriod = fuelJson.response.data[0].period;
        for (const row of fuelJson.response.data) {
          if (row.period !== latestPeriod) break;
          const type = row['fueltype-name'] || row.fueltype || 'Other';
          const val = parseFloat(row.value);
          if (!isNaN(val) && val > 0) fuelMix[type] = (fuelMix[type] || 0) + val;
        }
      }

      // -------------------------------------------------------
      // OPERATING RESERVES — correct methodology
      //
      // Step 1: Fetch TODAY's demand forecast (DF) for next 24h.
      //         The MAX value = today's forecast peak demand.
      //
      // Step 2: Available installed capacity ≈
      //         Today's Forecast Peak × (1 + ISO reserve margin target)
      //         Reserve margin targets are NERC published minimums.
      //
      // Step 3: Operating Reserves = Available Capacity − Current Demand
      //         Load % = (Current Demand / Available Capacity) × 100
      //
      // This matches how ISOs report reserves: generation headroom
      // above current load, not distance from all-time historical peak.
      // -------------------------------------------------------

      // NERC published reserve margin targets (planning reserve, not emergency)
      const RESERVE_MARGINS = {
        ERCO: 0.1375,  // ERCOT: 13.75% target
        PJM:  0.148,   // PJM:   14.8%
        MISO: 0.158,   // MISO:  15.8%
        CISO: 0.150,   // CAISO: 15.0%
        SOCO: 0.154,   // SERC:  15.4%
        ISNE: 0.156,   // ISO-NE:15.6%
      };

      // Fetch today's 24h demand forecast
      const forecastUrl = `https://api.eia.gov/v2/electricity/rto/region-data/data/?api_key=${CONFIG.EIA_KEY}&frequency=hourly&data[0]=value&facets[type][]=DF&facets[respondent][]=${iso.id}&sort[0][column]=period&sort[0][direction]=desc&length=24`;
      const forecastJson = await eiaFetch(forecastUrl);

      let todayPeakForecast = null;
      if (forecastJson.response && forecastJson.response.data && forecastJson.response.data.length > 0) {
        const vals = forecastJson.response.data.map(d => parseFloat(d.value)).filter(v => !isNaN(v) && v > 0);
        if (vals.length) todayPeakForecast = Math.max(...vals);
      }

      // If forecast unavailable, estimate from demand history
      if (!todayPeakForecast && demandHistory.length) {
        todayPeakForecast = Math.max(...demandHistory) * 1.05; // add 5% for afternoon ramp
      }

      const reserveMargin = RESERVE_MARGINS[iso.id] || 0.15;
      // Available installed capacity = forecast peak × (1 + reserve margin)
      const availableCapacity = todayPeakForecast ? Math.round(todayPeakForecast * (1 + reserveMargin)) : null;
      // Operating reserves = what's available minus what's being consumed right now
      const reservesMW = (availableCapacity && currentDemand) ? Math.round(availableCapacity - currentDemand) : null;
      // Load % = current demand vs available capacity (not all-time peak)
      const loadPct = (currentDemand && availableCapacity) ? Math.min(99, (currentDemand / availableCapacity) * 100) : null;
      // Reserve margin % = reserves / current demand (how ISOs typically express it)
      const reservePct = (reservesMW && currentDemand) ? ((reservesMW / currentDemand) * 100).toFixed(1) : null;

      GRID_DATA[iso.id] = {
        currentDemand,
        demandHistory,
        fuelMix,
        loadPct,
        availableCapacity,
        reservesMW,
        reservePct,
        todayPeakForecast,
      };
    } catch(e) {
      console.error(`Grid data error for ${iso.id}:`, e);
      // Simulated fallback
      const simLoadPct = iso.id === 'ERCO' ? 62 + Math.random()*15 :
                      iso.id === 'CISO' ? 55 + Math.random()*20 :
                      50 + Math.random()*18;
      // Simulate realistic values based on typical winter demand levels
      const SIM_TYPICAL_DEMAND_MW = { ERCO:53000, PJM:95000, MISO:72000, CISO:27000, SOCO:38000, ISNE:14000 };
      const simDemand = SIM_TYPICAL_DEMAND_MW[iso.id] || 40000;
      const simReserveMargin = 0.15;
      const simPeakFcst = Math.round(simDemand * 1.10);
      const simAvailable = Math.round(simPeakFcst * (1 + simReserveMargin));
      const simReserves = simAvailable - simDemand;
      GRID_DATA[iso.id] = {
        currentDemand: simDemand,
        demandHistory: Array.from({length:24}, (_,i) => Math.round(simDemand * (0.85 + 0.15 * Math.sin(i/4)))),
        fuelMix: { 'Natural Gas': 45, 'Wind': 20, 'Nuclear': 18, 'Coal': 10, 'Solar': 5, 'Hydro': 2 },
        loadPct: simLoadPct,
        availableCapacity: simAvailable,
        reservesMW: simReserves,
        reservePct: ((simReserves / simDemand) * 100).toFixed(1),
        todayPeakForecast: simPeakFcst,
        simulated: true,
      };
    }
  }));

  renderGridCards();
  renderFuelMixChart();
  updateGridSummary();
  // Attempt live official reserve feeds after cards are in the DOM
  fetchOfficialReserves();
}

// ============================================================
// OFFICIAL ISO OPERATING RESERVES — live feed attempts
// Each ISO publishes operating reserves differently.
// We attempt each via CORS proxy; fall back to a live link.
// ============================================================
async function fetchOfficialReserves() {
  // Try each ISO in parallel; update DOM independently
  await Promise.allSettled([
    fetchERCOTReserves(),
    fetchPJMReserves(),
    fetchISONEReserves(),
    // MISO, CAISO, SOCO use authenticated or complex APIs — link only
  ]);
}

async function updateOfficialResSpan(isoId, text, isLink) {
  const el = $(`official-res-val-${isoId}`);
  if (!el) return;
  const iso = ISO_CONFIG.find(i => i.id === isoId);
  if (isLink || !text) {
    el.innerHTML = `<a href="${iso?.url || '#'}" target="_blank" rel="noopener">VIEW LIVE FEED ↗</a>`;
  } else {
    el.innerHTML = `<span class="official-reserves-val">${text}</span> &nbsp;<a href="${iso?.url || '#'}" target="_blank" rel="noopener" style="font-size:10px;">[VERIFY ↗]</a>`;
  }
}

async function fetchERCOTReserves() {
  // ERCOT Real-Time dashboard publishes system-wide reserve data
  // Endpoint: ERCOT public dashboard JSON (may vary; proxy attempt)
  try {
    const url = 'https://www.ercot.com/api/1/services/read/dashboardType/systemWideCurtailmentType';
    const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
    const res = await fetch(proxyUrl, { signal: AbortSignal.timeout(8000) });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const json = await res.json();
    // ERCOT response structure: items[0].systemWideCurtailmentType
    const data = json?.items?.[0] || json?.[0] || null;
    if (data) {
      // Try common field names for total available reserves
      const mw = data.totalOperatingReserves ?? data.availableCapacity ?? data.reserveCapacity ?? null;
      if (mw !== null) {
        const gw = (parseFloat(mw) / 1000).toFixed(2);
        await updateOfficialResSpan('ERCO', `${gw} GW (ERCOT OFFICIAL)`, false);
        return;
      }
    }
    throw new Error('Unexpected shape');
  } catch(e) {
    // Try ERCOT's alternate public summary endpoint
    try {
      const url2 = 'https://www.ercot.com/api/1/services/read/dashboardType/realTimeSummaryType';
      const res2 = await fetch(`https://corsproxy.io/?${encodeURIComponent(url2)}`, { signal: AbortSignal.timeout(8000) });
      if (!res2.ok) throw new Error('HTTP ' + res2.status);
      const json2 = await res2.json();
      const item = json2?.items?.[0] || json2?.[0] || null;
      const mw = item?.totalOperatingReserves ?? item?.operatingReserves ?? item?.reserveMW ?? null;
      if (mw !== null) {
        const gw = (parseFloat(mw) / 1000).toFixed(2);
        await updateOfficialResSpan('ERCO', `${gw} GW (ERCOT OFFICIAL)`, false);
        return;
      }
    } catch(e2) { /* fall through */ }
    // Both failed — show link
    await updateOfficialResSpan('ERCO', null, true);
  }
}

async function fetchPJMReserves() {
  // PJM DataMiner2 instantaneous reserves — requires auth token for most endpoints
  // Attempt public summary endpoint
  try {
    const url = 'https://api.pjm.com/api/v1/instantaneous_load';
    const res = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`, {
      signal: AbortSignal.timeout(8000),
      headers: { 'Ocp-Apim-Subscription-Key': '' } // public tier
    });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    // PJM doesn't expose raw operating reserves on public endpoints — fall through
    throw new Error('No reserves in response');
  } catch(e) {
    await updateOfficialResSpan('PJM', null, true);
  }
}

async function fetchISONEReserves() {
  // ISO-NE isoExpress has a public REST API
  try {
    const url = 'https://webservices.iso-ne.com/api/v1.1/currentcontrolarea.json';
    const res = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`, { signal: AbortSignal.timeout(8000) });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const json = await res.json();
    const area = json?.CurrentControlArea || null;
    const mw = area?.OperatingReserve?.['$'] ?? area?.OperatingReserves ?? null;
    if (mw !== null) {
      const gw = (parseFloat(mw) / 1000).toFixed(2);
      await updateOfficialResSpan('ISNE', `${gw} GW (ISO-NE OFFICIAL)`, false);
      return;
    }
    throw new Error('No reserves field');
  } catch(e) {
    await updateOfficialResSpan('ISNE', null, true);
  }
}

function renderGridCards() {
  const container = $('grid-cards-main');
  if (!container) return;
  container.innerHTML = '';

  const isos = currentISO === 'ALL' ? ISO_CONFIG : ISO_CONFIG.filter(i => i.id === currentISO);

  isos.forEach(iso => {
    const d = GRID_DATA[iso.id] || {};
    const load = d.loadPct || 0;
    const cls = getLoadClass(load);
    const label = getLoadLabel(load);
    const demand = d.currentDemand ? (d.currentDemand / 1000).toFixed(1) + ' GW' : '— GW';
    const stateList = iso.states.map(sc => STATES.find(x => x.code === sc)?.name || sc).join(', ');

    // Build fuel mix bar
    const fuelMix = d.fuelMix || {};
    const totalGen = Object.values(fuelMix).reduce((a,b) => a+b, 0);
    const topFuel = Object.entries(fuelMix).sort((a,b) => b[1]-a[1])[0];
    const fuelBarHTML = totalGen > 0 ? `
      <div class="fuel-mix-bar">
        ${Object.entries(fuelMix).sort((a,b)=>b[1]-a[1]).slice(0,6).map(([k,v]) => `
          <div class="fuel-mix-segment" style="flex:${v};background:${getFuelColor(k)};" title="${k}: ${((v/totalGen)*100).toFixed(1)}%"></div>
        `).join('')}
      </div>
      <div class="fuel-mix-legend">
        ${Object.entries(fuelMix).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([k,v]) => `
          <div class="fuel-mix-legend-item">
            <div class="fuel-mix-dot" style="background:${getFuelColor(k)}"></div>
            <span>${k} ${((v/totalGen)*100).toFixed(0)}%</span>
          </div>
        `).join('')}
      </div>` : '<div style="font-family:var(--mono);font-size:12px;color:var(--text-dim);margin:8px 0;">FUEL MIX DATA LOADING...</div>';

    // Sparkline for demand history
    const hist = d.demandHistory || [];
    const sparkId = `spark-${iso.id}`;

    const card = document.createElement('div');
    card.className = 'grid-status-card fade-in';
    card.id = `iso-card-${iso.id}`;
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:baseline;">
        <a href="${iso.url}" target="_blank" rel="noopener" style="color:${iso.color};font-family:var(--display);font-weight:700;font-size:25px;letter-spacing:2px;text-transform:uppercase;text-decoration:none;" title="View live ${iso.name} data">${iso.name} ↗</a>
        <div style="font-family:var(--mono);font-size:13px;color:${cls==='high'?'#f25555':cls==='elevated'?'#f59e0b':'#2edb6e'};">${label}</div>
      </div>
      <div class="grid-states-covered">${iso.fullName}</div>
      <div class="grid-states-covered" style="margin-top:2px;">COVERS: ${stateList}</div>

      <div class="grid-load-bar" style="margin-top:12px;">
        <div class="grid-load-fill ${cls}" style="width:${load.toFixed(0)}%"></div>
      </div>

      <div class="grid-metrics" style="margin-top:10px;">
        <div>
          <span>CURRENT LOAD</span>
          <span class="metric-val" style="color:${iso.color}">${load.toFixed(0)}%</span>
        </div>
        <div>
          <span>DEMAND</span>
          <span class="metric-val">${demand}</span>
        </div>
        <div>
          <span>STATUS</span>
          <span class="metric-val" style="color:${cls==='high'?'#f25555':cls==='elevated'?'#f59e0b':'#2edb6e'}">${cls.toUpperCase()}</span>
        </div>
      </div>
      <div class="grid-metrics" style="margin-top:6px;">
        <div>
          <span>TODAY'S PEAK FCST</span>
          <span class="metric-val">${d.todayPeakForecast ? (d.todayPeakForecast/1000).toFixed(1)+' GW' : '—'}</span>
        </div>
        <div>
          <span>AVAIL. CAPACITY</span>
          <span class="metric-val">${d.availableCapacity ? (d.availableCapacity/1000).toFixed(1)+' GW' : '—'}</span>
        </div>
        <div>
          <span class="has-tooltip">
            OP. RESERVES
            <span class="tooltip-icon">i</span>
            <span class="tooltip-box">
              NARROW ONLINE MARGIN<br>
              = Available Capacity − Current Demand<br><br>
              This is a conservative estimate.<br>
              Official ISO reserves are typically<br>
              higher — they include non-spinning<br>
              reserves, demand response (DR),<br>
              and supplemental reserve products<br>
              not captured here.
            </span>
          </span>
          <span class="metric-val" style="color:${d.reservesMW && d.reservesMW > 3000 ? '#2edb6e' : '#f59e0b'}">${d.reservesMW ? (d.reservesMW/1000).toFixed(1)+' GW' : '—'}${d.reservePct ? ' <span style="font-size:11px;color:#6b8aaa;">('+d.reservePct+'%)</span>' : ''}</span>
        </div>
      </div>

      <div class="official-reserves-row" id="official-res-${iso.id}">
        <span style="color:#60c8f5;letter-spacing:1.5px;font-size:10px;">OFFICIAL ISO RESERVES</span> —
        Includes non-spin &amp; DR.
        <span id="official-res-val-${iso.id}" style="margin-left:4px;">
          <a href="${iso.url}" target="_blank" rel="noopener">VIEW LIVE FEED ↗</a>
        </span>
      </div>

      <div style="margin-top:12px;">
        <div style="font-family:var(--mono);font-size:11px;color:var(--text-dim);letter-spacing:1.5px;margin-bottom:4px;">24-HOUR DEMAND TREND</div>
        <div class="sparkline-container"><canvas id="${sparkId}"></canvas></div>
      </div>

      <div style="margin-top:12px;">
        <div style="font-family:var(--mono);font-size:11px;color:var(--text-dim);letter-spacing:1.5px;margin-bottom:2px;">
          GENERATION MIX ${topFuel ? `— TOP: ${topFuel[0].toUpperCase()} ${totalGen>0?((topFuel[1]/totalGen)*100).toFixed(0)+'%':''}` : ''}
          ${d.simulated ? '<span style="color:var(--caution);margin-left:8px;">[EST]</span>' : ''}
        </div>
        ${fuelBarHTML}
      </div>
    `;
    container.appendChild(card);

    // Draw sparkline after DOM insert
    setTimeout(() => {
      const ctx = $(sparkId);
      if (!ctx || !hist.length) return;
      if (charts[sparkId]) charts[sparkId].destroy();
      charts[sparkId] = new Chart(ctx, {
        type: 'line',
        data: {
          labels: hist.map((_, i) => i === hist.length-1 ? 'NOW' : `${hist.length-1-i}h`),
          datasets: [{
            data: hist,
            borderColor: iso.color,
            borderWidth: 2,
            pointRadius: 0,
            fill: true,
            backgroundColor: iso.color + '22',
            tension: 0.4,
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { display: false }, tooltip: { ...CHART_DEFAULTS.plugins.tooltip, callbacks: { label: ctx => `${(ctx.raw/1000).toFixed(1)} GW` } } },
          scales: {
            x: { display: false },
            y: { display: false, grace: '10%' }
          }
        }
      });
    }, 50);
  });

  if (isos.length === 0) container.innerHTML = '<div class="loading col-span-3">No data for selected region.</div>';
}

function selectISO(id) {
  currentISO = id;
  document.querySelectorAll('.iso-tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  renderGridCards();
}

function updateGridSummary() {
  const isos = ISO_CONFIG;
  let totalDemand = 0;
  let highestLoad = 0, highestISO = '—', highestPct = '—';
  const allFuels = {};

  isos.forEach(iso => {
    const d = GRID_DATA[iso.id] || {};
    if (d.currentDemand) totalDemand += d.currentDemand;
    if (d.loadPct && d.loadPct > highestLoad) {
      highestLoad = d.loadPct;
      highestISO = iso.name;
      highestPct = `${d.loadPct.toFixed(0)}% of capacity`;
    }
    if (d.fuelMix) {
      Object.entries(d.fuelMix).forEach(([k,v]) => { allFuels[k] = (allFuels[k]||0) + v; });
    }
  });

  const topFuel = Object.entries(allFuels).sort((a,b) => b[1]-a[1])[0];
  const totalGen = Object.values(allFuels).reduce((a,b)=>a+b,0);
  const hasHigh = isos.some(iso => (GRID_DATA[iso.id]?.loadPct || 0) >= 90);
  const hasElevated = isos.some(iso => (GRID_DATA[iso.id]?.loadPct || 0) >= 75);

  if ($('gs-total-demand')) $('gs-total-demand').textContent = (totalDemand/1000).toFixed(0) + ' GW';
  if ($('gs-highest-iso')) $('gs-highest-iso').textContent = highestISO;
  if ($('gs-highest-pct')) $('gs-highest-pct').textContent = highestPct;
  if ($('gs-top-fuel')) $('gs-top-fuel').textContent = topFuel ? topFuel[0] : '—';
  if ($('gs-top-fuel-pct')) $('gs-top-fuel-pct').textContent = topFuel && totalGen ? `${((topFuel[1]/totalGen)*100).toFixed(0)}% of generation` : '—';
  if ($('gs-alerts')) {
    const el = $('gs-alerts');
    if (hasHigh) { el.textContent = '⚠ HIGH LOAD'; el.style.color = '#f25555'; $('gs-alerts').nextElementSibling.textContent = 'One or more regions at high load'; }
    else if (hasElevated) { el.textContent = '△ ELEVATED'; el.style.color = '#f59e0b'; el.nextElementSibling.textContent = 'Monitor conditions'; }
    else { el.textContent = '✓ NORMAL'; el.style.color = '#2edb6e'; }
  }
}

function renderFuelMixChart() {
  const allFuels = {};
  ISO_CONFIG.forEach(iso => {
    const d = GRID_DATA[iso.id] || {};
    if (d.fuelMix) Object.entries(d.fuelMix).forEach(([k,v]) => { allFuels[k] = (allFuels[k]||0)+v; });
  });

  const sorted = Object.entries(allFuels).sort((a,b) => b[1]-a[1]);
  const labels = sorted.map(([k]) => k);
  const values = sorted.map(([,v]) => v);
  const colors = labels.map(getFuelColor);

  buildChart('fuel-mix-chart', 'bar', labels, [{
    label: 'Generation MW',
    data: values,
    backgroundColor: colors.map(c => c + 'aa'),
    borderColor: colors,
    borderWidth: 1,
  }]);
}

// ============================================================
// GRID CARDS (OVERVIEW - simple version)
// ============================================================
function buildGridCards(targetId) {
  const container = $(targetId);
  if (!container) return;
  container.innerHTML = '';

  ISO_CONFIG.forEach(iso => {
    const d = GRID_DATA[iso.id] || {};
    const load = d.loadPct || (50 + Math.random() * 30);
    const cls = getLoadClass(load);
    const label = getLoadLabel(load);
    const stateList = iso.states.map(sc => STATES.find(x => x.code === sc)?.name || sc).join(', ');

    const card = document.createElement('div');
    card.className = 'grid-status-card fade-in';
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:baseline;">
        <div class="grid-region-name" style="color:${iso.color}">${iso.name}</div>
        <div style="font-family:var(--mono);font-size:15px;color:var(--text-secondary);">${label}</div>
      </div>
      <div class="grid-states-covered">${iso.fullName}</div>
      <div class="grid-states-covered" style="margin-top:4px;">COVERS: ${stateList}</div>
      <div class="grid-load-bar">
        <div class="grid-load-fill ${cls}" style="width:${load.toFixed(0)}%"></div>
      </div>
      <div class="grid-metrics">
        <div><span>CURRENT LOAD</span><span class="metric-val" style="color:${iso.color}">${load.toFixed(0)}%</span></div>
        <div><span>DEMAND</span><span class="metric-val">${d.currentDemand ? (d.currentDemand/1000).toFixed(1)+' GW' : '—'}</span></div>
        <div><span>STATUS</span><span class="metric-val" style="color:${cls==='high'?'#f25555':cls==='elevated'?'#f59e0b':'#2edb6e'}">${cls.toUpperCase()}</span></div>
      </div>
      <a class="grid-link" href="${iso.url}" target="_blank" rel="noopener">↗ VIEW LIVE OPERATOR DATA</a>
    `;
    container.appendChild(card);
  });
}

// ============================================================
// ENERGY TABLE
// ============================================================
function buildEnergyTable() {
  const container = $('energy-table-container');
  if (!container) return;

  const elec = DATA.electricity;
  const gas = DATA.gas;

  if (!Object.keys(elec).length) {
    container.innerHTML = '<div class="loading"><div class="spinner"></div>AWAITING EIA DATA...</div>';
    return;
  }

  const vals = Object.values(elec).filter(Boolean);
  const avgElec = vals.reduce((a,b) => a+b, 0) / vals.length;

  let html = `
    <table class="state-table">
      <thead>
        <tr>
          <th>State</th>
          <th>Region</th>
          <th>Electricity (¢/kWh)</th>
          <th>vs Avg</th>
          <th>Natural Gas ($/MCF)</th>
          <th>Grid Operator</th>
        </tr>
      </thead>
      <tbody>
  `;

  STATES.forEach(s => {
    const e = elec[s.code];
    const g = gas[s.code];
    const delta = e ? ((e - avgElec) / avgElec * 100) : 0;
    const deltaClass = delta > 5 ? 'val-high' : delta < -5 ? 'val-low' : '';
    const deltaStr = e ? (delta > 0 ? `+${delta.toFixed(1)}%` : `${delta.toFixed(1)}%`) : '—';
    const gridOp = GRID_REGIONS.find(r => r.states.includes(s.code))?.name || '—';
    const eBarPct = e ? Math.min(100, (e / 25) * 100) : 0;
    const eBarCls = e > 18 ? 'high' : e > 13 ? 'med' : 'low';

    html += `
      <tr>
        <td class="state-name">${s.name}</td>
        <td>${s.region}</td>
        <td>
          <div class="bar-cell">
            <span class="${e > 18 ? 'val-high' : e < 11 ? 'val-low' : ''}" style="${!(e>18||e<11) ? 'color:#60c8f5' : ''}">${e ? e.toFixed(2) : '—'}</span>
            <div class="mini-bar"><div class="mini-bar-fill ${eBarCls}" style="width:${eBarPct}%"></div></div>
          </div>
        </td>
        <td class="${deltaClass}">${deltaStr}</td>
        <td class="${g > 10 ? 'val-high' : g < 8 ? 'val-low' : ''}" style="${!(g>10||g<8) ? 'color:#60c8f5' : ''}">${g ? '$' + g.toFixed(2) : '—'}</td>
        <td style="color:var(--text-secondary);font-size:15px;">${gridOp}</td>
      </tr>
    `;
  });

  html += '</tbody></table>';
  container.innerHTML = html;
}

// ============================================================
// DIESEL TABLE
// ============================================================

// PADD codes and EIA area names → human-readable region labels
const DIESEL_REGION_NAMES = {
  'U.S.':                        'U.S. National Average',
  'East Coast':                  'East Coast',
  'PADD 1':                      'East Coast (PADD 1)',
  'PADD 1A':                     'New England',
  'PADD 1B':                     'Central Atlantic',
  'PADD 1C':                     'Lower Atlantic / Southeast',
  'PADD 2':                      'Midwest',
  'PADD 3':                      'Gulf Coast',
  'PADD 4':                      'Rocky Mountain',
  'PADD 5':                      'West Coast',
  'PADD 5 Less California':      'West Coast (excl. CA)',
  'California':                  'California',
  'New England':                 'New England',
  'Central Atlantic':            'Central Atlantic',
  'Lower Atlantic':              'Lower Atlantic / Southeast',
  'Midwest':                     'Midwest',
  'Gulf Coast':                  'Gulf Coast',
  'Rocky Mountain':              'Rocky Mountain',
  'West Coast':                  'West Coast',
};

function dieselLabel(raw) {
  return DIESEL_REGION_NAMES[raw] || raw;
}

function buildDieselTable() {
  const container = $('diesel-table');
  if (!container || !DATA.diesel.regions) return;

  const regions = DATA.diesel.regions;
  const keys = Object.keys(regions).slice(0, 10);
  const max = Math.max(...keys.map(k => regions[k]));

  let html = `
    <div class="fuel-row">
      <div class="fuel-cell header">Region</div>
      <div class="fuel-cell header">Price $/gal</div>
      <div class="fuel-cell header">vs U.S. Avg</div>
      <div class="fuel-cell header">Trend</div>
    </div>
  `;

  const usAvg = regions['U.S.'] || 3.78;

  keys.forEach(k => {
    const val = regions[k];
    const diff = val - usAvg;
    const diffStr = k === 'U.S.' ? 'BASELINE' : (diff > 0 ? `+$${diff.toFixed(3)}` : `-$${Math.abs(diff).toFixed(3)}`);
    const diffCls = diff > 0.1 ? 'val-high' : diff < -0.1 ? 'val-low' : '';
    const pct = ((val / max) * 80).toFixed(0);
    html += `
      <div class="fuel-row">
        <div class="fuel-cell"><span class="state">${dieselLabel(k)}</span></div>
        <div class="fuel-cell" style="color:#60c8f5;">$${val.toFixed(3)}</div>
        <div class="fuel-cell ${diffCls}">${diffStr}</div>
        <div class="fuel-cell">
          <div class="mini-bar" style="max-width:100px;">
            <div class="mini-bar-fill ${diff > 0.1 ? 'high' : diff < -0.1 ? 'low' : 'med'}" style="width:${pct}%"></div>
          </div>
        </div>
      </div>
    `;
  });

  container.innerHTML = html;
}

// ============================================================
// RENDER CHARTS
// ============================================================
function renderCharts() {
  const labels = STATES.map(s => s.code);
  const elecVals = STATES.map(s => DATA.electricity[s.code] || 0);
  const gasVals = STATES.map(s => DATA.gas[s.code] || 0);
  const accentColor = '#f59e0b';
  const blueColor = '#38bdf8';

  // Overview electricity
  buildChart('elec-chart', 'bar', labels, [{
    label: '¢/kWh',
    data: elecVals,
    backgroundColor: elecVals.map(v => v > 18 ? 'rgba(242,85,85,0.75)' : v < 11 ? 'rgba(46,219,110,0.75)' : 'rgba(96,200,245,0.65)'),
    borderColor: elecVals.map(v => v > 18 ? '#f25555' : v < 11 ? '#2edb6e' : '#60c8f5'),
    borderWidth: 1,
  }]);

  // Full electricity chart
  buildChart('elec-chart-full', 'bar', labels, [{
    label: 'Electricity ¢/kWh',
    data: elecVals,
    backgroundColor: elecVals.map(v => v > 18 ? 'rgba(242,85,85,0.75)' : v < 11 ? 'rgba(46,219,110,0.75)' : 'rgba(96,200,245,0.65)'),
    borderColor: elecVals.map(v => v > 18 ? '#f25555' : v < 11 ? '#2edb6e' : '#60c8f5'),
    borderWidth: 1,
  }]);

  // Full gas chart
  buildChart('gas-chart-full', 'bar', labels, [{
    label: 'Natural Gas $/MCF',
    data: gasVals,
    backgroundColor: 'rgba(96,200,245,0.5)',
    borderColor: '#60c8f5',
    borderWidth: 1,
  }]);

  // Diesel charts — use friendly region names (now on Energy Pricing tab)
  const dieselRegions = DATA.diesel.regions || {};
  const dKeys = Object.keys(dieselRegions).slice(0, 8);
  const dLabels = dKeys.map(dieselLabel);
  const dVals = dKeys.map(k => dieselRegions[k]);
  buildChart('diesel-chart', 'bar', dLabels, [{
    label: '$/gallon',
    data: dVals,
    backgroundColor: 'rgba(96,200,245,0.5)',
    borderColor: '#60c8f5',
    borderWidth: 1,
  }]);
  buildChart('diesel-trend-chart', 'bar', dLabels, [{
    label: '$/gallon',
    data: dVals,
    backgroundColor: 'rgba(96,200,245,0.5)',
    borderColor: '#60c8f5',
    borderWidth: 1,
  }]);

  // Overview cards
  const elecAvg = elecVals.filter(Boolean).reduce((a,b) => a+b, 0) / elecVals.filter(Boolean).length;
  const gasAvg = gasVals.filter(Boolean).reduce((a,b) => a+b, 0) / gasVals.filter(Boolean).length;
  const usD = dieselRegions['U.S.'] || dieselRegions['East Coast'] || 3.78;

  if ($('ov-elec-avg')) {
    $('ov-elec-avg').textContent = elecAvg.toFixed(1) + '¢';
    $('ov-elec-sub').textContent = `EIA monthly avg across ${elecVals.filter(Boolean).length} states`;
  }
  if ($('ov-gas-avg')) {
    $('ov-gas-avg').textContent = '$' + gasAvg.toFixed(2);
    $('ov-gas-sub').textContent = 'EIA citygate avg across monitored states';
  }
  if ($('ov-diesel-avg')) {
    $('ov-diesel-avg').textContent = '$' + usD.toFixed(3);
    $('ov-diesel-sub').textContent = 'EIA weekly US national average';
  }
}

// ============================================================
// TAB SWITCHING
// ============================================================
function switchTab(name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  event.target.classList.add('active');
  $('tab-' + name).classList.add('active');

  if (name === 'news' && DATA.news.length === 0) loadAllNews();
  if (name === 'weather' && CONFIG.OPENWEATHER_KEY && Object.keys(DATA.weather).length === 0) {
    loadWeather(CONFIG.OPENWEATHER_KEY);
  }
  if (name === 'precip') precipInit();
}

// ============================================================
// PRECIPITATION TAB
// ============================================================

const PRECIP_CITIES = {
  AL: [
    { name: 'Auburn',          lat: 32.6099, lon: -85.4808 },
    { name: 'Birmingham',      lat: 33.5186, lon: -86.8104 },
    { name: 'Decatur',         lat: 34.6059, lon: -86.9833 },
    { name: 'Dothan',          lat: 31.2232, lon: -85.3905 },
    { name: 'Florence',        lat: 34.7998, lon: -87.6773 },
    { name: 'Gadsden',         lat: 33.9748, lon: -86.0066 },
    { name: 'Hoover',          lat: 33.4054, lon: -86.8113 },
    { name: 'Huntsville',      lat: 34.7304, lon: -86.5861 },
    { name: 'Madison',         lat: 34.6993, lon: -86.7483 },
    { name: 'Mobile',          lat: 30.6954, lon: -88.0399 },
    { name: 'Montgomery',      lat: 32.3668, lon: -86.2999 },
    { name: 'Phenix City',     lat: 32.4710, lon: -85.0008 },
    { name: 'Prattville',      lat: 32.4640, lon: -86.4597 },
    { name: 'Tuscaloosa',      lat: 33.2098, lon: -87.5692 },
    { name: 'Vestavia Hills',  lat: 33.4520, lon: -86.7947 },
  ],
  CA: [
    { name: 'Anaheim',         lat: 33.8366, lon: -117.9143 },
    { name: 'Antioch',         lat: 37.9966, lon: -121.7958 },
    { name: 'Bakersfield',     lat: 35.3733, lon: -119.0187 },
    { name: 'Berkeley',        lat: 37.8716, lon: -122.2727 },
    { name: 'Chula Vista',     lat: 32.6401, lon: -117.0842 },
    { name: 'Concord',         lat: 37.9779, lon: -122.0311 },
    { name: 'Corona',          lat: 33.8753, lon: -117.5664 },
    { name: 'Elk Grove',       lat: 38.4088, lon: -121.3716 },
    { name: 'Escondido',       lat: 33.1192, lon: -117.0864 },
    { name: 'Fontana',         lat: 34.0922, lon: -117.4350 },
    { name: 'Fresno',          lat: 36.7378, lon: -119.7871 },
    { name: 'Garden Grove',    lat: 33.7739, lon: -117.9415 },
    { name: 'Glendale',        lat: 34.1425, lon: -118.2551 },
    { name: 'Hayward',         lat: 37.6688, lon: -122.0808 },
    { name: 'Huntington Beach',lat: 33.6603, lon: -117.9992 },
    { name: 'Irvine',          lat: 33.6846, lon: -117.8265 },
    { name: 'Lancaster',       lat: 34.6868, lon: -118.1542 },
    { name: 'Long Beach',      lat: 33.7701, lon: -118.1937 },
    { name: 'Los Angeles',     lat: 34.0522, lon: -118.2437 },
    { name: 'Modesto',         lat: 37.6391, lon: -120.9969 },
    { name: 'Moreno Valley',   lat: 33.9425, lon: -117.2297 },
    { name: 'Murrieta',        lat: 33.5539, lon: -117.2139 },
    { name: 'Oakland',         lat: 37.8044, lon: -122.2712 },
    { name: 'Oceanside',       lat: 33.1959, lon: -117.3795 },
    { name: 'Ontario',         lat: 34.0633, lon: -117.6509 },
    { name: 'Oxnard',          lat: 34.1975, lon: -119.1771 },
    { name: 'Palmdale',        lat: 34.5794, lon: -118.1165 },
    { name: 'Pasadena',        lat: 34.1478, lon: -118.1445 },
    { name: 'Pomona',          lat: 34.0551, lon: -117.7500 },
    { name: 'Rancho Cucamonga',lat: 34.1064, lon: -117.5931 },
    { name: 'Richmond',        lat: 37.9358, lon: -122.3477 },
    { name: 'Riverside',       lat: 33.9806, lon: -117.3755 },
    { name: 'Roseville',       lat: 38.7521, lon: -121.2880 },
    { name: 'Sacramento',      lat: 38.5816, lon: -121.4944 },
    { name: 'Salinas',         lat: 36.6777, lon: -121.6555 },
    { name: 'San Bernardino',  lat: 34.1083, lon: -117.2898 },
    { name: 'San Diego',       lat: 32.7157, lon: -117.1611 },
    { name: 'San Francisco',   lat: 37.7749, lon: -122.4194 },
    { name: 'San Jose',        lat: 37.3382, lon: -121.8863 },
    { name: 'Santa Ana',       lat: 33.7455, lon: -117.8677 },
    { name: 'Santa Clara',     lat: 37.3541, lon: -121.9552 },
    { name: 'Santa Clarita',   lat: 34.3917, lon: -118.5426 },
    { name: 'Santa Rosa',      lat: 38.4404, lon: -122.7141 },
    { name: 'Stockton',        lat: 37.9577, lon: -121.2908 },
    { name: 'Sunnyvale',       lat: 37.3688, lon: -122.0363 },
    { name: 'Torrance',        lat: 33.8358, lon: -118.3406 },
    { name: 'Vallejo',         lat: 38.1041, lon: -122.2566 },
    { name: 'Victorville',     lat: 34.5362, lon: -117.2928 },
    { name: 'Visalia',         lat: 36.3302, lon: -119.2921 },
  ],
  FL: [
    { name: 'Boca Raton',      lat: 26.3683, lon: -80.1289 },
    { name: 'Boynton Beach',   lat: 26.5317, lon: -80.0905 },
    { name: 'Cape Coral',      lat: 26.5629, lon: -81.9495 },
    { name: 'Clearwater',      lat: 27.9659, lon: -82.8001 },
    { name: 'Coral Springs',   lat: 26.2709, lon: -80.2706 },
    { name: 'Davie',           lat: 26.0765, lon: -80.2521 },
    { name: 'Daytona Beach',   lat: 29.2108, lon: -81.0228 },
    { name: 'Deltona',         lat: 28.9005, lon: -81.2637 },
    { name: 'Fort Lauderdale', lat: 26.1224, lon: -80.1373 },
    { name: 'Fort Myers',      lat: 26.6406, lon: -81.8723 },
    { name: 'Gainesville',     lat: 29.6516, lon: -82.3248 },
    { name: 'Hialeah',         lat: 25.8576, lon: -80.2781 },
    { name: 'Hollywood',       lat: 26.0112, lon: -80.1495 },
    { name: 'Homestead',       lat: 25.4687, lon: -80.4776 },
    { name: 'Jacksonville',    lat: 30.3322, lon: -81.6557 },
    { name: 'Kissimmee',       lat: 28.2919, lon: -81.4076 },
    { name: 'Lakeland',        lat: 28.0395, lon: -81.9498 },
    { name: 'Largo',           lat: 27.9095, lon: -82.7873 },
    { name: 'Melbourne',       lat: 28.0836, lon: -80.6081 },
    { name: 'Miami',           lat: 25.7617, lon: -80.1918 },
    { name: 'Miami Gardens',   lat: 25.9420, lon: -80.2456 },
    { name: 'Miramar',         lat: 25.9871, lon: -80.3326 },
    { name: 'North Port',      lat: 27.0447, lon: -82.2359 },
    { name: 'Ocala',           lat: 29.1872, lon: -82.1401 },
    { name: 'Orlando',         lat: 28.5383, lon: -81.3792 },
    { name: 'Palm Bay',        lat: 28.0345, lon: -80.5887 },
    { name: 'Palm Coast',      lat: 29.5847, lon: -81.2079 },
    { name: 'Pembroke Pines',  lat: 26.0073, lon: -80.2962 },
    { name: 'Pensacola',       lat: 30.4213, lon: -87.2169 },
    { name: 'Pompano Beach',   lat: 26.2378, lon: -80.1248 },
    { name: 'Port St. Lucie',  lat: 27.2730, lon: -80.3582 },
    { name: 'Sanford',         lat: 28.8006, lon: -81.2731 },
    { name: 'St. Petersburg',  lat: 27.7676, lon: -82.6403 },
    { name: 'Sunrise',         lat: 26.1670, lon: -80.2564 },
    { name: 'Tallahassee',     lat: 30.4383, lon: -84.2807 },
    { name: 'Tampa',           lat: 27.9506, lon: -82.4572 },
    { name: 'West Palm Beach', lat: 26.7153, lon: -80.0534 },
    { name: 'Weston',          lat: 26.1003, lon: -80.3998 },
  ],
  GA: [
    { name: 'Albany',          lat: 31.5785, lon: -84.1557 },
    { name: 'Alpharetta',      lat: 34.0754, lon: -84.2941 },
    { name: 'Athens',          lat: 33.9519, lon: -83.3576 },
    { name: 'Atlanta',         lat: 33.7490, lon: -84.3880 },
    { name: 'Augusta',         lat: 33.4735, lon: -82.0105 },
    { name: 'Brookhaven',      lat: 33.8651, lon: -84.3374 },
    { name: 'Columbus',        lat: 32.4610, lon: -84.9877 },
    { name: 'Dalton',          lat: 34.7698, lon: -84.9702 },
    { name: 'Dunwoody',        lat: 33.9462, lon: -84.3346 },
    { name: 'Gainesville',     lat: 34.2979, lon: -83.8241 },
    { name: 'Johns Creek',     lat: 34.0290, lon: -84.1985 },
    { name: 'Kennesaw',        lat: 34.0234, lon: -84.6155 },
    { name: 'Macon',           lat: 32.8407, lon: -83.6324 },
    { name: 'Marietta',        lat: 33.9526, lon: -84.5499 },
    { name: 'Peachtree City',  lat: 33.3965, lon: -84.5949 },
    { name: 'Rome',            lat: 34.2570, lon: -85.1647 },
    { name: 'Roswell',         lat: 34.0232, lon: -84.3616 },
    { name: 'Sandy Springs',   lat: 33.9304, lon: -84.3733 },
    { name: 'Savannah',        lat: 32.0835, lon: -81.0998 },
    { name: 'Smyrna',          lat: 33.8840, lon: -84.5144 },
    { name: 'South Fulton',    lat: 33.6401, lon: -84.5799 },
    { name: 'Stonecrest',      lat: 33.6884, lon: -84.1341 },
    { name: 'Valdosta',        lat: 30.8327, lon: -83.2785 },
    { name: 'Warner Robins',   lat: 32.6130, lon: -83.5996 },
  ],
  IA: [
    { name: 'Ames',            lat: 42.0347, lon: -93.6200 },
    { name: 'Ankeny',          lat: 41.7317, lon: -93.5977 },
    { name: 'Bettendorf',      lat: 41.5245, lon: -90.4432 },
    { name: 'Cedar Falls',     lat: 42.5349, lon: -92.4453 },
    { name: 'Cedar Rapids',    lat: 41.9779, lon: -91.6656 },
    { name: 'Council Bluffs',  lat: 41.2619, lon: -95.8608 },
    { name: 'Davenport',       lat: 41.5236, lon: -90.5776 },
    { name: 'Des Moines',      lat: 41.5868, lon: -93.6250 },
    { name: 'Dubuque',         lat: 42.5006, lon: -90.6646 },
    { name: 'Iowa City',       lat: 41.6611, lon: -91.5302 },
    { name: 'Marion',          lat: 42.0341, lon: -91.5977 },
    { name: 'Sioux City',      lat: 42.4999, lon: -96.4003 },
    { name: 'Urbandale',       lat: 41.6267, lon: -93.7122 },
    { name: 'Waterloo',        lat: 42.4928, lon: -92.3426 },
    { name: 'West Des Moines', lat: 41.5772, lon: -93.7113 },
  ],
  IL: [
    { name: 'Aurora',          lat: 41.7606, lon: -88.3201 },
    { name: 'Berwyn',          lat: 41.8506, lon: -87.7939 },
    { name: 'Bloomington',     lat: 40.4842, lon: -88.9937 },
    { name: 'Bolingbrook',     lat: 41.6986, lon: -88.0684 },
    { name: 'Champaign',       lat: 40.1164, lon: -88.2434 },
    { name: 'Chicago',         lat: 41.8781, lon: -87.6298 },
    { name: 'Cicero',          lat: 41.8456, lon: -87.7539 },
    { name: 'Decatur',         lat: 39.8403, lon: -88.9548 },
    { name: 'Elgin',           lat: 42.0354, lon: -88.2826 },
    { name: 'Evanston',        lat: 42.0450, lon: -87.6877 },
    { name: 'Joliet',          lat: 41.5250, lon: -88.0817 },
    { name: 'Moline',          lat: 41.5067, lon: -90.5151 },
    { name: 'Mount Prospect',  lat: 42.0664, lon: -87.9373 },
    { name: 'Naperville',      lat: 41.7508, lon: -88.1535 },
    { name: 'Normal',          lat: 40.5142, lon: -88.9906 },
    { name: 'Oak Lawn',        lat: 41.7197, lon: -87.7478 },
    { name: 'Oak Park',        lat: 41.8850, lon: -87.7845 },
    { name: 'Orland Park',     lat: 41.6303, lon: -87.8539 },
    { name: 'Palatine',        lat: 42.1103, lon: -88.0342 },
    { name: 'Peoria',          lat: 40.6936, lon: -89.5890 },
    { name: 'Rockford',        lat: 42.2711, lon: -89.0940 },
    { name: 'Schaumburg',      lat: 42.0334, lon: -88.0834 },
    { name: 'Skokie',          lat: 42.0324, lon: -87.7416 },
    { name: 'Springfield',     lat: 39.7817, lon: -89.6501 },
    { name: 'Tinley Park',     lat: 41.5731, lon: -87.7874 },
    { name: 'Waukegan',        lat: 42.3636, lon: -87.8448 },
    { name: 'Wheaton',         lat: 41.8661, lon: -88.1070 },
  ],
  LA: [
    { name: 'Alexandria',      lat: 31.3113, lon: -92.4451 },
    { name: 'Baton Rouge',     lat: 30.4515, lon: -91.1871 },
    { name: 'Bossier City',    lat: 32.5160, lon: -93.7321 },
    { name: 'Houma',           lat: 29.5958, lon: -90.7195 },
    { name: 'Kenner',          lat: 29.9941, lon: -90.2417 },
    { name: 'Lafayette',       lat: 30.2241, lon: -92.0198 },
    { name: 'Lake Charles',    lat: 30.2266, lon: -93.2174 },
    { name: 'Monroe',          lat: 32.5093, lon: -92.1193 },
    { name: 'New Iberia',      lat: 30.0035, lon: -91.8187 },
    { name: 'New Orleans',     lat: 29.9511, lon: -90.0715 },
    { name: 'Shreveport',      lat: 32.5252, lon: -93.7502 },
  ],
  MA: [
    { name: 'Attleboro',       lat: 41.9445, lon: -71.2856 },
    { name: 'Barnstable',      lat: 41.7003, lon: -70.3002 },
    { name: 'Boston',          lat: 42.3601, lon: -71.0589 },
    { name: 'Brockton',        lat: 42.0834, lon: -71.0184 },
    { name: 'Cambridge',       lat: 42.3736, lon: -71.1097 },
    { name: 'Chicopee',        lat: 42.1487, lon: -72.6079 },
    { name: 'Fall River',      lat: 41.7015, lon: -71.1550 },
    { name: 'Fitchburg',       lat: 42.5834, lon: -71.8023 },
    { name: 'Haverhill',       lat: 42.7762, lon: -71.0773 },
    { name: 'Lawrence',        lat: 42.7070, lon: -71.1631 },
    { name: 'Leominster',      lat: 42.5251, lon: -71.7598 },
    { name: 'Lowell',          lat: 42.6334, lon: -71.3162 },
    { name: 'Lynn',            lat: 42.4668, lon: -70.9495 },
    { name: 'Malden',          lat: 42.4251, lon: -71.0662 },
    { name: 'Medford',         lat: 42.4184, lon: -71.1062 },
    { name: 'Methuen',         lat: 42.7265, lon: -71.1909 },
    { name: 'New Bedford',     lat: 41.6362, lon: -70.9342 },
    { name: 'Newton',          lat: 42.3370, lon: -71.2092 },
    { name: 'Peabody',         lat: 42.5279, lon: -70.9286 },
    { name: 'Pittsfield',      lat: 42.4501, lon: -73.2496 },
    { name: 'Plymouth',        lat: 41.9584, lon: -70.6673 },
    { name: 'Quincy',          lat: 42.2529, lon: -71.0023 },
    { name: 'Revere',          lat: 42.4084, lon: -71.0120 },
    { name: 'Somerville',      lat: 42.3876, lon: -71.0995 },
    { name: 'Springfield',     lat: 42.1015, lon: -72.5898 },
    { name: 'Taunton',         lat: 41.9001, lon: -71.0898 },
    { name: 'Waltham',         lat: 42.3765, lon: -71.2356 },
    { name: 'Weymouth',        lat: 42.2224, lon: -70.9409 },
    { name: 'Worcester',       lat: 42.2626, lon: -71.8023 },
  ],
  MD: [
    { name: 'Annapolis',       lat: 38.9784, lon: -76.4922 },
    { name: 'Baltimore',       lat: 39.2904, lon: -76.6122 },
    { name: 'Bowie',           lat: 38.9420, lon: -76.7791 },
    { name: 'College Park',    lat: 38.9807, lon: -76.9369 },
    { name: 'Columbia',        lat: 39.2037, lon: -76.8610 },
    { name: 'Dundalk',         lat: 39.2709, lon: -76.5302 },
    { name: 'Ellicott City',   lat: 39.2673, lon: -76.7983 },
    { name: 'Frederick',       lat: 39.4143, lon: -77.4105 },
    { name: 'Gaithersburg',    lat: 39.1434, lon: -77.2014 },
    { name: 'Germantown',      lat: 39.1732, lon: -77.2717 },
    { name: 'Glen Burnie',     lat: 39.1626, lon: -76.6249 },
    { name: 'Hagerstown',      lat: 39.6418, lon: -77.7200 },
    { name: 'Rockville',       lat: 39.0840, lon: -77.1528 },
    { name: 'Salisbury',       lat: 38.3607, lon: -75.5994 },
    { name: 'Silver Spring',   lat: 38.9907, lon: -77.0261 },
    { name: 'Waldorf',         lat: 38.6251, lon: -76.8969 },
  ],
  MI: [
    { name: 'Ann Arbor',       lat: 42.2808, lon: -83.7430 },
    { name: 'Battle Creek',    lat: 42.3212, lon: -85.1797 },
    { name: 'Bay City',        lat: 43.5945, lon: -83.8887 },
    { name: 'Dearborn',        lat: 42.3223, lon: -83.1763 },
    { name: 'Dearborn Heights',lat: 42.3370, lon: -83.2744 },
    { name: 'Detroit',         lat: 42.3314, lon: -83.0458 },
    { name: 'East Lansing',    lat: 42.7370, lon: -84.4839 },
    { name: 'Farmington Hills',lat: 42.4989, lon: -83.3677 },
    { name: 'Flint',           lat: 43.0125, lon: -83.6875 },
    { name: 'Grand Rapids',    lat: 42.9634, lon: -85.6681 },
    { name: 'Jackson',         lat: 42.2459, lon: -84.4013 },
    { name: 'Kalamazoo',       lat: 42.2917, lon: -85.5872 },
    { name: 'Kentwood',        lat: 42.8692, lon: -85.6447 },
    { name: 'Lansing',         lat: 42.7325, lon: -84.5555 },
    { name: 'Livonia',         lat: 42.3684, lon: -83.3527 },
    { name: 'Midland',         lat: 43.6156, lon: -84.2472 },
    { name: 'Muskegon',        lat: 43.2342, lon: -86.2484 },
    { name: 'Novi',            lat: 42.4806, lon: -83.4755 },
    { name: 'Pontiac',         lat: 42.6389, lon: -83.2910 },
    { name: 'Rochester Hills', lat: 42.6583, lon: -83.1499 },
    { name: 'Royal Oak',       lat: 42.4895, lon: -83.1446 },
    { name: 'Saginaw',         lat: 43.4195, lon: -83.9508 },
    { name: 'Southfield',      lat: 42.4734, lon: -83.2219 },
    { name: 'St. Clair Shores',lat: 42.4973, lon: -82.8963 },
    { name: 'Sterling Heights',lat: 42.5803, lon: -83.0302 },
    { name: 'Taylor',          lat: 42.2406, lon: -83.2697 },
    { name: 'Troy',            lat: 42.6064, lon: -83.1498 },
    { name: 'Warren',          lat: 42.5145, lon: -83.0146 },
    { name: 'Westland',        lat: 42.3242, lon: -83.4002 },
    { name: 'Wyoming',         lat: 42.9134, lon: -85.7053 },
  ],
  NJ: [
    { name: 'Atlantic City',   lat: 39.3643, lon: -74.4229 },
    { name: 'Bayonne',         lat: 40.6688, lon: -74.1143 },
    { name: 'Brick',           lat: 40.0579, lon: -74.1099 },
    { name: 'Camden',          lat: 39.9259, lon: -75.1196 },
    { name: 'Cherry Hill',     lat: 39.9345, lon: -75.0246 },
    { name: 'Clifton',         lat: 40.8584, lon: -74.1638 },
    { name: 'East Orange',     lat: 40.7673, lon: -74.2049 },
    { name: 'Edison',          lat: 40.5187, lon: -74.4121 },
    { name: 'Elizabeth',       lat: 40.6640, lon: -74.2107 },
    { name: 'Hackensack',      lat: 40.8859, lon: -74.0435 },
    { name: 'Hamilton',        lat: 40.2260, lon: -74.7421 },
    { name: 'Hoboken',         lat: 40.7440, lon: -74.0324 },
    { name: 'Irvington',       lat: 40.7242, lon: -74.2296 },
    { name: 'Jersey City',     lat: 40.7178, lon: -74.0431 },
    { name: 'Lakewood',        lat: 40.0979, lon: -74.2179 },
    { name: 'Linden',          lat: 40.6220, lon: -74.2446 },
    { name: 'Middletown',      lat: 40.3854, lon: -74.1229 },
    { name: 'New Brunswick',   lat: 40.4863, lon: -74.4518 },
    { name: 'Newark',          lat: 40.7357, lon: -74.1724 },
    { name: 'Old Bridge',      lat: 40.4148, lon: -74.2657 },
    { name: 'Parsippany',      lat: 40.8579, lon: -74.4265 },
    { name: 'Passaic',         lat: 40.8568, lon: -74.1284 },
    { name: 'Paterson',        lat: 40.9168, lon: -74.1718 },
    { name: 'Sayreville',      lat: 40.4593, lon: -74.3607 },
    { name: 'Toms River',      lat: 39.9537, lon: -74.1979 },
    { name: 'Trenton',         lat: 40.2171, lon: -74.7429 },
    { name: 'Union City',      lat: 40.7795, lon: -74.0246 },
    { name: 'Vineland',        lat: 39.4865, lon: -74.9974 },
    { name: 'Woodbridge',      lat: 40.5576, lon: -74.2849 },
  ],
  OH: [
    { name: 'Akron',           lat: 41.0814, lon: -81.5190 },
    { name: 'Canton',          lat: 40.7989, lon: -81.3784 },
    { name: 'Cincinnati',      lat: 39.1031, lon: -84.5120 },
    { name: 'Cleveland',       lat: 41.4993, lon: -81.6944 },
    { name: 'Cleveland Heights',lat: 41.5120, lon: -81.5565 },
    { name: 'Columbus',        lat: 39.9612, lon: -82.9988 },
    { name: 'Cuyahoga Falls',  lat: 41.1334, lon: -81.4846 },
    { name: 'Dayton',          lat: 39.7589, lon: -84.1916 },
    { name: 'Elyria',          lat: 41.3681, lon: -82.1074 },
    { name: 'Euclid',          lat: 41.5931, lon: -81.5268 },
    { name: 'Fairfield',       lat: 39.3453, lon: -84.5599 },
    { name: 'Hamilton',        lat: 39.3995, lon: -84.5613 },
    { name: 'Kettering',       lat: 39.6895, lon: -84.1688 },
    { name: 'Lakewood',        lat: 41.4820, lon: -81.7982 },
    { name: 'Lima',            lat: 40.7420, lon: -84.1052 },
    { name: 'Lorain',          lat: 41.4523, lon: -82.1824 },
    { name: 'Mansfield',       lat: 40.7584, lon: -82.5154 },
    { name: 'Mentor',          lat: 41.6661, lon: -81.3395 },
    { name: 'Middletown',      lat: 39.5151, lon: -84.3983 },
    { name: 'Newark',          lat: 40.0581, lon: -82.4013 },
    { name: 'Parma',           lat: 41.3845, lon: -81.7229 },
    { name: 'Springfield',     lat: 39.9242, lon: -83.8088 },
    { name: 'Strongsville',    lat: 41.3145, lon: -81.8360 },
    { name: 'Toledo',          lat: 41.6528, lon: -83.5379 },
    { name: 'Warren',          lat: 41.2376, lon: -80.8184 },
    { name: 'Youngstown',      lat: 41.0998, lon: -80.6495 },
  ],
  TX: [
    { name: 'Abilene',         lat: 32.4487, lon: -99.7331  },
    { name: 'Allen',           lat: 33.1032, lon: -96.6705  },
    { name: 'Amarillo',        lat: 35.2220, lon: -101.8313 },
    { name: 'Arlington',       lat: 32.7357, lon: -97.1081  },
    { name: 'Atascocita',      lat: 29.9988, lon: -95.1761  },
    { name: 'Austin',          lat: 30.2672, lon: -97.7431  },
    { name: 'Baytown',         lat: 29.7355, lon: -94.9774  },
    { name: 'Beaumont',        lat: 30.0860, lon: -94.1018  },
    { name: 'Brownsville',     lat: 25.9017, lon: -97.4975  },
    { name: 'Bryan',           lat: 30.6744, lon: -96.3698  },
    { name: 'Carrollton',      lat: 32.9537, lon: -96.8903  },
    { name: 'Cedar Park',      lat: 30.5052, lon: -97.8203  },
    { name: 'College Station', lat: 30.6280, lon: -96.3344  },
    { name: 'Conroe',          lat: 30.3119, lon: -95.4561  },
    { name: 'Corpus Christi',  lat: 27.8006, lon: -97.3964  },
    { name: 'Dallas',          lat: 32.7767, lon: -96.7970  },
    { name: 'Denton',          lat: 33.2148, lon: -97.1331  },
    { name: 'Edinburg',        lat: 26.3017, lon: -98.1633  },
    { name: 'El Paso',         lat: 31.7619, lon: -106.4850 },
    { name: 'Flower Mound',    lat: 33.0145, lon: -97.0964  },
    { name: 'Fort Worth',      lat: 32.7555, lon: -97.3308  },
    { name: 'Frisco',          lat: 33.1507, lon: -96.8236  },
    { name: 'Garland',         lat: 32.9126, lon: -96.6389  },
    { name: 'Georgetown',      lat: 30.6332, lon: -97.6775  },
    { name: 'Grand Prairie',   lat: 32.7460, lon: -96.9978  },
    { name: 'Harlingen',       lat: 26.1906, lon: -97.6961  },
    { name: 'Houston',         lat: 29.7604, lon: -95.3698  },
    { name: 'Irving',          lat: 32.8140, lon: -96.9489  },
    { name: 'Killeen',         lat: 31.1171, lon: -97.7278  },
    { name: 'Laredo',          lat: 27.5306, lon: -99.4803  },
    { name: 'League City',     lat: 29.5075, lon: -95.0949  },
    { name: 'Leander',         lat: 30.5788, lon: -97.8531  },
    { name: 'Lewisville',      lat: 33.0462, lon: -96.9942  },
    { name: 'Longview',        lat: 32.5007, lon: -94.7405  },
    { name: 'Lubbock',         lat: 33.5779, lon: -101.8552 },
    { name: 'Mansfield',       lat: 32.5632, lon: -97.1417  },
    { name: 'McAllen',         lat: 26.2034, lon: -98.2300  },
    { name: 'McKinney',        lat: 33.1972, lon: -96.6397  },
    { name: 'Mesquite',        lat: 32.7668, lon: -96.5992  },
    { name: 'Midland',         lat: 31.9974, lon: -102.0779 },
    { name: 'Mission',         lat: 26.2159, lon: -98.3252  },
    { name: 'New Braunfels',   lat: 29.7030, lon: -98.1245  },
    { name: 'North Richland Hills', lat: 32.8343, lon: -97.2289 },
    { name: 'Odessa',          lat: 31.8457, lon: -102.3676 },
    { name: 'Pasadena',        lat: 29.6911, lon: -95.2091  },
    { name: 'Pearland',        lat: 29.5635, lon: -95.2860  },
    { name: 'Pflugerville',    lat: 30.4393, lon: -97.6200  },
    { name: 'Pharr',           lat: 26.1948, lon: -98.1836  },
    { name: 'Plano',           lat: 33.0198, lon: -96.6989  },
    { name: 'Richardson',      lat: 32.9483, lon: -96.7299  },
    { name: 'Round Rock',      lat: 30.5083, lon: -97.6789  },
    { name: 'Rowlett',         lat: 32.9029, lon: -96.5638  },
    { name: 'San Antonio',     lat: 29.4241, lon: -98.4936  },
    { name: 'San Angelo',      lat: 31.4638, lon: -100.4370 },
    { name: 'Sugar Land',      lat: 29.6197, lon: -95.6349  },
    { name: 'Temple',          lat: 31.0982, lon: -97.3428  },
    { name: 'Tyler',           lat: 32.3513, lon: -95.3011  },
    { name: 'Waco',            lat: 31.5493, lon: -97.1467  },
    { name: 'Wichita Falls',   lat: 33.9137, lon: -98.4934  },
  ],
};

// Populate state dropdown on tab first open
function precipInit() {
  const stateEl = $('precip-state');
  if (stateEl.options.length > 1) return; // already populated
  STATES.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s.code;
    opt.textContent = s.name;
    stateEl.appendChild(opt);
  });

  // Default dates: last 30 days
  const today = new Date();
  const prior = new Date(today);
  prior.setDate(prior.getDate() - 30);
  $('precip-end').value   = today.toISOString().slice(0,10);
  $('precip-start').value = prior.toISOString().slice(0,10);
}

function precipPopulateCities() {
  const code = $('precip-state').value;
  const cityEl = $('precip-city');
  cityEl.innerHTML = '<option value="">— Select City —</option>';
  cityEl.disabled = !code;
  if (!code) return;
  (PRECIP_CITIES[code] || []).forEach(c => {
    const opt = document.createElement('option');
    opt.value = JSON.stringify({ lat: c.lat, lon: c.lon, name: c.name });
    opt.textContent = c.name;
    cityEl.appendChild(opt);
  });
  cityEl.disabled = false;
}

function precipShowError(msg) {
  const el = $('precip-error');
  el.textContent = msg;
  el.style.display = msg ? 'block' : 'none';
}

// ============================================================
// PRECIPITATION TAB — NOAA GHCND STATION DATA
// ============================================================
const NOAA_TOKEN = 'zcnnxTHZJwjcVsoSaejcpYmOCYArDPqK';
const NOAA_BASE  = 'https://www.ncdc.noaa.gov/cdo-web/api/v2';

// Fetch from NOAA CDO API — token appended as query param (avoids CORS preflight)
async function noaaFetch(path) {
  const sep = path.includes('?') ? '&' : '?';
  const targetUrl = NOAA_BASE + path + sep + 'token=' + NOAA_TOKEN;
  const proxies = [
    `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`,
    `https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}`,
    `https://thingproxy.freeboard.io/fetch/${targetUrl}`,
    `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(targetUrl)}`,
  ];
  let lastErr = '';
  for (const proxyUrl of proxies) {
    try {
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), 12000);
      const res = await fetch(proxyUrl, { signal: controller.signal });
      clearTimeout(timer);
      if (!res.ok) { lastErr = `HTTP ${res.status}`; continue; }
      return await res.json();
    } catch(e) {
      lastErr = e.message;
      continue;
    }
  }
  throw new Error(`NOAA API unreachable via all proxies (${lastErr}). Check your network or try again.`);
}

// Find the nearest GHCND station that has PRCP data for the requested date range
async function findNOAAStation(lat, lon, startDate, endDate) {
  const radii = [0.3, 0.6, 1.0, 1.5];
  for (const r of radii) {
    const extent = `${(lat-r).toFixed(4)},${(lon-r).toFixed(4)},${(lat+r).toFixed(4)},${(lon+r).toFixed(4)}`;
    const path = `/stations?datasetid=GHCND&datatypeid=PRCP&extent=${extent}&startdate=${startDate}&enddate=${endDate}&limit=10&sortfield=datacoverage&sortorder=desc`;
    try {
      const json = await noaaFetch(path);
      if (json.results && json.results.length > 0) {
        // Pick the station with highest datacoverage
        return json.results[0];
      }
    } catch(e) { throw e; }
  }
  throw new Error('No NOAA weather station found near this location for the selected date range. Try a nearby larger city.');
}

async function runPrecipQuery() {
  precipShowError('');
  const stateEl  = $('precip-state');
  const cityEl   = $('precip-city');
  const startVal = $('precip-start').value;
  const endVal   = $('precip-end').value;
  const results  = $('precip-results');

  // Validate inputs
  if (!stateEl.value)   return precipShowError('⚠ Please select a state.');
  if (!cityEl.value)    return precipShowError('⚠ Please select a city.');
  if (!startVal)        return precipShowError('⚠ Please enter a start date.');
  if (!endVal)          return precipShowError('⚠ Please enter an end date.');

  const start = new Date(startVal);
  const end   = new Date(endVal);
  if (end < start)      return precipShowError('⚠ End date must be on or after start date.');

  const dayDiff = Math.round((end - start) / 86400000) + 1;
  if (dayDiff > 366)    return precipShowError(`⚠ Date range is ${dayDiff} days — maximum is 366 days.`);

  const city      = JSON.parse(cityEl.value);
  const stateName = STATES.find(s => s.code === stateEl.value)?.name || stateEl.value;

  try {
    // Step 1 — find nearest station
    results.innerHTML = '<div class="loading"><div class="spinner"></div>LOCATING NEAREST NOAA STATION...</div>';
    const station = await findNOAAStation(city.lat, city.lon, startVal, endVal);
    const stationName = station.name || station.id;

    // Step 2 — fetch daily PRCP + SNOW data
    // GHCND units (no units param): PRCP = tenths of mm, SNOW = mm
    results.innerHTML = `<div class="loading"><div class="spinner"></div>FETCHING DATA FROM ${stationName}...</div>`;
    const dataPath = `/data?datasetid=GHCND&stationid=${encodeURIComponent(station.id)}&datatypeid=PRCP,SNOW&startdate=${startVal}&enddate=${endVal}&limit=1000&includemetadata=false`;
    const dataJson = await noaaFetch(dataPath);

    // Step 3 — pivot records into per-date map
    // NOAA returns sparse records (missing days = no entry = 0 precip)
    const byDate = {};
    (dataJson.results || []).forEach(r => {
      const date = r.date.slice(0, 10);
      if (!byDate[date]) byDate[date] = { PRCP: 0, SNOW: 0 };
      byDate[date][r.datatype] = r.value || 0;
    });

    // Step 4 — build complete date array (fill gaps with 0)
    const dates = [];
    const cur = new Date(startVal + 'T12:00:00'); // noon to avoid DST edge cases
    const endD = new Date(endVal   + 'T12:00:00');
    while (cur <= endD) {
      dates.push(cur.toISOString().slice(0, 10));
      cur.setDate(cur.getDate() + 1);
    }

    // Step 5 — convert and build rows
    // PRCP (tenths of mm) ÷ 254 = inches of liquid precipitation (rain + snow water equiv)
    // SNOW (mm) ÷ 25.4 = inches of snowfall depth
    // Rainfall = total liquid precip minus estimated snow water equiv (10:1 ratio)
    let totalRain = 0, totalSnow = 0, totalPrecip = 0;
    let rows = '';
    let daysWithData = 0;

    dates.forEach(d => {
      const rec      = byDate[d] || { PRCP: 0, SNOW: 0 };
      const totalIn  = rec.PRCP / 254;                    // total liquid equiv in inches
      const snowIn   = rec.SNOW / 25.4;                   // snowfall depth in inches
      const snowWaterIn = snowIn / 10;                    // snow water equiv (10:1 ratio)
      const rainIn   = Math.max(0, totalIn - snowWaterIn);// liquid rain only

      if (rec.PRCP > 0 || rec.SNOW > 0) daysWithData++;
      totalRain   += rainIn;
      totalSnow   += snowIn;
      totalPrecip += totalIn;

      const fmt      = v => v === 0 ? '<span class="precip-zero">0.000</span>' : v.toFixed(3);
      const rainCls  = rainIn  > 0 ? 'precip-rain'  : '';
      const snowCls  = snowIn  > 0 ? 'precip-snow'  : '';
      const totalCls = totalIn > 0 ? 'precip-total' : 'precip-zero';
      const [yr, mo, dy] = d.split('-');

      rows += `<tr>
        <td>${stateName}</td>
        <td>${city.name}</td>
        <td>${mo}/${dy}/${yr}</td>
        <td class="${rainCls}">${fmt(rainIn)}</td>
        <td class="${snowCls}">${fmt(snowIn)}</td>
        <td class="${totalCls}">${fmt(totalIn)}</td>
      </tr>`;
    });

    // Warn if very few days have data (station may be sparse for this range)
    let sparseWarning = '';
    if (daysWithData === 0) {
      sparseWarning = `<div style="font-family:'Share Tech Mono','Courier New',monospace;font-size:11px;
        color:#f59e0b;padding:10px 14px;border:1px solid #b45309;background:rgba(245,158,11,0.07);margin-bottom:12px;">
        ⚠ NO DATA RETURNED for this station and date range. The station may not have reported during this period.
        Try selecting a different nearby city.
      </div>`;
    } else if (daysWithData < dates.length * 0.5) {
      sparseWarning = `<div style="font-family:'Share Tech Mono','Courier New',monospace;font-size:11px;
        color:#f59e0b;padding:10px 14px;border:1px solid #b45309;background:rgba(245,158,11,0.07);margin-bottom:12px;">
        ⚠ SPARSE DATA — Only ${daysWithData} of ${dates.length} days have station records.
        Missing days are shown as 0.000. Consider trying a nearby city if results appear incomplete.
      </div>`;
    }

    results.innerHTML = `
      ${sparseWarning}
      <div class="precip-table-wrap">
        <table class="precip-table">
          <thead>
            <tr>
              <th>State</th>
              <th>City</th>
              <th>Date</th>
              <th>Rainfall (in)</th>
              <th>Snowfall (in)</th>
              <th>Total Precip (in)</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
          <tfoot>
            <tr class="totals-row">
              <td colspan="3" style="text-align:right;letter-spacing:2px;">TOTALS</td>
              <td>${totalRain.toFixed(3)}"</td>
              <td>${totalSnow.toFixed(3)}"</td>
              <td>${totalPrecip.toFixed(3)}"</td>
            </tr>
          </tfoot>
        </table>
      </div>
      <div style="font-family:'Share Tech Mono','Courier New',monospace;font-size:11px;color:#6b8aaa;letter-spacing:1px;margin-top:6px;">
        ${dates.length} days · ${stateName} / ${city.name} · ${startVal} to ${endVal}
        · Station: ${stationName} (${station.id})
        · Source: NOAA GHCND — actual gauge observations
      </div>
    `;

  } catch(e) {
    results.innerHTML = '';
    if (e.name === 'AbortError') {
      precipShowError('⚠ Request timed out. Please try again.');
    } else {
      precipShowError(`⚠ ${e.message}`);
    }
  }
}

async function init() {
  await Promise.allSettled([
    loadElectricityData(),
    loadGasData(),
    loadDieselData(),
    loadGridData(),
  ]);

  // Update status pills based on actual data
  const eiaOk = Object.keys(DATA.electricity).length > 0;
  updateStatusPill('pill-eia', eiaOk, `EIA DATA: ${eiaOk ? 'CONNECTED' : 'ESTIMATES'}`);
  const gridOk = Object.values(GRID_DATA).some(d => !d.simulated);
  updateStatusPill('pill-grid', gridOk, `GRID DATA: ${gridOk ? 'LIVE' : 'ESTIMATED'}`);

  setLastUpdated();
  try { renderCharts(); } catch(e) { console.error('renderCharts error:', e); }
  try { buildEnergyTable(); } catch(e) { console.error('buildEnergyTable error:', e); }
  try { buildDieselTable(); } catch(e) { console.error('buildDieselTable error:', e); }
  try { buildGridCards('overview-grid-cards'); } catch(e) { console.error('buildGridCards error:', e); }

  // Weather — key is baked in
  if (CONFIG.OPENWEATHER_KEY) {
    updateStatusPill('pill-weather', null, 'WEATHER: LOADING...');
    loadWeather(CONFIG.OPENWEATHER_KEY).then(() => {
      updateStatusPill('pill-weather', true, 'WEATHER: LIVE');
    }).catch(() => {
      updateStatusPill('pill-weather', false, 'WEATHER: ERROR');
    });
  }

  // News — runs both feeds in parallel
  loadAllNews().then(() => {
    updateStatusPill('pill-news', DATA.news.length > 0, `NEWS: ${DATA.news.length > 0 ? 'LIVE' : 'SAMPLE'}`);
  });
}

async function refreshAll() {
  DATA.electricity = {};
  DATA.gas = {};
  DATA.diesel = {};
  await init();
}

init();
</script>

</body>
</html>